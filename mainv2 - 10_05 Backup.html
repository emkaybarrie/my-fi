<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 1</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var ratio = Math.max(window.innerWidth / window.innerHeight, window.innerHeight / window.innerWidth)
    var DEFAULT_HEIGHT = 272  // any height you want
    var DEFAULT_WIDTH = ratio * DEFAULT_HEIGHT// * 2

    var config = {
        type: Phaser.AUTO,

        scale: {

            parent: 'mygame',
            mode: Phaser.Scale.FIT,
            width:  DEFAULT_WIDTH, //592, //window.innerWidth * window.devicePixelRatio
            height: DEFAULT_HEIGHT //272, //window.innerHeight * window.devicePixelRatio
        },
        
        physics:{
            default:'arcade',
            arcade:{
                gravity:{x: 0, y:350},
                debug: 0,
                overlapBias: 20
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);
    var gameOver = false

    

    var width = game.config.width
    var height = game.config.height

    var section 
 
    var startPosition 
    var playerPosition 
    var enemyPosition

    var enemyGroup
 
    var playerSpeed 
    var slowMo                                          
    var deathBlows = false
    var parry = false

    var currentEnergy = 50
    var currentEnergyText
    var maxEnergy = 100
    var focus = 50
    var income = 100
    var budget = 60
    var energyRegen = income - budget
    var power
    var budgetRatio = budget/income
    var budgetAccuracy = 0.9
    var chaosMultiplierMin = 0.7
    var chaosMultiplierMax = 2.5
    var maxLife = maxEnergy * 3
    var currentLife = maxLife
    var currentLifeText

    var power
   

    function grabbed(){
        player.setTint(0xe06666)
        if (currentLife / maxLife > 0.45){
            currentEnergy *= 0.9
            currentLife *= 0.95
            focus *= 0.3
            player.body.maxVelocity.x -= Phaser.Math.Between(10, 1)

            player.setVelocity(Math.max(15,player.body.velocity.x - 20))
            enemy.setVelocityX(Phaser.Math.Between(-50, -5))
            player.setVelocityX(Phaser.Math.Between(-25, 5))
            } else {
        
        

        
             deathBlows = true
        
        }
    }

    // 38 seconds = 1 year
    // 3.16 seconds = 1 month
    // 4.375 second per week

    function runCycleFunctions()
    {
       if (deathBlows == false && gameOver == false){
        var totalEnergy = currentEnergy + energyRegen
        currentEnergy = Phaser.Math.MaxAdd(currentEnergy, energyRegen,maxEnergy) 
        focus += totalEnergy - currentEnergy
        player.body.maxVelocity.x += focus / maxEnergy   
        player.setVelocity(player.body.velocity.x + (player.body.maxVelocity.x  * budgetRatio * power)) 
        maxEnergy *= 1 - (0.04 / 12)
        if(enemyPosition > width * 2.2){
            enemy.setVelocity(Math.abs(enemy.body.velocity.x) + Phaser.Math.Between(-50, -10))
        }  else {
            enemy.setVelocity(Math.abs(enemy.body.velocity.x) + (enemy.body.maxVelocity.x  * (Phaser.Math.Between(chaosMultiplierMin, chaosMultiplierMax) - 1 ))) 
        }
        
        
    }
}

    function runCycle2Functions()
    {
        // spawn('doomsayer');
    }

    

    


    function preload ()
    {
        this.load.image('dawnl1', 'assets/dawn1.png');
        this.load.image('dawnl2', 'assets/dawn2.png');
        this.load.image('dawnl3', 'assets/dawn3.png');
        this.load.image('dawnl4', 'assets/dawn4.png');
        this.load.image('dawnl5', 'assets/dawn5.png');
        this.load.image('dawnl6', 'assets/dawn6.png');
        this.load.image('dawnl7', 'assets/dawn7.png');
        this.load.image('dawnl8', 'assets/dawn8.png');
        this.load.image('woodsl1', 'assets/woods1.png');
        this.load.image('woodsl2', 'assets/woods2.png');
        this.load.image('woodsl3', 'assets/woods3.png');
        this.load.image('woodsl4', 'assets/woods4.png');
        this.load.image('ground', 'assets/woodground.png');
        this.load.atlas('logan', 'assets/loganv2.png','assets/loganspritesv2.json');
        this.load.atlas('doomsayer', 'assets/doomsayer.png','assets/doomsayersprites.json');
        this.load.atlas('heroF', 'assets/heroF.png','assets/heroF.json');
        this.load.atlas('heroM', 'assets/heroM.png','assets/heroM.json');
  

    }

    function create ()
    {

        

        startPosition = width * 1.5

        this.physics.world.setBounds(0, 0, width * 3,  height);
        
        this.woodsl1 = this.add.tileSprite(0,0, width * 3, height, 'woodsl1').setOrigin(0,0).setScrollFactor(0)
        this.woodsl2 = this.add.tileSprite(0,0, width * 3, height, 'woodsl2').setOrigin(0,0).setScrollFactor(0.25)
        this.woodsl3 = this.add.tileSprite(0,0, width * 3, height, 'woodsl3').setOrigin(0,0).setScrollFactor(0.5)
        this.woodsl4 = this.add.tileSprite(0,0, width * 3, height, 'woodsl4').setOrigin(0,0).setScrollFactor(1).setDepth(1)
        
       
        platforms = this.physics.add.staticGroup();
        platforms.create(0, height - 50, 'ground').setOrigin(0,0).setScale(width * 3 /400).refreshBody().setVisible(0);

        spawn = (enemyName) => {
            enemy = this.physics.add.sprite(width + 100, height - 85, enemyName).setScale(1.75);
            enemy.setDepth(0)
            enemy.flipX = true
            enemy.body.maxVelocity.x = 50
            enemy.setBounceY(0.15);
            enemy.setCollideWorldBounds(true)
            this.physics.add.collider(enemy, player, grabbed);
            this.physics.add.collider(player,enemy);
            this.physics.add.collider(platforms,enemy);
            enemy.anims.play({key:'eRun',frameRate: 10},true);
            enemy.body.setAllowDrag(true)
            
            enemy.setVelocity(Math.abs(player.body.velocity.x) + (player.body.maxVelocity.x  * (Phaser.Math.Between(chaosMultiplierMin, chaosMultiplierMax) - 1 ))) 
        }

        player = this.physics.add.sprite(startPosition + 25, height - 90 ,'heroF').setScale(2.5);


        camera = this.cameras.main.startFollow(player)
        camera.setBounds(0, 0, width * 2.9, height)
        
        player.body.maxVelocity.x = 30
        player.body.setSize(20, 30).setOffset(15,15).setAllowDrag(true)
        player.setBounceY(0.15);
        player.setCollideWorldBounds(true);
        player.setVelocityX(player.body.maxVelocity.x * (currentEnergy / maxEnergy))

        spawn('doomsayer');
        
        this.physics.add.collider(player,platforms);
        
        currentEnergyText = this.add.text(width, 32, 'Energy: ' + maxEnergy, {fontSize: '16px', fill: '#93c47d' }).setDepth(1);
        currentLifeText = this.add.text(width * 2, 16, 'Life: ' + maxLife, {fontSize: '16px', fill: '#cc4125' }).setDepth(1);
        currentFocusText = this.add.text(width * 3, 48, 'Focus: ' + maxLife, {fontSize: '16px', fill: '#ffffff' }).setDepth(1);

        speedText = this.add.text(width * 3, 16, 'Danger Level: ' + maxLife, {fontSize: '16px', fill: '#ffffff' }).setDepth(1);

        cycle1Timer = this.time.addEvent({delay: 3160, callback: runCycleFunctions, args: [], callbackScope: this, loop: true});
        cycle2Timer = this.time.addEvent({delay: 38000, callback: runCycle2Functions, args: [], callbackScope: this, loop: true});

        this.anims.create({
            key: 'pIdle',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Idle_', start: 1, end: 6, suffix: '.png'}),
            frameRate: 6,
            repeat: -1
        });

       

        this.anims.create({
            key: 'pDeath',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Death_', start: 1, end: 11, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });

       

        this.anims.create({
            key: 'pHurt',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_hurt_', start: 1, end: 4, suffix: '.png'}),
            frameRate: 4,
            repeat: 0
        });

        this.anims.create({
            key: 'pSlide',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior-Slide_', start: 1, end: 5, suffix: '.png'}),
            frameRate: 14,
            repeat: 0
        });

        this.anims.create({
            key: 'pJump',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Jump_', start: 1, end: 3, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });

        this.anims.create({
            key: 'pUptoFall',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_UptoFall_', start: 1, end: 2, suffix: '.png'}),
            frameRate: 10,
            repeat: 0
        });


       

        this.anims.create({
            key: 'pRun',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Run_', start: 1, end: 8, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pDash',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash_', start: 1, end: 7, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        // this.anims.create({
        //     key: 'p2Hurt',
        //     frames: this.anims.generateFrameNames('heroM',{prefix: 'adventurer-die-0', start: 0, end: 2, suffix: '.png'}),
        //     frameRate: 3,
        //     repeat: 0
        // });

        //  this.anims.create({
        //     key: 'p2Death',
        //     frames: this.anims.generateFrameNames('heroM',{prefix: 'adventurer-die-0', start: 0, end: 6, suffix: '.png'}),
        //     frameRate: 12,
        //     repeat: 0
        // });

        //   this.anims.create({
        //     key: 'p2Idle',
        //     frames: this.anims.generateFrameNames('heroM',{prefix: 'adventurer-idle-2-0', start: 0, end: 3, suffix: '.png'}),
        //     frameRate: 3,
        //     repeat: -1
        // });



        this.anims.create({
            key: 'p2Run',
            frames: this.anims.generateFrameNames('heroM',{prefix: 'adventurer-run3-0', start: 0, end: 5, suffix: '.png'}),
            frameRate: 12,
            repeat: -1
        });

        this.anims.create({
            key: 'p2Jump',
            frames: this.anims.generateFrameNames('heroM',{prefix: 'adventurer-jump-0', start: 0, end: 3, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });

    

       

        this.anims.create({
            key: 'eIdle',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'idle', start: 1, end: 8}),
            frameRate: 10,
            repeat: -1
        });

       
        this.anims.create({
            key: 'eRun',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'walk', start: 1, end: 8}),
            frameRate: 10,
            repeat: 0
        });


        this.anims.create({
            key: 'eAttack',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'attack', start: 1, end: 10}),
            frameRate: 10,
            repeat: 2,
            repeatDelay: 1000,
            delay: 500
            
        });

        // this.anims.create({
        //     key: 'eHurt',
        //     frames: this.anims.generateFrameNames('doomsayer',{prefix: 'hurt', start: 1, end: 3}),
        //     frameRate: 10,
        //     repeat: 0
        // });

        // this.anims.create({
        //     key: 'eDeath',
        //     frames: this.anims.generateFrameNames('doomsayer',{prefix: 'hurt', start: 1, end: 10}),
        //     frameRate: 10,
        //     repeat: 0
        // });

        
      

        // Controllers online
        cursors = this.input.keyboard.createCursorKeys();

        //game.time.slowMotion = 1



    }

    function update ()
    {

        // enemy constantly eating a random amount of player energy (or at set intervals)
        // Income - budget = energy regen
        // As time passes, energy regen decreases by 4% (inflation) + x% (diffuclty ramp) per interval, and more enemies of higher chaos multipliers appear)
        // Enemy can sprint, rep unexpected cost, accelratin up to player (higher accelration = larger unexpected cost)  
        // Player can expend further energy to accelerate, and while sprinting cuts enemy accelration

        player.setTint()
        
        console.log(section)
        //console.log(Math.round(playerPosition))
        //console.log(Math.round(player.body.velocity.x))
        //console.log(Math.round(player.body.maxVelocity.x))          
        console.log(Math.round(enemy.body.velocity.x))
        console.log(Math.round(enemy.body.acceleration.x))
        

        currentEnergyText.setText('Energy: ' + Phaser.Math.RoundTo(currentEnergy,0) + ' / ' + Phaser.Math.RoundTo(maxEnergy,0));
        currentLifeText.setText('Life: ' + Phaser.Math.RoundTo(currentLife,0) + ' / ' + maxLife);
        currentFocusText.setText('Focus: ' + Phaser.Math.RoundTo(focus,0));

        currentEnergyText.x =  camera.worldView.x + 25  
        currentLifeText.x = camera.worldView.x + 25 
        currentFocusText.x = camera.worldView.x + 25 
        
        playerPosition = player.body.position.x
        enemyPosition = enemy.body.position.x

        section = Math.round((playerPosition + (width / 2)) / width) 
        power = currentEnergy/maxEnergy

        if (slowMo == true){
                playerSpeed = 0.5 + (playerPosition / (width * 3)) * 0.25
            } else  if (deathBlows == true){
                playerSpeed = 0
            } else {
                playerSpeed = 0.5 + (playerPosition / (width * 3))
        
        }
        
        this.woodsl2.tilePositionX += 1.5 * (playerSpeed)
        this.woodsl3.tilePositionX += 3 * (playerSpeed)
        this.woodsl4.tilePositionX += 6 * (playerSpeed) 
        

        // v2 Player runs on spot, with variance (accel -5 - 5), whilst in centre screen, with slight forward push (accel -1 - 5), and strong drag in front screen (accel -25 - -5).  Magnitude increases as player moves up from centre line of screen

        // Player uses energy (auto via budget) to set velocity and coast on momentum, and to avoid incoming obstacles (budget/some stat determines auto slowMo/dodge)

        // Enemies spawn and charge at intervals relating to a [month]

        // var running = true

        // if (running){
        //     // Functions to run when player is running

        //     // Listener events, when action button pressed

        //     // Jumping

        //     if (cursors.up.isDown && player.body.touching.down){
               
        //         player.anims.play({key:'p2Jump',frameRate: 4}, true);
                
        //         player.setVelocityY(player.body.velocity.y - 6)
        //         player.setVelocityX(player.body.velocity.x + 3)
        //     // Sprinting
        //     } else if (cursors.right.isDown){
        //         player.anims.play({key:'p2Run',frameRate: 10},true);
        //     // Sliding
        //     } else if (cursors.down.isDown){

        //     }   else if (cursors.left.isDown) {

        //     }  else if (cursors.space.isDown){

        //     } else if (player.body.touching.down) {
        //        player.anims.play({key:'p2Run',frameRate: 10},true); 
        //     } else {
        //         // Falling
        //     }             
        // }


        if (slowMo == false && deathBlows ==false){

            if (section >= 3){
                player.setAccelerationX(-50 * ((playerPosition - (width * 0.5))/width * 2.5))
                if (player.body.touching.down){
                    player.anims.play({key:'pRun',frameRate: 18},true);
                }
                
                enemy.anims.play({key:'eRun',frameRate: 14},true);
            } else if (section == 2) {
                player.setAccelerationX(Phaser.Math.Between(-5,6) * ((playerPosition - (width * 0.5))/width * 2.5))
                if (player.body.touching.down){
                player.anims.play('pRun',true);
            }
                enemy.anims.play({key:'eRun',frameRate: 12},true);
            } else {
                player.setAccelerationX(0)
                if (player.body.touching.down){
                player.anims.play({key:'pRun',frameRate: 10},true);
            }
                enemy.anims.play({key:'eRun',frameRate: 10},true);
            
            }

        }

        if (cursors.up.isDown && currentEnergy > 35 && deathBlows == false){
            camera.zoomTo(1.25, 2000);
            slowMo = true
            player.flipX = false
            currentEnergy -=  income * (16 / 2500)

            //player.anims.play({key:'pJump',frameRate: 4},true);
            player.chain([ {key:'pJump',frameRate: 4},true, {key:'pUptoFall',frameRate: 4},true]);
            player.setVelocityY(player.body.velocity.y - 7)  
            player.setAccelerationX(-10)
            enemy.setVelocityX(enemy.body.velocity.x - 2)
            enemy.setAccelerationX(0)

            enemy.anims.play({key:'eRun',frameRate: 4},true);

        } else 
        if (cursors.down.isDown && currentEnergy > 15 && deathBlows == false){
            camera.zoomTo(1.5, 1500);
            slowMo = true
            player.flipX = false
            currentEnergy -=  income * (8 / 2500)

            player.setAccelerationX(-5)
            enemy.setVelocityX(enemy.body.velocity.x - 2)
            enemy.setAccelerationX(0)

            player.anims.play({key:'pSlide',frameRate: 4});
            enemy.anims.play({key:'eRun',frameRate: 4},true);
        } else

        if (cursors.space.isDown && focus > 0 && deathBlows == false)
        {

            //camera.pan(player.x, player.y, 2000, 'Power2');
            
            
            focus -=  income * (16 / 2500)
            currentEnergy -=  income * (2 / 2500)
            slowMo = true
            player.flipX = false
            player.x += 1
            player.setVelocityX(50)
            enemy.setVelocityX(enemy.body.velocity.x - 1)
            enemy.setAccelerationX(0)

            //player.chain([{key:'pRun',frameRate: 4, repeat: 0}, {key:'pDash',frameRate: 4}]);
            player.anims.play({key:'pDash',frameRate: 4},true);
            enemy.anims.play({key:'eRun',frameRate: 4},true);
    

        } else if (deathBlows == true && gameOver == false){  


            player.anims.play('pIdle',true);
            player.flipX = true
            player.setAccelerationX(0)
            player.setVelocityX(0)
            enemy.setVelocity(0) 
            enemy.setAccelerationX(0)

            enemy.disableBody()
            enemy.anims.play('eAttack', true);

            if (enemy.anims.currentFrame.index >= 4 && enemy.anims.currentFrame.index < 6 && cursors.space.isDown){
                player.setTint(0x93c47d)
                parry = true
                currentEnergy += Math.min(maxEnergy - currentEnergy, maxEnergy * 0.5)
            } else if ((enemy.anims.currentFrame.index < 4 || enemy.anims.currentFrame.index >= 5) && cursors.space.isDown){
                parry = false
                //currentEnergy -= Math.min(currentEnergy,maxEnergy * 0.06) 
            }

            if (enemy.anims.currentFrame.index == 5 && parry == false){
               currentEnergy -= Math.min(currentEnergy,maxEnergy * 0.16) 
               currentLife -= maxLife * (1/9)
               
               
                   if (currentLife > 0){
                
                    currentEnergy -= Math.min(currentEnergy,maxEnergy * 0.16)   
                    player.setTint(0xcc4125)
                    } else {

                    player.setTint(0xe06666)
                    player.anims.play('pDeath',true)
                    player.disableBody(false,false)

                    enemy.anims.play('eIdle', true)
                    gameOver = true 
                    }
                    
            }  else if (enemy.anims.currentFrame.index >= 5  && enemy.anims.currentFrame.index <= 8 && parry == false) {

                player.anims.play('pHurt',true)
                
            } else if (enemy.anims.currentFrame.index >= 9) {
                player.setTint()
                parry = false
                if (currentEnergy / maxEnergy > 0.3) {
                    deathBlows = false
                    player.flipX = false
                    enemy.enableBody()
                    player.setAccelerationX(0)
                    player.setVelocityX(25)
                    enemy.setVelocity(-100) 
                    enemy.setAccelerationX(0)

                } 
            }

        } else if (gameOver == false) {
                
            slowMo = false
            camera.zoomTo(1, 250);
        }
                
    }


</script>

</body>
</html>