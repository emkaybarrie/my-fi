<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>myFi - The Badlands</title>
    <!-- <preference name="Orientation" value="landscape" /> -->
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            
        }
    </style>
</head>
<body>

<script type="text/javascript">

    // Feature MVP To do:

    // 2) Add Focus Special 2 move (left/right + B button) - offensive focus move
    // 3) Carry out code clean up - condense into functions
    // 4) Add MVP linking of Kraken wallet
    // 5) Add dedicated touch controls - rpelacing current set up piggybacking keyboard controls
    // 6) Add title screen and v1 game testing & balancing

    var ratio = Math.max((window.innerWidth * window.devicePixelRatio)/ (window.innerHeight * window.devicePixelRatio), (window.innerHeight * window.devicePixelRatio) / (window.innerWidth * window.devicePixelRatio)) 
    var DEFAULT_HEIGHT = 272 //window.innerHeight * window.devicePixelRatio // 272
    var DEFAULT_WIDTH =  592 //ratio * DEFAULT_HEIGHT// * 2


    var config = {
        type: Phaser.AUTO,
        pixelArt: 0,
        scale: {

            parent: 'mygame',
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width:  DEFAULT_WIDTH, //592, //window.innerWidth * window.devicePixelRatio
            height: DEFAULT_HEIGHT //272, //window.innerHeight * window.devicePixelRatio
            //resolution: window.devicePixelRatio || 1
        },
        input: {
            keyboard: true,
            gamepad: true
        },
        physics:{
            default:'arcade',
            arcade:{
                gravity:{x: 0, y:600},
                debug: 0,
                overlapBias: 20
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        
    };

    // System & Game Settings
    var game = new Phaser.Game(config);
    var width = game.config.width
    var height = game.config.height

    var gameOver = false
    var gameRestart = false

    var glory = 0
    var gold = 0
    var highScore = parseInt(localStorage.getItem('highScore')) || 0;

    var gameMode = 0
    var inBattle = 0

    // Controls
    var touchEnabled
    var gamePad 
    var gamePadEnabled = false

    var leftIsDown
    var rightIsDown
    var upIsDown
    var downIsDown
  
    

    // Travel & Battle Mode

    var regenActive = true
    var playerIsHit = false
    var level = 0
    var exp = 0 // to be renamed
    var expToLevelUp = Phaser.Math.Between(25,50)
    

    // Travel Mode

    var playerFocusing = false
    var focusModeActive = false
    var scanningForDanger = true
    var playerSpeed

        //NightBorne
        var startNecroFloat = true
        var nightBorneCam = true

    // Battle Mode

        // Player
        var playerLockedOn
        var controlsEnabled = false
        var playerBlocking = false
        var playerDodging = false
        var playerJumping = false
        var playerCrouching = false

        var playerAttacking = false 
        var attackModeActive = false
        var usingPower = false
        var supportProc = 100
        var supportArrowSpeedMultiplier = 1

        var playerLanded = true
        var playerStance = -1

        // Enemies
        var enemies
        var chaosFactor = 1.0
        var chaosMultiplierMin = 0.7
        var chaosMultiplierMax = 2.5

        // NightBorne
      
        var nightBorneIsHit = false
        var nightBorneLife = (income * 0.8) 
        var nightBorneMaxLife = (income * 0.8) 

    // Character Management & Stats

        // Financial Data
        var income = 100
            //TBC
        var lifeRegenAllocation = 0.0 
        var focusRegenAllocation = 0.3 // a) self -report budget driven (i.e. how much do you save/invest a month) b) queried - eventually determined by funds in specific location (myFi designated/directed savings/funds)
        var energyRegenAllocation = 0.7  // a) self-report buidget driven b) delta of non-saved/invested income

        // Game Stats
        
        var lifeRegen = lifeRegenAllocation * income // Calc TBD - Buy-in to myFi stable/pension/emergency fund provides buff to regen - lock tokens/stables and earn 1 - x% 'regen' i.e return
        var focusRegen = focusRegenAllocation * income
        var energyRegen = 0// energyRegenAllocation * income 
        var lifeMultiplier = 3

        var maxLife = income * lifeMultiplier
        var startLife = maxLife
        var currentLife = maxLife

        var maxEnergy = income
        var currentEnergy = maxEnergy

        var startMaxEnergy = 100
        var currentFocus = 200
        var maxFocus = maxEnergy * 3

        var damage = 0
        var baseDamageMultiplier = 1


    // TBC

    var skillTreeOpen = false
    var storingBuffTier = 0
    var spendingBuffTier = 0
    var growingBuffTier = 0
    var kianovaBuffTier = 0

    function reset(){


    // System & Game Settings
    game = new Phaser.Game(config);
    width = game.config.width
    height = game.config.height

    gameOver = false
    gameRestart = false

    glory = 0
    gold = 0
    highScore = parseInt(localStorage.getItem('highScore')) || 0;

    gameMode = 0
    inBattle = 0

    // Controls
    touchEnabled
    gamePad 
    gamePadEnabled = false
  
    // Travel & Battle Mode

    regenActive = true
    playerIsHit = false
    level = 0
    exp = 0 // to be renamed
    expToLevelUp = Phaser.Math.Between(25,50)
    

    // Travel Mode

    playerFocusing = false
    focusModeActive = false
    scanningForDanger = true
    playerSpeed

        //NightBorne
        startNecroFloat = true
        nightBorneCam = true

    // Battle Mode

        // Player
        playerLockedOn
        controlsEnabled = false
        playerBlocking = false
        playerDodging = false
        playerJumping = false
        playerCrouching = false

        playerAttacking = false 
        attackModeActive = false
        usingPower = false
        supportProc = 100
        supportArrowSpeedMultiplier = 1

        playerLanded = true
        playerStance = -1

        // Enemies

        chaosFactor = 1.0
        chaosMultiplierMin = 0.7
        chaosMultiplierMax = 2.5

        // NightBorne
        
        nightBorneIsHit = false
        nightBorneLife = (income * 0.8) 
        nightBorneMaxLife = (income * 0.8) 

    // Character Management & Stats

        // Financial Data
        income = 100
            //TBC
        lifeRegenAllocation = 0.0 
        focusRegenAllocation = 0.3 // a) self -report budget driven (i.e. how much do you save/invest a month) b) queried - eventually determined by funds in specific location (myFi designated/directed savings/funds)
        energyRegenAllocation = 0.7  // a) self-report buidget driven b) delta of non-saved/invested income

        // Game Stats
        
        lifeRegen = lifeRegenAllocation * income // Calc TBD - Buy-in to myFi stable/pension/emergency fund provides buff to regen - lock tokens/stables and earn 1 - x% 'regen' i.e return
        focusRegen = focusRegenAllocation * income
        energyRegen = 0// energyRegenAllocation * income 
        lifeMultiplier = 3

        maxLife = income * lifeMultiplier
        startLife = maxLife
        currentLife = maxLife

        maxEnergy = income
        currentEnergy = maxEnergy

        startMaxEnergy = 100
        currentFocus = 200
        maxFocus = maxEnergy * 3

        damage = 0
        baseDamageMultiplier = 1


    // TBC

     skillTreeOpen = false
     storingBuffTier = 0
     spendingBuffTier = 0
     growingBuffTier = 0
     kianovaBuffTier = 0 
        
    }

    function runTurn(){


        
    }
    

    class HealthBar {

        constructor (scene,startLife, x, y,scaleX,scaleY)
        {
            this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            
            
            this.lifeBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            this.focusBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            this.energyBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            

            this.scaleX = scaleX
            this.scaleY = scaleY

            this.x = x;
            this.y = y;
            
            this.pL =  (39.5 * this.scaleX) / maxLife
            this.pF =  (39.5 * this.scaleX)  / maxFocus 
            this.pE =  (39.5 * this.scaleX)  / maxEnergy

            
            

            this.draw();

            scene.add.existing(this.bg)
            scene.add.existing(this.lifeBar);
            scene.add.existing(this.focusBar);
            scene.add.existing(this.energyBar);
            
        }

        decreaseLife (amount)
        {
            currentLife -= amount;

            if (currentLife > maxLife){
                currentLife = maxLife
            }

           

            if (currentLife < 0)
            {
                currentLife = 0;
            }

            this.draw();

            return (currentLife === 0);
        }

        decreaseEnergy (amount)
        {
            currentEnergy -= amount;

            if (currentEnergy > maxEnergy){
                currentEnergy = maxEnergy
            }

            if (currentEnergy < 0)
            {
                currentEnergy = 0;
            }
            

            this.draw();

            return (currentEnergy === 0);
        }

        decreaseFocus (amount)
        {
            currentFocus -= amount;

            if (currentFocus > maxFocus){
                currentFocus = maxFocus
            }

            if (currentFocus < 0)
            {
                currentFocus = 0;
            }

            this.draw();

            return (currentFocus === 0);
        }

        hide ()
        {
            this.bg.setVisible(0)
            this.lifeBar.setVisible(0)
            this.energyBar.setVisible(0)
            this.focusBar.setVisible(0)
        }

        show ()
        {
            this.bg.setVisible(1)
            this.lifeBar.setVisible(1)
            this.energyBar.setVisible(1)
            this.focusBar.setVisible(1)
        }

        draw ()
        {
            this.bg.clear()
            this.lifeBar.clear();
            this.focusBar.clear();
            this.energyBar.clear();
            

            //  BG
            this.bg.fillStyle(0x000000);
            this.bg.fillRect(this.x, this.y, (40 * this.scaleX), 13.25 * this.scaleY);

            //  Health

            this.lifeBar.fillStyle(0xffffff);
            this.lifeBar.fillRect(this.x + 1 , this.y + 1, 39.5 * this.scaleX, 4 * this.scaleY);
            this.lifeBar.fillStyle(0xcc0000);


            var d = Math.floor(this.pL * currentLife);

            this.lifeBar.fillRect(this.x + 1 , this.y + 1 , d , 4 * this.scaleY);

            //  Focus

            this.focusBar.fillStyle(0xffffff);
            this.focusBar.fillRect(this.x + 1 , (this.y + 2 + (4 * this.scaleY)) , 39.5 * this.scaleX, 4 * this.scaleY);
            this.focusBar.fillStyle(0xf1c232);
            

            var d = Math.floor(this.pF * currentFocus);

            this.focusBar.fillRect(this.x + 1 , (this.y + 2 + (4 * this.scaleY)), d  , 4 * this.scaleY);

            //  Energy

            this.energyBar.fillStyle(0xffffff);
            this.energyBar.fillRect(this.x + 1 , (this.y + 3 + ((4 * this.scaleY) * 2)) , 39.5 * this.scaleX , 4 * this.scaleY);
            this.energyBar.fillStyle(0x00a86b);
        

            var d = Math.floor(this.pE * currentEnergy);

            this.energyBar.fillRect(this.x + 1 , (this.y + 3 + ((4 * this.scaleY) * 2)), d , 4 * this.scaleY);

            
        }

    }

    class MiniHealthBar {

        constructor (scene,startLife, x, y,scaleX,scaleY)
        {
            this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            
            
            this.lifeBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            this.focusBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            this.energyBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            

            this.scaleX = scaleX
            this.scaleY = scaleY

            this.x = x;
            this.y = y;
            
            this.pL =  (38 * this.scaleX) / maxLife
            this.pF =  (38 * this.scaleX)  / maxFocus 
            this.pE =  (38 * this.scaleX)  / maxEnergy

            
            

            this.draw();

            scene.add.existing(this.bg)
            scene.add.existing(this.lifeBar);
            scene.add.existing(this.focusBar);
            scene.add.existing(this.energyBar);
            
        }

        decreaseLife (amount)
        {
            currentLife -= amount;

            if (currentLife > maxLife){
                currentLife = maxLife
            }

        

            if (currentLife < 0)
            {
                currentLife = 0;
            }

            this.draw();

            return (currentLife === 0);
        }

        decreaseEnergy (amount)
        {
            currentEnergy -= amount;

            if (currentEnergy > maxEnergy){
                currentEnergy = maxEnergy
            }

            if (currentEnergy < 0)
            {
                currentEnergy = 0;
            }
            

            this.draw();

            return (currentEnergy === 0);
        }

        decreaseFocus (amount)
        {
            currentFocus -= amount;

            if (currentFocus > maxFocus){
                currentFocus = maxFocus
            }

            if (currentFocus < 0)
            {
                currentFocus = 0;
            }

            this.draw();

            return (currentFocus === 0);
        }

        hide ()
        {
            this.bg.setVisible(0)
            this.lifeBar.setVisible(0)
            this.energyBar.setVisible(0)
            this.focusBar.setVisible(0)
        }

        show ()
        {
            this.bg.setVisible(1)
            this.lifeBar.setVisible(1)
            this.energyBar.setVisible(1)
            this.focusBar.setVisible(1)
        }

        draw ()
        {
            this.bg.clear()
            this.lifeBar.clear();
            this.focusBar.clear();
            this.energyBar.clear();
            

            //  BG
            this.bg.fillStyle(0x000000);
            this.bg.fillRect(this.x, this.y, (40 * this.scaleX), 16 * this.scaleY);

            //  Health

            this.lifeBar.fillStyle(0xffffff);
            this.lifeBar.fillRect(this.x + 1 , this.y + 1, 38 * this.scaleX, 4 * this.scaleY);
            this.lifeBar.fillStyle(0xcc0000);


            var d = Math.floor(this.pL * currentLife);

            this.lifeBar.fillRect(this.x + 1 , this.y + 1 , d , 4 * this.scaleY);

            //  Focus

            this.focusBar.fillStyle(0xffffff);
            this.focusBar.fillRect(this.x + 1 , (this.y + 2 + (4 * this.scaleY)) , 38 * this.scaleX, 4 * this.scaleY);
            this.focusBar.fillStyle(0xf1c232);
            

            var d = Math.floor(this.pF * currentFocus);

            this.focusBar.fillRect(this.x + 1 , (this.y + 2 + (4 * this.scaleY)), d  , 4 * this.scaleY);

            //  Energy

            this.energyBar.fillStyle(0xffffff);
            this.energyBar.fillRect(this.x + 1 , (this.y + 3 + ((4 * this.scaleY) * 2)) , 38 * this.scaleX , 4 * this.scaleY);
            this.energyBar.fillStyle(0x00a86b);


            var d = Math.floor(this.pE * currentEnergy);

            this.energyBar.fillRect(this.x + 1 , (this.y + 3 + ((4 * this.scaleY) * 2)), d , 4 * this.scaleY);

            
        }

    }

    class EnemyHealthBar {

    constructor (scene, x, y)
    {
        this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(1);
        
        this.nightBorneLifeBar = new Phaser.GameObjects.Graphics(scene).setDepth(1);

        this.x = x;
        this.y = y;
        
        this.p =  38 / nightBorneMaxLife

        this.draw();

        scene.add.existing(this.bg)
        scene.add.existing(this.nightBorneLifeBar);
    }

    decreaseNightborneLife (amount)
    {
        nightBorneLife -= amount;

        if (nightBorneLife < 0)
        {
            nightBorneLife = 0;
        }

        this.draw();

        return (nightBorneLife === 0);
    }

    draw ()
    {
        this.bg.clear()
        this.nightBorneLifeBar.clear();

        //  BG
        this.bg.fillStyle(0x000000);
        this.bg.fillRect(this.x, this.y, 40, 5);

        //  Health

        this.nightBorneLifeBar.fillStyle(0xffffff);
        this.nightBorneLifeBar.fillRect(this.x + 1, this.y + 1, 38, 3);
        this.nightBorneLifeBar.fillStyle(0xcc0000);


        var d = Math.floor(this.p * nightBorneLife);
   

        this.nightBorneLifeBar.fillRect(this.x + 1, this.y + 1, d, 3);

    }

    }

    class ExperienceBar {

    constructor (scene,exp, x, y)
    {
        this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(4);
        
        this.experienceBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);

        this.x = x;
        this.y = y;
        
        this.p =  (39.5 * playerVitals.scaleX) / expToLevelUp

        this.draw();

        scene.add.existing(this.bg)
        scene.add.existing(this.experienceBar);
        
    }

    increaseExp (amount)
    {
        exp += amount;

        if (exp > expToLevelUp)
        {
            exp = expToLevelUp;
        }

        this.draw();

        return (exp === expToLevelUp);
    }

    
        draw ()
        {
            this.bg.clear()
            this.experienceBar.clear();
           

            //  BG
            this.bg.fillStyle(0x000000);
            this.bg.fillRect(this.x, this.y, (40 * playerVitals.scaleX), 20);

            //  Exp

            this.experienceBar.fillStyle(0xffffff);
            this.experienceBar.fillRect(this.x + 1 , this.y + 1, 39.5 * playerVitals.scaleX, 18);
            this.experienceBar.fillStyle(0x674EA7);

            var d = Math.floor(this.p * exp);

            this.experienceBar.fillRect(this.x + 1 , this.y + 1, d, 18);

            
        }

    }

    class ActionTimeBar {

        constructor (scene,remActionTime, x, y)
        {
            this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            
            this.actionTimeBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);

            this.x = x;
            this.y = y;
            
            this.p =  203 / maxActionTime

            this.draw();

            scene.add.existing(this.bg)
            scene.add.existing(this.actionTimeBar);
            
        }

        decreaseActionTime (amount)
        {
            remActionTime -= amount;

            if (remActionTime < 0)
            {
                remActionTime = 0;
            }

            this.draw();

            return (remActionTime === 0);
        }

        hide ()
        {
            this.bg.setVisible(0)
            this.actionTimeBar.setVisible(0)
        }

        show ()
        {
            this.bg.setVisible(1)
            this.actionTimeBar.setVisible(1)

        }



            

            draw ()
            {
                this.bg.clear()
                this.actionTimeBar.clear();
            

                //  BG
                this.bg.fillStyle(0x000000);
                this.bg.fillRect(this.x, this.y, 205, 20);

                //  Action time

                this.actionTimeBar.fillStyle(0xffffff);
                this.actionTimeBar.fillRect(this.x + 1, this.y + 1, 203, 18);
                this.actionTimeBar.fillStyle(0x00CED1);


                var d = Math.floor(this.p * remActionTime);

                this.actionTimeBar.fillRect(this.x + 1, this.y + 1, d, 18);

                
            }

        }

    function showRunningHUD() {
        playerIcon.setVisible(1)
        playerIconBox.setVisible(1)
        playerVitals.show()

        levelIcon.setVisible(1)
        levelText.setVisible(1)
        
        gloryIcon.setVisible(1)
        gloryText.setVisible(1)

        goldIcon.setVisible(1)
        goldText.setVisible(1)
        

    }

    function hideRunningHUD() {
        playerIcon.setVisible(0)
        playerIconBox.setVisible(0)
        playerVitals.hide()

        levelIcon.setVisible(0)
        levelText.setVisible(0)
        
        gloryIcon.setVisible(0)
        gloryText.setVisible(0)

        goldIcon.setVisible(0)
        goldText.setVisible(0)

  
    }

    function showTierIcons() {
        // playerIcon.setVisible(1)
        // playerVitals.show()
        storingBuffIcon.setVisible(1)
        storingBuffTierIcon.setVisible(1)
        
        growingBuffIcon.setVisible(1)
        growingBuffTierIcon.setVisible(1) 

        spendingBuffIcon.setVisible(1)
        spendingBuffTierIcon.setVisible(1)

        kianovaBuffIcon.setVisible(1)
    }

    function hideTierIcons() {
        // playerIcon.setVisible(0)
        // playerVitals.hide()
        storingBuffIcon.setVisible(0)
        storingBuffTierIcon.setVisible(0)
        
        growingBuffIcon.setVisible(0)
        growingBuffTierIcon.setVisible(0) 

        spendingBuffIcon.setVisible(0)
        spendingBuffTierIcon.setVisible(0)

        kianovaBuffIcon.setVisible(0)
    }

    function enableTouchControls(isEnabled){
        if(isEnabled){

            touchEnabled = true

            left.setInteractive(1).setVisible(1)
            defaultAction.setInteractive(1).setVisible(1)
            charge.setInteractive(1).setVisible(1)

            right.setInteractive(1).setVisible(1)
            up.setInteractive(1).setVisible(1)
            down.setInteractive(1).setVisible(1)

        

        } else {

            touchEnabled = false

            left.disableInteractive().setVisible()
            defaultAction.setInteractive().setVisible()
            charge.disableInteractive().setVisible()

            right.disableInteractive().setVisible()
            up.disableInteractive().setVisible()
            down.setInteractive().setVisible()

        }
    }
     
   function modeSwitch(mode){
    if (mode == 0){
        woodsl4.setAlpha(1)
        gameMode = 0
        hideRunningHUD()

                playerAttacking = false
                sword.body.checkCollision.none = true
                nightBorneSword.body.checkCollision.none = true
                supportArrow.body.checkCollision.none = true
                supportArrow.setVisible(0)

       
        playerExperience.bg.setVisible(1)
        playerExperience.experienceBar.setVisible(1)
            
            
            inBattle = false
            
            player.flipX = false
            support.flipX = false
            
            
            camera.zoomTo(1,750)

                    camera.once('camerazoomcomplete', function () {
                            regenActive = true
                            nightBorne.x = 0
                            //player.body.setBoundsRectangle(new Phaser.Geom.Rectangle(width, 0, width, height));
                            playerMiniVitals.hide()
                            showRunningHUD()
                            nightBorneCam = true

                    }, this)
    } else if (mode == 1){
            woodsl4.setAlpha(0.65)
            inBattle = true
            gameMode = 1
            playerIsHit = false
         
            nightBorneCam = false 

            hideRunningHUD()
            playerExperience.bg.setVisible()
            playerExperience.experienceBar.setVisible()
           
            
                    
                    camera.resetFX()
                    camera.pan(width * 1.5,0,1500)
                    nightBorneGetInBattlePosition()
                    player.stop()
                    playerGetInBattlePosition()

                    camera.once('camerapancomplete', function () {

                        camera.startFollow(player, false, 0.05, 0.05)
                        
                    if(inBattle){
                    camera.zoomTo(1.05,750)
                    }

                        camera.once('camerazoomcomplete', function () {


                            camera.flash(250,1000)
                                camera.once('cameraflashcomplete', function () {
                                    
                                    //player.body.setBoundsRectangle(new Phaser.Geom.Rectangle(width * 1.1,0, width * 0.9, height));
                                    
                                    playerMiniVitals.show()
                                    showRunningHUD()
                                    playerVitals.hide()
                                    regenActive = true
                                    playerStance = 1
                                    controlsEnabled = true
                                   
                                 

                                    
                                    
                                },this)
                        }, this)
                    },this)
    }
   }


    function startNightBorneBattle(){

    
            if (!inBattle){
            nightBorneSword.body.checkCollision.none = true
            income *= 1 - (0.04 / 12)
            currentEnergy *= 0.95
            nightBorne.setDragX(500)
            nightBorneNecromancer.setDragX(1000)
            fireTowardsTarget(nightBorne,Phaser.Math.FloatBetween(width * 1.15, width * 1.45),4)
            fireTowardsTarget(nightBorneNecromancer,Phaser.Math.FloatBetween(width * 1.15, width * 1.25),1)
            
            regenActive = false
            modeSwitch(1)
            }

        
                

    }

    function playerGetInBattlePosition(){

        
        // Player crouches to jump away
            player.play({key:'pSlide',frameRate: 12},true);

                if(player.anims.getName() == 'pSlide'){
                    
                        fireTowardsTarget(player,Phaser.Math.FloatBetween(width * 1.65, width * 1.85),4)
                        support.play({key:'sRoll',repeat: 1},true)
                        fireTowardsTarget(support,Phaser.Math.FloatBetween(width * 1.6, width * 1.9),4)
                      
                }
                player.once('animationcomplete', function (anim,frame) {
                    player.emit('animationcomplete_' + anim.key, frame)
                }, player)

        // Player jumps away towards battle position
            player.once('animationcomplete_pSlide', function (anim,frame) {

                //camera.pan(player.x ,0,500)
                
                
                
                player.play({key:'pJump',frameRate: 12},true);

                if(player.anims.getName() == 'pJump'){
                    
                        
                        player.setVelocityY(-200)
                        playerLanded = false
  
                }

                player.once('animationcomplete', function (anim,frame) {
                    support.flipX = true

                    support.play('sIdle',true)
                    player.emit('animationcomplete_' + anim.key, frame)
                }, player)
            

            }, player)  

        // Player turns round after jump to face enemy
            player.once('animationcomplete_pJump', function (anim,frame) {
                
                player.flipX = true
            
                player.play({key:'pUptoFall'},true);

                if(player.anims.getName() == 'pUptoFall'){
                    
                    player.setVelocityX(150)
                      
                }

                player.once('animationcomplete', function (anim,frame) {
                    player.emit('animationcomplete_' + anim.key, frame)
                    
                }, player)
                
                
           
                player.flipX = true
            }, player) 


    }

    function nightBorneGetInBattlePosition(){

        

        

    // Enemy steps to position
    nightBorne.play({key:'nightBorne_Move',frameRate: 23,repeat:0});

            if(nightBorne.anims.getName() == 'nightBorne_Move'){
                
 
            }
            nightBorne.once('animationcomplete', function (anim,frame) {
                nightBorne.emit('animationcomplete_' + anim.key, frame)
            
            }, nightBorne)

    // Enemy taunts
    nightBorne.once('animationcomplete_nightBorne_Move', function (anim,frame) {
        
            
        nightBorne.play('nightBorne_Attack');

        
        nightBorne.once('animationcomplete', function (anim,frame) {
            nightBorne.emit('animationcomplete_' + anim.key, frame)
            }, nightBorne)
        

        }, nightBorne)  

    // Enemy enters idle
    nightBorne.once('animationcomplete_nightBorne_Attack', function (anim,frame) {
            
        
        nightBorne.play({key:'nightBorne_Idle'},true);
        


        nightBorne.once('animationcomplete', function (anim,frame) {
            nightBorne.emit('animationcomplete_' + anim.key, frame)
                
            }, nightBorne)
        

        }, nightBorne) 


    }


    function toggleRegen(){
        if (regenActive){
            regenActive = false
        } else {
            regenActive = true
        }
        
    }

    function fireTowardsTarget(sprite,targetPosition,seconds,inAir){

        if (inAir){
            var d = Phaser.Math.Between(1000,1250)
        } else {
            var d = Phaser.Math.Between(1250,2000)
        }
         

        sprite.setVelocityX(-(Phaser.Math.GetSpeed(sprite.x - targetPosition, seconds) * (seconds * d)))
    }

    function runFocusMode(){
        
        
        if(scanningForDanger){
            
        if (Math.abs(treeTrunk.x - player.x) < Math.abs((vines.x - player.x)) && treeTrunk.x - player.x > -250 && treeTrunk.x - player.x < 50){
            scanningForDanger = false
            if(player.body.onFloor() ){
            player.setVelocityY(-250)
            }
            player.setDragX(10)
            fireTowardsTarget(player,treeTrunk.x + 50,6)
            
            
            player.play({key:'pJump',frameRate:6},true)
            
            player.once('animationcomplete', function(){
               
                    player.play({key:'pDash',frameRate:8},true)
                    player.once('animationcomplete', function(){
                        
                        
                        scanningForDanger = true
                    },this)
              
            },this)
            
        } else if (Math.abs(vines.x - player.x) < Math.abs((treeTrunk.x - player.x)) && vines.x - player.x > -200 && vines.x - player.x < 50){
            scanningForDanger = false
            player.play({key:'pSlide',frameRate:4},true)
            player.setDragX(10)
            fireTowardsTarget(player,vines.x + 100,8)
            player.once('animationcomplete', function(){
               
                
                scanningForDanger = true
            },this)
        
        } else if (Math.abs(creep.x - player.x) < Math.abs((treeTrunk.x - player.x)) && Math.abs(creep.x - player.x) < Math.abs((vines.x - player.x)) && creep.x - player.x > -75 && creep.x - player.x < 150){
            scanningForDanger = false

            var attackChoice = Phaser.Math.Between(1,2)
            if (player.body.onFloor()){
                    if(attackChoice == 1){
                        player.play({key:'pDash',frameRate:18},true)
                        fireTowardsTarget(player,player.x + 75,1)
                        player.once('animationcomplete',function(){
                            player.play({key:'pDoubleAttack',frameRate:18},true)
                            player.once('animationcomplete',function(){
                                player.play({key:'pRun',repeat:-1},true)
                                scanningForDanger = true
                        },this)
                        },this)
                    
                   
                    } else if (attackChoice == 2) {
                        player.play({key:'pDash',frameRate:18},true)
                        fireTowardsTarget(player,player.x + 75,1)
                        player.once('animationcomplete',function(){
                        player.play('pAttack2',true)
                        player.once('animationcomplete',function(){
                            player.play({key:'pRun',repeat:-1},true)
                            scanningForDanger = true
                        },this)
                    },this)
                        
                    }
                } else if (!player.body.onFloor()) {
                    if (attackChoice == 1 || attackChoice == 2) {
                    player.play({key:'pDash',frameRate:18},true)
                    fireTowardsTarget(player,player.x + 50,2)
                    player.once('animationcomplete',function(){
                            player.play({key:'pHeavyAttack',frameRate:12},true)
                            //fireTowardsTarget(player,player.x + 75,2)
                            player.setVelocityY(Phaser.Math.Between(150,175))
                            player.once('animationcomplete',function(){
                              player.play({key:'pRun',repeat:-1},true)
                              scanningForDanger = true
                            },this)
                    },player)
                    }
                }
        } else {
            //scanningForDanger = false
            player.play({key:'pRun',frameRate:6},true)
            if(player.x > width * 1.35)
            player.x -= 1
            player.once('animationcomplete', function(){
                //fireTowardsTarget(player,width * 1.3,12)
                
            
            },this)
            scanningForDanger = true
        }
        }

    }
        
    function playerAction(){
        
        
        if(usingPower){

            usingPower = false

            normalAttack()

        }

    }
        
    
    function playerSkill(){
        
        
        if(usingPower){
            
        
            usingPower = false
                                    if(playerStance == 0){
                                     
                                    } else if (playerStance == 1){
                                        thunderStrike() 
                                        
                                        } else if (playerStance == 2){
                                            explosiveStrike()
                                            
                                        } else if (playerStance == 3){
                                            deadlyCombatAssault()
                                            
                                        } else if (playerStance == 4){
                                            coveringFire()
                                            support.play({key:'sShoot',frameRate:12},true)
                                                support.once('animationcomplete',function(){
                                                    support.play('sIdle',true)
                                                },this)
                                    }
            

        } 
        

    }
        

    function normalAttack(){

    

    // Damage Stats

    baseDamageMultiplier = Phaser.Math.Between(0.75,1)

    
  

    // Attack 1
       
        if(playerJumping){
            player.play({key:'pHeavyAttack',frameRate:8},true);
        } else if (playerCrouching) {
            player.play({key:'pAttack2',frameRate:10},true);
            playerCrouching = false
        } else {
            player.play({key:'pDoubleAttack'},true);
        }


        player.once('animationcomplete', function (anim,frame) {
            player.emit('animationcomplete_' + anim.key, frame)
        }, player)
        


    // Attack 2 - Neutral
        player.once('animationcomplete_pDoubleAttack', function (anim,frame) {
        
        
            player.play({key:'pHeavyAttack'},true);

            if(player.anims.getName() == 'pHeavyAttack'){
                
                if(player.flipX){
                    player.setVelocityX(50)
                } else {
                    player.setVelocityX(-50)
                }
                    
                
            }

            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)

                // Return to Idle - Neutral
                    player.once('animationcomplete_pHeavyAttack', function (anim,frame) {

                            
                    player.play({key:'pIdle'},true);

                  
                    usingPower = true



                    player.once('animationcomplete', function (anim,frame) {
                        player.emit('animationcomplete_' + anim.key, frame)
                        
                    }, player)


                    }, player)

            }, player)
        

        }, player) 


    // Attack 2 - Crouch Variant
        player.once('animationcomplete_pAttack2', function (anim,frame) {
        
        
            player.play({key:'pAttack1',frameRate:12},true);

            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)


            // Return to Idle - Crouch
                player.once('animationcomplete_pAttack1', function (anim,frame) {

                        
                player.play({key:'pIdle'},true);

              
                usingPower = true



                player.once('animationcomplete', function (anim,frame) {
                    player.emit('animationcomplete_' + anim.key, frame)
                    
                }, player)


                }, player)

            }, player)
        

        }, player)
        

    }


    function deadlyCombatAssault(){

    // Damage Stats

    baseDamageMultiplier = 0.75
    
    
    // Animation
       

    // Attack 1
       
        
        
            player.play({key:'pDoubleAttack',frameRate: 20},true);


            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
            }, player)
        

      
        
    
    
    // Attack 2
        player.once('animationcomplete_pDoubleAttack', function (anim,frame) {
        
        
            player.play({key:'pAttack1',frameRate: 16},true);

            if(player.anims.getName() == 'pAttack1'){
                
                if(player.flipX){
                    player.setVelocityX(25)
                } else {
                    player.setVelocityX(-25)
                }
                  
            }

            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
            }, player)
        

        }, player) 

   
        // Attack 3
            player.once('animationcomplete_pAttack1', function (anim,frame) {
            
            
                player.play({key:'pAttack2',frameRate: 16},true);

                player.once('animationcomplete', function (anim,frame) {
                    player.emit('animationcomplete_' + anim.key, frame)
                }, player)
            

            }, player)
        
        // Attack 4
            player.once('animationcomplete_pAttack2', function (anim,frame) {
            
            
                player.play({key:'pJump',frameRate: 14},true);

                
                    player.setVelocityX(100)
                

                if (player.body.onFloor()){
                    if(player.anims.currentFrame.index >= 1){
                        player.setVelocityY(-150)
                    }
                }

                player.once('animationcomplete', function (anim,frame) {
                    player.emit('animationcomplete_' + anim.key, frame)
                }, player)
            

            }, player) 

        // Attack 5
            player.once('animationcomplete_pJump', function (anim,frame) {
    
                    
                    player.play({key:'pHeavyAttack'},true);
                    

                    if (player.flipX){
                        player.setVelocityX(-50)
                    } else {
                        player.setVelocityX(50)
                    }

                    player.body.maxVelocity.y = 500


                    player.once('animationcomplete', function (anim,frame) {
                        player.emit('animationcomplete_' + anim.key, frame)
                        player.body.maxVelocity.y = 250
                       
                    }, player)
            

            }, player) 

            

            // Return to Idle
            player.once('animationcomplete_pHeavyAttack', function (anim,frame) {
    
                    
            player.play({key:'pIdle', frameRate: 8},true);
           
         
            
         

            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
                
            }, player)


            }, player)

        
    }

    function explosiveStrike(){

        // Damage Stats

        baseDamageMultiplier = Phaser.Math.Between(1.25,1.75)

    // In Range Movement

    // Attack 1

    player.play({key:'pHeavyAttack',frameRate: 6, repeat: 0},true);
    
                explosiveStrikeVFX.x = nightBorne.x
                explosiveStrikeVFX.y = nightBorne.y - 100
    explosiveStrikeVFX.play({key:'explosiveStrike',delay:500},true) 
         
    player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
            }, player)

    


            // Dash back to position
            player.once('animationcomplete_pHeavyAttack', function (anim,frame) {
                 camera.shake(500,0.075)
                // explosiveStrikeVFX.x = nightBorne.x
                // explosiveStrikeVFX.y = nightBorne.y - 100

                //explosiveStrikeVFX.play('explosiveStrike',true) 
                    
            player.play({key:'pBackDash', frameRate: 6},true);
            

            fireTowardsTarget(player,player.x + 100,1)
            

            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
                
            }, player)


            }, player)

            // Return to Idle
            player.once('animationcomplete_pBackDash', function (anim,frame) {

                    
            player.play({key:'pIdle', frameRate: 8},true);
            playerAttacking = false
           
            
           

            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
                
            }, player)


            }, player)


    }

    function coveringFire(){

    // Damage Stats

    baseDamageMultiplier = Phaser.Math.Between(0.15,0.25)

    supportArrowSpeedMultiplier = 2.5


    // In Range Movement


    // Attack / Skill

    

    // Attack 1
   

    player.play({key:'pAttack1',frameRate: 10},true);


    player.once('animationcomplete', function (anim,frame) {

        support.play('sShoot',true)
    player.emit('animationcomplete_' + anim.key, frame)
    }, player)


    

    // Attack 2
    player.once('animationcomplete_pAttack1', function (anim,frame) {


    player.play({key:'pAttack2'},true);

    if(player.anims.getName() == 'pAttack2'){
        
            player.setVelocityX(-25)
        
    }

    player.once('animationcomplete', function (anim,frame) {
        support.play('sShoot',true)
        player.emit('animationcomplete_' + anim.key, frame)
    }, player)


    }, player) 


    // Attack 3
    player.once('animationcomplete_pAttack2', function (anim,frame) {


        player.play({key:'pHeavyAttack'},true);

        player.once('animationcomplete', function (anim,frame) {
            support.play('sShoot',true)
            player.emit('animationcomplete_' + anim.key, frame)
        }, player)


    }, player)



    // Dash back to position
    player.once('animationcomplete_pHeavyAttack', function (anim,frame) {

            
    player.play({key:'pDash', frameRate: 12},true);

        
        if (player.x > nightBorne.x){
            fireTowardsTarget(player,nightBorne.x - 15,2)
        } else {
            fireTowardsTarget(player,nightBorne.x + 15,2)
        }

        


    player.once('animationcomplete', function (anim,frame) {
        support.play('sShoot',true)
        player.emit('animationcomplete_' + anim.key, frame)
        
        
    }, player)


    }, player)

    // Return to Idle
    player.once('animationcomplete_pDash', function (anim,frame) {
        support.play('sShoot',true)

            
    player.play({key:'pDoubleAttack', frameRate: 8},true);

   
    usingPower = true



    player.once('animationcomplete', function (anim,frame) {
        player.emit('animationcomplete_' + anim.key, frame)
        
    }, player)


    }, player)

    }

    function thunderStrike(){

        // Damage Stats

        baseDamageMultiplier = Phaser.Math.Between(0.25,3)

        // In Range Movement
        

        // Player Crouches

        player.play({key:'pCrouch',frameRate: 10},true);

        player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
            }, player)
        // Player Jumps up
            player.once('animationcomplete_pCrouch', function (anim,frame) {
            player.play({key:'pJump',frameRate: 10},true);
            

            player.setVelocityY(-350)
            player.setDragY(0)

        

            if(player.anims.getName() == 'pJump'){
                if (player.flipX){
                    player.setDragX(0)
                    fireTowardsTarget(player,nightBorne.x - 150,1)
                } else {
                    player.setDragX(0)
                    fireTowardsTarget(player,nightBorne.x + 150,1)
                }
                
                    
            }

            player.once('animationcomplete', function (anim,frame) {
                player.emit('animationcomplete_' + anim.key, frame)
            }, player)

        },player)


        // Player floats in air
            player.once('animationcomplete_pJump', function (anim,frame) {
            
            
                player.play({key:'pUptoFall',frameRate: 8},true);



                player.once('animationcomplete', function (anim,frame) {
                    player.emit('animationcomplete_' + anim.key, frame)
                }, player)
            

            }, player)


        // Attack / Skill

        // Attack 1
        player.once('animationcomplete_pUptoFall', function (anim,frame) {
            
            

            player.play({key:'pHeavyAttack',frameRate: 12},true);

            if(player.anims.currentFrame.index >= 1){

            player.setVelocityY(500)
            thunderStrikeVFX.x = nightBorne.x
                        thunderStrikeVFX.y = nightBorne.y + 50
                        camera.flash(500)      
                        camera.once('cameraflashcomplete',function(){
                                thunderStrikeVFX.play({key:'thunderStrike',frameRate:36},true)
                                camera.shake(500,0.05)
                                // chaserVFX.angle = 0
                                // chaserVFX.play('thunderStrikeSmear')        
                        },this)
            
            }


            player.once('animationcomplete', function (anim,frame) {
                
                player.emit('animationcomplete_' + anim.key, frame)
            }, player)


        }, player) 


            // Attack 2
                player.once('animationcomplete_pHeavyAttack', function (anim,frame) {
                
                
                    player.play({key:'pAttack2',frameRate:8},true);
                    thunderStrikeVFX.x = nightBorne.x
                    thunderStrikeVFX.y = nightBorne.y + 50
                    camera.flash(500)      
                        camera.once('cameraflashcomplete',function(){
                                thunderStrikeVFX.play({key:'thunderStrike',frameRate:24},true)
                                camera.shake(500,0.05)  
                            },this)

                    player.once('animationcomplete', function (anim,frame) {
                        
                        player.emit('animationcomplete_' + anim.key, frame)
                    }, player)

                    
                

                }, player)
            

                
                // Return to Idle
                player.once('animationcomplete_pAttack2', function (anim,frame) {

                        
                player.play({key:'pIdle', frameRate: 8},true);
                playerAttacking = false
             
                
            

                player.once('animationcomplete', function (anim,frame) {
                    player.emit('animationcomplete_' + anim.key, frame)
                    
                }, player)


                }, player)


        }



    function playerVineHit(){

    if (!inBattle){
        playerIsHit = true
       
        playerVitals.decreaseLife((income * 0.35) / 100)
        
        
        player.x -= 0.5
        enemyChase(Phaser.Math.FloatBetween(2,4))
    } 
    
    }

    function playerTreeTrunkHit(){

    if (inBattle == false){
        playerIsHit = true
       
        playerVitals.decreaseLife((income * 0.35) / 75)
        
        player.x -= 1

        enemyChase(Phaser.Math.FloatBetween(3,6))
    } 

    }

    function playerHitAnimation(){
        player.play('pHurt',true)
        player.once('animationcomplete',function(){
            playerIsHit = false
        })
    }

    function playerHit(){

        if (inBattle){

            if(playerBlocking){
                    
                   
                    
                    if (player.flipX){
                        fireTowardsTarget(player,player.x + 50,1)
                    } else {
                        fireTowardsTarget(player,player.x - 50,1)
                    }
                    
                    camera.shake(100, 0.0015);
                    
                    
                    playerVitals.decreaseLife((nightBorneMaxLife * 0.2) / 50)
                    
            } else if (!playerBlocking){
                playerIsHit = true

                playerVitals.decreaseLife((nightBorneMaxLife * 0.5) / 50)

                    maxEnergy *= 1 - (0.04 / 12 / 50)
                    if(glory - (25/60) < 0){
                        glory = 0
                    } else {
                        glory -= (25 / 60)
                    }
                    player.anims.play({key:'pHurt',frameRate: 12},true); 

                    
                    player.once('animationstart', function (){
                        camera.shake(150, 0.0025);
                    },player)

                    player.once('animationcomplete', function () {
                        playerIsHit = false 
                        player.play('pIdle', true)
                    }, this);
            }
                
                
            
            
            
            
            
            

        }   
    }
    



    function creepHit(){
    
        glory += level + 1
        gold += (level * 2) + 1
        creep.play('nightBorneMinion_Hurt',true)
        creep.x = player.x + 35
        camera.shake(150, 0.0015)
        creep.once('animationcomplete', function(){
            creep.play('nightBorneMinion_Death',true)
        },creep)

        
        
        
    }

    function nightBorneSupportHit(){
        nightBorneIsHit = true

        if (inBattle) {   

          
                nightBorneVFX.play('whiteHitSmear2',true)
                var sDamage = energyRegen * 0.25
                nightBorneVitals.decreaseNightborneLife(sDamage)
                nightBorneVFX.on('animationcomplete',function(){
                    supportArrow.setVisible(0)
             
                },this)

            fireTowardsTarget(nightBorne,nightBorne.x - 250,1)
        }
    }

    function nightBorneHit(){

        nightBorneIsHit = true

        if (inBattle) {   

          
            

            var chaos = Phaser.Math.FloatBetween(0.00,1.00)
            if (chaos < 0.25){
           
            camera.flash(150);
            camera.shake(500, 0.0075);
            damage *= 0//Phaser.Math.Between(1.75,2.25)
            nightBorneVitals.decreaseNightborneLife(damage)
            // if (player.flipX){
            //     nightBorne.setVelocityX(-Phaser.Math.Between(50,100))
                
                
            // } else {
            //     nightBorne.setVelocityX(Phaser.Math.Between(50,100))
            // }
            // if(nightBorne.body.onFloor()){
            //     nightBorne.setVelocityY(-Phaser.Math.Between(250,350))
            // }
            
            //
            } else
            if (chaos < 0.75){
            camera.shake(500, 0.0025);
            damage *= 0//Phaser.Math.Between(1.25,1.55)
            nightBorneVitals.decreaseNightborneLife(damage)
            // if (player.flipX){
            //     nightBorne.setVelocityX(-Phaser.Math.Between(0,70))
                
                
            // } else {
            //     nightBorne.setVelocityX(Phaser.Math.Between(0,70))
            // }
            // if(nightBorne.body.onFloor()){
            //     nightBorne.setVelocityY(-Phaser.Math.Between(100,250))
            // }
            } else {
                camera.shake(250, 0.0025);
                damage *= 0//Phaser.Math.Between(0.85,1.1)
                nightBorneVitals.decreaseNightborneLife(damage)
            //     if (player.flipX){
            //     nightBorne.setVelocityX(-Phaser.Math.Between(0,50))
                
                
            // } else {
            //     nightBorne.setVelocityX(Phaser.Math.Between(0,50))
            // }
            // if(nightBorne.body.onFloor()){
            //     nightBorne.setVelocityY(-Phaser.Math.Between(0,200))
            // }

       
            }
            
    
    }             
                 
    }

    function nightBorneRecover(){

        if (nightBorneIsHit){
            nightBorneIsHit  = false
            nightBorne.anims.play({key:'nightBorne_Idle',frameRate: 12},true); 
                
        }

    }

    

   
    function enemyChase(velocityBoost)
    {
       if (inBattle == false) {
        
        nightBorne.setVelocityX(nightBorne.body.velocity.x + (velocityBoost * chaosFactor))

        }
   
    }

    

    function runYearlyFunctions()
    {
       if (inBattle == false) {

        income *= 0.96
        
       

        }

        chaosMultiplierMin *= 1 + (0.08)
        chaosMultiplierMax *= 1 + (0.12)

    }

    function runMonthlyFunctions()
    {


        chaosMultiplierMin *= 1 + (0.06 / 12)
        chaosMultiplierMax *= 1 + (0.08 / 12) 

        

        if (inBattle == false) {

            nightBorneMaxLife = 2 + (income * chaosFactor) * 3
            nightBorneLife = nightBorneMaxLife
            nightBorneVitals.p = 38 / nightBorneMaxLife
            
        

        }  else {
            
        }
    }

    function nightBorne_EliteAI(){

        var actionChoice = Phaser.Math.Between(1,3)
        
        if (actionChoice == 1){
            nightBorne.play({key:'nightBorne_Attack',frameRate:12},true)

            nightBorne.on('animationcomplete', function(){
                nightBorne.play('nightBorne_Idle',true)
            }, nightBorne)
        } else if (actionChoice == 2){

            nightBorne.play({key:'nightBorne_Attack',frameRate:16},true)
        } else if (actionChoice == 3) {
            nightBorne.play('nightBorne_Idle',true)
        }
        
    }

    function runWeeklyFunctions()
    {
       
        

        if(inBattle){
             
            nightBorne_EliteAI()
        }
        

    }

    function runSecondsFunctions()
    {
        

        if (regenActive){

            
        playerVitals.decreaseLife(-lifeRegen / 5) 
        playerVitals.decreaseEnergy(-energyRegen / 5)
        playerVitals.decreaseFocus(-focusRegen / 5)

        }

        

        if (inBattle == false){
            if (skillTreeOpen == false){
                playerExperience.increaseExp((100 / 60))
                glory += (100 / 60)
            }
            
        } 

        
    }

    function refreshStats(){
        lifeRegen = lifeRegenAllocation * income
        energyRegen = energyRegenAllocation * income
        focusRegen = focusRegenAllocation * income
        
    }

    function updateHighScore(){
        if (highScore < glory){
            highScore = glory
        }

        
        localStorage.setItem('highScore',highScore);
    }


    function preload ()
    {   
        var progress = this.add.graphics();

    this.load.on('progress', function (value) {

        progress.clear();
        progress.fillStyle(0xffffff, 1);
        progress.fillRect(0, 270, 800 * value, 60);

    });

    this.load.on('complete', function () {

        progress.destroy();

    });

        // Music
        songChoice = Math.floor(Phaser.Math.Between(1,10))
        //if (songChoice == 1){
            this.load.audio("bgMusic1", ["assets/music/Le_château_magique.mp3"]);
        //} else if (songChoice == 2){
           this.load.audio("bgMusic2", ["assets/music/Kids_See_Ghosts.mp3"]);
        //} else if (songChoice == 3){
            this.load.audio("bgMusic3", ["assets/music/Riptide.mp3"]);
        //} else if (songChoice == 4){
            this.load.audio("bgMusic4", ["assets/music/The_Apartment.mp3"]);
       // } else if (songChoice == 5){
             this.load.audio("bgMusic5", ["assets/music/Katana.mp3"]);
        //} else if (songChoice == 6){
            this.load.audio("bgMusic6", ["assets/music/Ludum_Dare_38_Track_2.wav"]);
        //} else if (songChoice == 7){
            this.load.audio("bgMusic7", ["assets/music/Night_(Instrumental).mp3"]);
        //} else if (songChoice == 8){
            this.load.audio("bgMusic8", ["assets/music/Smile.mp3"]);
        //} else if (songChoice == 9){
            this.load.audio("bgMusic9", ["assets/music/Tripwire.mp3"]);
        //} else if (songChoice == 10){
            this.load.audio("bgMusic10", ["assets/music/Gumshield.mp3"]);
        //} 



        
        this.load.audio("playerSwordSwing", ["assets/sFX/SFX_Whoosh_Sword_02.mp3"]);
        this.load.audio("playerHeavySwordSwing", ["assets/sFX/SFX_Whoosh_Sword_03.mp3"]);        
        this.load.audio("enemySwordSwing", ["assets/sFX/SFX_Sword_Whoosh_01.mp3"]);
        this.load.audio("charge", ["assets/sFX/SFX_Potion_01.mp3"]);
        
        this.load.image('playerIconBox', 'assets/activeSkillBox.png');
        this.load.image('playerIcon', 'assets/playerIcon.png');
        

        this.load.image('storingBuffIcon', 'assets/ach_00059.png');
        this.load.image('spendingBuffIcon', 'assets/ach_00046.png');
        this.load.image('growingBuffIcon', 'assets/ach_00057.png');

        this.load.image('t1BuffIcon', 'assets/ach_00117.png');
        this.load.image('t2BuffIcon', 'assets/ach_00118.png');
        this.load.image('t3BuffIcon', 'assets/ach_00119.png');
        this.load.image('t4BuffIcon', 'assets/ach_00120.png');
        this.load.image('t5BuffIcon', 'assets/ach_00121.png');

        this.load.image('t1KianovaBuffIcon', 'assets/ach_00122.png');
        this.load.image('t2KianovaBuffIcon', 'assets/ach_00091.png');

        this.load.image('levelIcon', 'assets/ach_00006.png');
        this.load.image('gloryIcon', 'assets/ach_00035.png');
        this.load.image('goldIcon', 'assets/ach_00040.png');

        this.load.image('up', 'assets/controls/shadedDark03.png');
        this.load.image('down', 'assets/controls/shadedDark10.png');
        this.load.image('deadSpace', 'assets/controls/buttonDeadSpace.png');
        this.load.image('left', 'assets/controls/shadedDark05.png');
        this.load.image('right', 'assets/controls/shadedDark06.png');
        this.load.image('defaultAction', 'assets/controls/ach_00022.png');
        this.load.image('charge', 'assets/controls/ach_00005.png');
        
        // Battle Mode

        // Menus & Icons
        

        this.load.image('activeSkillBox', 'assets/activeSkillBox.png');
        this.load.image('energyMoveBox1', 'assets/energyMoveBox2.png');
        this.load.image('energyMoveBox2', 'assets/energyMoveBox2.png');
        this.load.image('focusMoveBox1', 'assets/focusMoveBox1.png');
        this.load.image('focusMoveBox2', 'assets/focusMoveBox2.png');


        this.load.image('dawnl1', 'assets/dawn1.png');
        this.load.image('dawnl2', 'assets/dawn2.png');
        this.load.image('dawnl3', 'assets/dawn3.png');
        this.load.image('dawnl4', 'assets/dawn4.png');
        this.load.image('dawnl5', 'assets/dawn5.png');
        this.load.image('dawnl6', 'assets/dawn6.png');
        this.load.image('dawnl7', 'assets/dawn7.png');
        this.load.image('dawnl8', 'assets/dawn8.png');

        this.load.image('woodsl1', 'assets/woods1.png');
        this.load.image('woodsl2', 'assets/woods2.png');
        this.load.image('woodsl3', 'assets/woods3.png');
        this.load.image('woodsl4', 'assets/woods4.png');

        this.load.image('vines', 'assets/vines.png');
        this.load.image('treeTrunk', 'assets/treeTrunk.png');

        this.load.image('ground', 'assets/woodground.png');

        
        this.load.atlas('heroF', 'assets/heroF.png','assets/heroF.json');
        this.load.atlas('heroM', 'assets/heroM.png','assets/heroM.json');
        this.load.spritesheet('arcaneArcher', 'assets/arcaneArcher.png', { frameWidth: 64, frameHeight: 64});
        this.load.image('arcaneArcherArrow', 'assets/arcaneArcherArrow.png');
        


        // General 

        this.load.spritesheet('playerLockOnIcon', 'assets/playerLockOnIcon.png', { frameWidth: 100, frameHeight: 100});
        // Enemies

        this.load.atlas('doomsayer', 'assets/doomsayer.png','assets/doomsayersprites.json');
        this.load.spritesheet('nightBorne', 'assets/nightBorne.png', { frameWidth: 80, frameHeight: 80});
        this.load.spritesheet('nightBorneNecromancer', 'assets/nightBorneNecromancer.png', { frameWidth: 160, frameHeight: 128});

        this.load.spritesheet('energyStance', 'assets/energyStance.png', { frameWidth: 96, frameHeight: 192});
        this.load.spritesheet('focusStance', 'assets/focusStance.png', { frameWidth: 96, frameHeight: 192});
        this.load.spritesheet('chargeEnergy', 'assets/chargeEnergy.png', { frameWidth: 100, frameHeight: 100});
        this.load.spritesheet('chargeDash', 'assets/chargeDash.png', { frameWidth: 128, frameHeight: 128});
        // VFX - Hit Animation
        this.load.spritesheet('whiteHitSmear', 'assets/whiteHitSmear.png', { frameWidth: 1048, frameHeight: 1048});
        this.load.spritesheet('whiteHitSmear2', 'assets/whiteHitSmear2.png', { frameWidth: 1048, frameHeight: 1048});  

        // Skills
        this.load.spritesheet('explosiveStrikeIcon', 'assets/skills/explosiveStrikeIcon.png', { frameWidth: 256, frameHeight: 256});
        this.load.spritesheet('explosiveStrike', 'assets/skills/explosiveStrike.png', { frameWidth: 48, frameHeight: 48}); 
        

        this.load.spritesheet('thunderStrikeIcon', 'assets/skills/thunderStrikeIcon.png', { frameWidth: 256, frameHeight: 256});
        this.load.spritesheet('thunderStrike', 'assets/skills/thunderStrike.png', { frameWidth: 64, frameHeight: 64}); 
        this.load.spritesheet('thunderStrikeSmear', 'assets/skills/thunderStrikeSmear.png', { frameWidth: 1048, frameHeight: 1048});

        this.load.spritesheet('deadlyCombatAssaultIcon', 'assets/skills/deadlyCombatAssaultIcon.png', { frameWidth: 256, frameHeight: 256});
        this.load.spritesheet('deadlyCombatAssaultSmear', 'assets/skills/deadlyCombatAssaultSmear.png', { frameWidth: 1048, frameHeight: 1048});

        this.load.spritesheet('eagleStrikeIcon', 'assets/skills/eagleStrikeIcon.png', { frameWidth: 256, frameHeight: 256});

        this.load.spritesheet('coveringFireIcon', 'assets/skills/coveringFireIcon.png', { frameWidth: 256, frameHeight: 256});
        
        

    }

    function create ()
    {

        // General 

            // Controls

                // Touch Screen Support

                this.input.addPointer(8);
                //Anchor buttons
                left = this.add.image(0,0, 'left').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);
                defaultAction = this.add.image(0, 0, 'defaultAction').setInteractive().setDepth(3).setScale(.6).setAlpha(0.5).setTint(0x00a86b);
                dAction = this.add.image(0, 0, 'defaultAction').setInteractive().setDepth(3).setScale(.6).setAlpha(0.5).setTint(0x90ee90);
                charge = this.add.image(0, 0, 'charge').setInteractive().setDepth(3).setScale(.6).setAlpha(0.5).setTint(0xf1c232);//Focus - 0xf1c232
                dSkill = this.add.image(0, 0, 'charge').setInteractive().setDepth(3).setScale(.6).setAlpha(0.5).setTint(0xffffe0);//Focus - 0xf1c232
                // Remaining buttons
                deadSpace = this.add.image(left.x + 35.5, left.y, 'deadSpace').setDepth(4).setScale(0.75).setVisible(0);
                right = this.add.image(deadSpace.x + 35.5, deadSpace.y, 'right').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);
                up = this.add.image(deadSpace.x, deadSpace.y - 40.5, 'up').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);
                down = this.add.image(deadSpace.x, left.y + 40.5 , 'down').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);

                // Checks if player is on Desktop.  If YES, touch controls disabled on initialisation

                if(this.sys.game.device.os.desktop){

                    touchEnabled = false

                    left.setInteractive().setVisible()
                    defaultAction.setInteractive().setVisible()
                    dAction.setInteractive().setVisible()
                    charge.setInteractive().setVisible()
                    dSkill.setInteractive().setVisible()

                    right.setInteractive().setVisible()
                    up.setInteractive().setVisible()
                    down.setInteractive().setVisible()

                } else {

                    touchEnabled = true

                    left.setInteractive(1).setVisible(1)
                    defaultAction.setInteractive(1).setVisible(1)
                    dAction.setInteractive(1).setVisible(1)
                    charge.setInteractive(1).setVisible(1)
                    dSkill.setInteractive(1).setVisible(1)

                    right.setInteractive(1).setVisible(1)
                    up.setInteractive(1).setVisible(1)
                    down.setInteractive(1).setVisible(1)

                }

        
        // Travel Mode 
        
        bgMusic = this.sound.add("bgMusic"+songChoice, {volume: 0.75});

        bgMusic.play()

        playerSwordSwing = this.sound.add("playerSwordSwing", {volume: 0.5})
        playerHeavySwordSwing = this.sound.add("playerHeavySwordSwing", {volume: 0.5})
        enemySwordSwing = this.sound.add("enemySwordSwing", {volume: 0.5})
        //charge = this.sound.add("charge",{volume: 0.5})
        
        this.physics.world.setBounds(0, 0, width * 3,  height);
        
        woodsl1 = this.add.tileSprite(0,0, width * 3, height, 'woodsl1').setOrigin(0,0).setScrollFactor(0)
        woodsl2 = this.add.tileSprite(0,0, width * 3, height, 'woodsl2').setOrigin(0,0).setScrollFactor(0.25)
        woodsl3 = this.add.tileSprite(0,0, width * 3, height, 'woodsl3').setOrigin(0,0).setScrollFactor(0.5)
        woodsl4 = this.add.tileSprite(0,0, width * 3, height, 'woodsl4').setOrigin(0,0).setScrollFactor(1).setDepth(3)

        this.lights.enable();
        this.lights.setAmbientColor(0x808080);

        spotlight = this.lights.addLight(400, 300, 280).setIntensity(0.5);
       
        platforms = this.physics.add.staticGroup();
        platforms.create(0, height - 50, 'ground').setOrigin(0,0).setScale(width * 3 /400).refreshBody().setVisible(1);


        player = this.physics.add.sprite(width * 1.3, height - 90 ,'heroF').setScale(2).setPipeline('Light2D');
        player.setDepth(2)
        player.tint = 0xdd7e6b;
        currentLife = startLife
        
        player.body.setSize(10, 30).setOffset(25,15).setAllowDrag(true)
        
        player.setBounceY(0.05);
        player.setCollideWorldBounds(true);
        //player.body.setBoundsRectangle(new Phaser.Geom.Rectangle(width, 0, width, height));
        this.physics.add.collider(player,platforms);

        // Show Player Bounds
        // this.add.graphics()
        // .lineStyle(5, 0x674EA7, 0.5)
        // .strokeRectShape(player.body.customBoundsRectangle).setDepth(4)
        

        sword = this.add.rectangle(player.x, player.y, 60, 60);
        this.physics.add.existing(sword, false)
        sword.body.setAllowGravity(false).setOffset(0,5).setSize(100, 55)
        sword.body.checkCollision.none = true

        // Support
        support = this.physics.add.sprite(width * 1.3, height - 90 ,'arcaneArcher').setScale(2.1).setPipeline('Light2D');
        support.body.setSize(15, 35).setAllowDrag(true).setOffset(25,18)
        support.setDepth(0)
        support.setCollideWorldBounds(true);
        this.physics.add.collider(support,platforms);
        supportArrow = this.add.image(support.x - 30,support.y - 15, 'arcaneArcherArrow').setOrigin(0,0.5).setDepth(0).setScale(2).setPipeline('Light2D').setVisible(0)
        this.physics.add.existing(supportArrow,false)
        supportArrow.body.setAllowGravity(false)
        supportArrow.body.checkCollision.none = true

        vines = this.add.image(player.x,player.y - 120, 'vines').setOrigin(0,0).setDepth(1).setScale(0.35,0.5).setTint(0x38761d)

        this.physics.add.existing(vines,false)
        vines.body.setAllowGravity(false)
        this.physics.add.overlap(player,vines, playerVineHit);
        vines.body.setSize(474,175).setOffset(0,-7.5)

        treeTrunk = this.add.image(0,height - 110, 'treeTrunk').setOrigin(0,0).setDepth(1)

        this.physics.add.existing(treeTrunk,false)
        treeTrunk.body.setAllowGravity(false)
        this.physics.add.overlap(player,treeTrunk, playerTreeTrunkHit);
        this.physics.add.collider(platforms,treeTrunk);
        treeTrunk.body.setSize(150,57).setOffset(5,10)

            // NightBorne
            
            nightBorne = this.physics.add.sprite(0, 0, 'nightBorne').setScale(3.25).setOrigin(0.5,1).setDepth(1)
            nightBorneVitals = new EnemyHealthBar(this,nightBorne.x, nightBorne.y - 150);
            nightBorneLife = (income * 0.3) * Phaser.Math.Between(0.8,1.7) 
            nightBorneMaxLife = nightBorneLife
         
            nightBorne.body.maxVelocity.x = 500
            nightBorne.body.setSize(45, 50)

            nightBorne.body.setAllowDrag(true)
           
            nightBorne.setCollideWorldBounds(true)
            nightBorne.body.setAllowGravity(1)
            this.physics.add.overlap(nightBorne, player, startNightBorneBattle);
            this.physics.add.overlap(sword, nightBorne, nightBorneHit)
            this.physics.add.overlap(supportArrow,nightBorne, nightBorneSupportHit);
            this.physics.add.collider(platforms,nightBorne);

            nightBorneSword = this.add.rectangle(nightBorne.x, nightBorne.y, 150, 175);
            this.physics.add.existing(nightBorneSword, false)
            nightBorneSword.body.setAllowGravity(false)
            nightBorneSword.body.checkCollision.none = true
            this.physics.add.overlap(nightBorneSword, player, playerHit);

            nightBorneOutline = this.physics.add.sprite(nightBorne.x - 1, nightBorne.y - 2.5, 'nightBorne').setScale(3.25).setOrigin()
            nightBorneOutline.setTintFill(0x7851a9).setDepth(0).setAlpha(0.75)
            nightBorneOutline.body.setAllowGravity(0)
            nightBorneOutline.body.setSize(45, 50)
            nightBorneOutline.setCollideWorldBounds(false)
            this.tweens.add({
                                    targets     : nightBorneOutline,
                                    alpha       : 0, 
                                    scale      : 3.35,
                                   
                                    ease        : 'Power2',
                                    duration    : 2000,
                                    yoyo        : 1,
                                    //loop        : -1,
                                    repeat      : -1
            });
            
            nightBorneVFX = this.add.sprite(nightBorne.x, nightBorne.y + 100)
            nightBorneVFX.setScale(1).setTint(0x00CED1).setDepth(4).setVisible(1)//.setPipeline('Light2D')

            nightBorneNecromancer = this.physics.add.sprite(nightBorne.x - 100, nightBorne.y + 75, 'nightBorneNecromancer').setScale(1.75).setOrigin()
            nightBorneNecromancer.setDepth(1)
            nightBorneNecromancer.setSize(60, 60).setOffset(50,50)
            nightBorneNecromancer.body.maxVelocity.x = 500
            nightBorneNecromancer.setCollideWorldBounds(true)
            nightBorneNecromancer.body.setAllowGravity(0)
            this.physics.add.collider(platforms,nightBorneNecromancer);
            
            nightBorneNecromancerOutline = this.physics.add.sprite(nightBorneNecromancer.x - 1, nightBorneNecromancer.y - 2.5, 'nightBorneNecromancer').setScale(2.1).setOrigin()
            nightBorneNecromancerOutline.setTintFill(0x7851a9).setDepth(0).setAlpha(1)
            nightBorneNecromancerOutline.body.setAllowGravity(0)
            nightBorneNecromancerOutline.setSize(60, 60).setOffset(50,50)
            nightBorneNecromancerOutline.setCollideWorldBounds(true)
            this.tweens.add({
                                    targets     : nightBorneNecromancerOutline,
                                    alpha       : 0, 
                                    scale      : 1.9,
                                   
                                    ease        : 'Power2',
                                    duration    : 2000,
                                    yoyo        : 1,
                                    //loop        : -1,
                                    repeat      : -1
            });

            nightBorneNecromancerVFX = this.add.sprite(nightBorneNecromancer.x, nightBorneNecromancer.y)
            nightBorneNecromancerVFX.setDepth(0).setScale(0.25)//.setPipeline('Light2D')

            // Creep

            creep = this.physics.add.sprite(0, 0, 'doomsayer').setScale(1).setOrigin().setPipeline('Light2D')
            creep.setCollideWorldBounds(true)
            creep.body.setAllowGravity(1)
            this.physics.add.collider(platforms,creep);
            this.physics.add.overlap(creep, sword, creepHit);
            //this.physics.add.overlap(creep, player, playerCreepHit);

        camera = this.cameras.main.centerOn(width * 1.5,0) //.startFollow(player, false, 0.05, 0.05)


        camera.setBounds(width * 0.25, 0, width * 2.75, height)
 
        camera.fadeIn(3000)

        playerIcon = this.add.image(camera.scrollX + 30,camera.scrollY + 40,'playerIcon').setDepth(3).setScale(3.5)
        playerIconBox = this.add.image(playerIcon.x - 25,camera.scrollY + 40,'playerIconBox').setDepth(2).setScale(0.02585,0.079).setOrigin(0,0.5)

        levelIcon = this.add.image(playerIcon.x + 50,playerIcon.y,'levelIcon').setDepth(4).setScale(0.5).setOrigin(0.5,0.5)
        levelText = this.add.text(levelIcon + 10, levelIcon.y, Math.floor(level)).setFontFamily('Arial').setFontSize(36).setColor('#674EA7').setDepth(4).setOrigin(0.5,0.5)

        playerVitals = new HealthBar(this,startLife, levelIcon.x + 30, playerIcon.y + 20,5,3)
        playerMiniVitals = new MiniHealthBar(this,startLife, playerIcon.x + 30, playerIcon.x + 20,1,1);
        playerMiniVitals.hide()

        gloryIcon = this.add.image(levelIcon.x + 100,camera.scrollY + 20,'gloryIcon').setDepth(4).setScale(0.35)
        gloryText = this.add.text(gloryIcon + 20, gloryIcon.y, Math.floor(level)).setFontFamily('Arial').setFontSize(36).setColor('#BC3823').setDepth(4);
        goldIcon = this.add.image(gloryIcon.x + 130,camera.scrollY + 60,'goldIcon').setDepth(4).setScale(0.35)
        goldText = this.add.text(goldIcon, goldIcon.y, Math.floor(glory)).setFontFamily('Arial').setFontSize(36).setColor('#ffd700').setDepth(4);

        storingBuffIcon = this.add.image(0,0,'storingBuffIcon').setDepth(4).setScale(0.5)
        growingBuffIcon = this.add.image(0,0,'growingBuffIcon').setDepth(4).setScale(0.5)
        spendingBuffIcon = this.add.image(0,0,'spendingBuffIcon').setDepth(4).setScale(0.5)

        activeSkillBox = this.add.image(camera.scrollX + 300,camera.scrollY + 40,'activeSkillBox').setDepth(3).setScale(0.072,0.05).setOrigin(0,0.5)
        skillIcon = this.add.image(camera.scrollX + 300,camera.scrollY + 40).setDepth(3).setScale(0.15).setOrigin(0,0.5)
        skillNameText = this.add.text(0, 0, "").setFontFamily('Revalia').setFontSize(16).setColor('#ff9900').setDepth(4).setOrigin(0,0).setAlpha(0);
        
        moveBox = this.add.image(0, 0, 'focusMoveBox2').setDepth(4).setAlpha(0).setScale(0.055,.1).setOrigin(0,0)
        moveNameText = this.add.text(0, 0, "Deadly Combat Assault").setFontFamily('Revalia').setFontSize(12).setColor('#ff9900').setDepth(4).setOrigin(0,0).setAlpha(0);
        moveText = this.add.text(0, 0, "Move descripotion line 1\nMove description line 2").setFontFamily('Revalia').setFontSize(9).setColor('#FFFFFF').setDepth(4).setAlpha(0);
        moveIcon = this.add.image(0,0,'deadlyCombatAssaultIcon').setDepth(4).setScale(0.1).setOrigin(0,0).setAlpha(0)
        moveTypeIcon = this.add.image(0,0,'growingBuffIcon').setDepth(4).setScale(0.35).setOrigin(0,0).setAlpha(0)
        
        stance0Name = ''
        stance0Text = ""
        stance1Name = 'Thunder Strike'
        stance1Text = "Rain thunderous rage down on \nenemies in an area\n\nCan cause Aftershock"
        stance2Name = 'Explosive Strike'
        stance2Text = "Take a moment, channelling\nfocus to charge heal"
        stance3Name = 'Deadly Combat Assault'
        stance3Text = "Unleash a deadly flurry of attacks\n\nIncreases in damage with \nconsecutive use"
        stance4Name = 'Covering Fire'
        stance4Text = "Charge the enemy under a \nbarrage of fire\n\nChance to inflict Suppression"

        playerExperience = new ExperienceBar(this,exp, camera.scrollX + width * 0.33, camera.scrollY + (height - 85),5,1);

        skillTreeLifeIcon = this.add.image(width * 0.25, height / 2,'storingBuffIcon').setDepth(4).setScale(1).setVisible(0).setAlpha(0.75)
        skillTreeFocusIcon = this.add.image(width * 0.5 , height / 2,'growingBuffIcon').setDepth(4).setScale(1).setVisible(0).setAlpha(0.75)
        skillTreeEnergyIcon = this.add.image(width * 0.75, height / 2,'spendingBuffIcon').setDepth(4).setScale(1).setVisible(0).setAlpha(0.75)

        // 96 seconds = 1 year
        // 8 seconds = 1 month
        // 2 second per week
        // 0.285 seconds per day

        yearlyFunctionsTimer = this.time.addEvent({delay: 60000, callback: runYearlyFunctions, args: [], callbackScope: this, loop: true});
    
        monthlyFunctionsTimer = this.time.addEvent({delay: 5000, callback: runMonthlyFunctions, args: [], callbackScope: this, loop: true});

        weeklyFunctionsTimer = this.time.addEvent({delay: 1250, callback: runWeeklyFunctions, args: [], callbackScope: this, loop: true});

        secondsTimer = this.time.addEvent({delay: 1000, callback: runSecondsFunctions, args: [], callbackScope: this, loop: true});
        
        // VFX

        // General

        this.anims.create({
            key: 'playerLockOnIcon',
            frames: this.anims.generateFrameNumbers('playerLockOnIcon', { start:0, end: 72}),
            frameRate: 81,
            repeat: -1,
            yoyo: 0
        });

        this.anims.create({
            key: 'energyStance',
            frames: this.anims.generateFrameNumbers('energyStance', { start:0, end: 35}),
            frameRate: 100,
            repeat: 0,
            //yoyo: true
        });

        this.anims.create({
            key: 'focusStance',
            frames: this.anims.generateFrameNumbers('focusStance', { start:0, end: 35}),
            frameRate: 100,
            repeat: 0,
            //yoyo: true
        });

        this.anims.create({
            key: 'chargeEnergy',
            frames: this.anims.generateFrameNumbers('chargeEnergy', { start:0, end: 91}),
            frameRate: 100,
            repeat: 0,
            //yoyo: true
        });

        this.anims.create({
            key: 'chargeDash',
            frames: this.anims.generateFrameNumbers('chargeDash', { start:0, end: 5}),
            frameRate: 6,
            repeat: 0,
            //yoyo: true
        });

        this.anims.create({
            key: 'whiteHitSmear',
            frames: this.anims.generateFrameNumbers('whiteHitSmear', { start:0, end: 16}),
            frameRate: 16,
            repeat: 0,
            showOnStart: 1,
            hideOnComplete: 1
        });

        this.anims.create({
            key: 'whiteHitSmear2',
            frames: this.anims.generateFrameNumbers('whiteHitSmear2', { start:0, end: 16}),
            frameRate: 16,
            repeat: 0,
            showOnStart: 1,
            hideOnComplete: 1
        });

        this.anims.create({
            key: 'deadlyCombatAssaultSmear',
            frames: this.anims.generateFrameNumbers('deadlyCombatAssaultSmear', { start:0, end: 16}),
            frameRate: 20,
            repeat: 0,
            showOnStart: 1,
            hideOnComplete: 1
        });

        // Meditate

        this.anims.create({
            key: 'meditateStance',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Crouch_', start: 1, end: 5, suffix: '.png'}),
            frameRate: 6,
            repeat: 0,
            //yoyo: true,
            //delay: 1
        });

        // Thunder Strike

        this.anims.create({
            key: 'thunderStrike',
            frames: this.anims.generateFrameNumbers('thunderStrike', { start:0, end: 12}),
            frameRate: 24,
            repeat: 0,
            showOnStart: 1,
            hideOnComplete: 1
        });

        this.anims.create({
            key: 'thunderStrikeSmear',
            frames: this.anims.generateFrameNumbers('thunderStrikeSmear', { start:0, end: 16}),
            frameRate: 20,
            repeat: 0,
            showOnStart: 1,
            hideOnComplete: 1
        });

        this.anims.create({
            key: 'thunderStrikeStance',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 3, end: 1, suffix: '.png'}),
            frameRate: 6,
            repeat: 0,
            //yoyo: true,
            //delay: 1
        });

        thunderStrikeVFX = this.add.sprite(0,0)
        thunderStrikeVFX.setDepth(1).setScale(2,5).setOrigin(0.5,1)//.setPipeline('Light2D')
        thunderStrikeLighting = this.lights.addLight(0, 0, 0).setIntensity(1.5)
        thunderStrikeLighting.setColor(0xFFBF1F)
        
        thunderStrikeLighting.intensity = 2
        thunderStrikeLighting.x = thunderStrikeVFX.x
        thunderStrikeLighting.y = thunderStrikeVFX.y

        // Explosive Strike

        this.anims.create({
            key: 'explosiveStrike',
            frames: this.anims.generateFrameNumbers('explosiveStrike', {start:0, end: 18}),
            frameRate: 36,
            repeat: 0,
            showOnStart: 1,
            hideOnComplete: 1
        });

        explosiveStrikeVFX = this.add.sprite(0,0)
        explosiveStrikeVFX.setDepth(2).setScale(3)

        // Player Animations
        this.anims.create({
            key: 'pIdle',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Idle_', start: 1, end: 6, suffix: '.png'}),
            frameRate: 8,
            repeat: -1
        });

        this.anims.create({
            key: 'pDeath',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Death_', start: 1, end: 11, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });

        this.anims.create({
            key: 'pHurt',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_hurt_', start: 1, end: 4, suffix: '.png'}),
            frameRate: 8,
            repeat: 0
        });

        this.anims.create({
            key: 'pSlide',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior-Slide_', start: 1, end: 4, suffix: '.png'}),
            frameRate: 14,
            repeat: 0
        });

        this.anims.create({
            key: 'pCrouch',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Crouch_', start: 1, end: 5, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });

        this.anims.create({
            key: 'pJump',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Jump_', start: 1, end: 3, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });

        this.anims.create({
            key: 'pUptoFall',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_UptoFall_', start: 1, end: 2, suffix: '.png'}),
            frameRate: 10,
            repeat: 0
        });

        this.anims.create({
            key: 'pRun',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Run_', start: 1, end: 8, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pDownStance',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash-Attack_', start: 1, end: 3, suffix: '.png'}),
            frameRate: 6,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pChargeSpecial1',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash-Attack_', start: 10, end: 10, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pChargeSpecial2',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash-Attack_', start: 1, end: 2, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pDash',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash_', start: 1, end: 7, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pBackDash',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash_', start: 5, end: 7, suffix: '.png'}),
            frameRate: 12,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pParry',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 9, end: 12, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pDoubleAttack',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 1, end: 12, suffix: '.png'}),
            frameRate: 16,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pAttack1',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 1, end: 8, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pAttack2',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 9, end: 12, suffix: '.png'}),
            frameRate: 10,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pStance0',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 1, end: 3, suffix: '.png'}),
            frameRate: 6,
            repeat: 0,
            //yoyo: true,
            //delay: 1
        });

        this.anims.create({
            key: 'pBlock',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 8, end: 9, suffix: '.png'}),
            frameRate: 8,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'deadlyCombatAssaultStance',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 1, end: 4, suffix: '.png'}),
            frameRate: 6,
            repeat: 0,
            //yoyo: true,
            //delay: 1
        });

        this.anims.create({
            key: 'pHeavyAttack',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash-Attack_', start: 1, end: 10, suffix: '.png'}),
            frameRate: 10,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pChargeEnergy',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Crouch_', start: 1, end: 6, suffix: '.png'}),
            frameRate: 4,
            repeat: 0,
            //yoyo: true,
            //delay: 500
        });

        // Support Animation

        this.anims.create({
            key: 'sIdle',
            frames: this.anims.generateFrameNumbers('arcaneArcher', { start:40, end: 43}),
            frameRate: 10,
            repeat:-1
        });

        this.anims.create({
            key: 'sRun',
            frames: this.anims.generateFrameNumbers('arcaneArcher', { start:0, end: 7}),
            frameRate: 12,
            repeat:-1
        });

        this.anims.create({
            key: 'sRoll',
            frames: this.anims.generateFrameNumbers('arcaneArcher', { start:16, end: 22}),
            frameRate: 12,
            repeat: 0
        });

        this.anims.create({
            key: 'sJump',
            frames: this.anims.generateFrameNumbers('arcaneArcher', { start:56, end: 57}),
            frameRate: 4,
            repeat: 0
        });

        this.anims.create({
            key: 'sShoot',
            frames: this.anims.generateFrameNumbers('arcaneArcher', { start:24, end: 30}),
            frameRate: 8,
            repeat: 0
        });

        // NightBorne Animation

        this.anims.create({
            key: 'nightBorneMinion_Move',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'walk', start: 1, end: 8}),
            frameRate: 10,
            showOnStart: 1,
            repeat: -1
        });

        this.anims.create({
            key: 'nightBorneMinion_Idle',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'idle', start: 1, end: 8}),
            frameRate: 10,
            showOnStart: 1,
            repeat:-1
        });

        this.anims.create({
            key: 'nightBorneMinion_Attack',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'attack', start: 1, end: 10}),
            frameRate: 10,
            showOnStart: 1,
            delay: 25,
            //repeatDelay: Math.random() * 3000
            
        });

        this.anims.create({
            key: 'nightBorneMinion_Hurt',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'hurt', start: 1, end: 3}),
            frameRate: 10,
            repeat: 0
        });

        this.anims.create({
            key: 'nightBorneMinion_Death',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'death', start: 1, end: 10}),
            frameRate: 12,
            repeat: 0,
            hideOnComplete: 1
            
        });

        this.anims.create({
            key: 'nightBorne_Idle',
            frames: this.anims.generateFrameNumbers('nightBorne', { start:0, end: 8}),
            frameRate: 12,
            showOnStart: 1,
            repeat:-1
        });

        this.anims.create({
            key: 'nightBorne_Move',
            frames: this.anims.generateFrameNumbers('nightBorne', { start:23, end: 28}),
            frameRate: 12,
            showOnStart: 1,
            repeat:-1
        });

        this.anims.create({
            key: 'nightBorne_Attack',
            frames: this.anims.generateFrameNumbers('nightBorne', { start:46, end: 57}),
            frameRate: 12,
            showOnStart: 1,
            repeat:0
        });

        this.anims.create({
            key: 'nightBorne_Hurt',
            frames: this.anims.generateFrameNumbers('nightBorne', { start:69, end: 73}),
            frameRate: 12,
            showOnStart: 1,
            repeat:0
        });

        this.anims.create({
            key: 'nightBorne_Death',
            frames: this.anims.generateFrameNumbers('nightBorne', { start:91, end: 115}),
            frameRate: 23,
            repeat:0,
            hideOnComplete: 1
        });

        this.anims.create({
            key: 'nightBorneNecromancer_Idle',
            frames: this.anims.generateFrameNumbers('nightBorneNecromancer', { start:0, end: 7}),
            frameRate: 8,
            showOnStart: 1,
            repeat:-1
        });

        this.anims.create({
            key: 'nightBorneNecromancer_Move',
            frames: this.anims.generateFrameNumbers('nightBorneNecromancer', { start:17, end: 24}),
            frameRate: 12,
            showOnStart: 1,
            repeat:-1
        });

        this.anims.create({
            key: 'nightBorneNecromancer_Attack',
            frames: this.anims.generateFrameNumbers('nightBorneNecromancer', { start:51, end: 63}),
            frameRate: 16,
            showOnStart: 1,
            repeat:0
        });

        this.anims.create({
            key: 'nightBorneNecromancer_Attack2',
            frames: this.anims.generateFrameNumbers('nightBorneNecromancer', { start:34, end: 46}),
            frameRate: 10,
            showOnStart: 1,
            repeat:0
        });

        this.anims.create({
            key: 'nightBorneNecromancer_Attack3',
            frames: this.anims.generateFrameNumbers('nightBorneNecromancer', { start:68, end: 84}),
            frameRate: 8,
            showOnStart: 1,
            repeat:0
        });

        this.anims.create({
            key: 'nightBorneNecromancer_Hurt',
            frames: this.anims.generateFrameNumbers('nightBorneNecromancer', { start:85, end: 89}),
            frameRate: 23,
            repeat:0,
            showOnStart: 1
        });

        this.anims.create({
            key: 'nightBorneNecromancer_Death',
            frames: this.anims.generateFrameNumbers('nightBorneNecromancer', { start:102, end: 111}),
            frameRate: 8,
            repeat:0,
            hideOnComplete: 1
        });

        gfx = this.add.graphics();
       
        // GamePad

        this.input.gamepad.on('connected', function (pad) {
            gamePad = pad
            gamePadEnabled = true
        },this)


        
        // Controllers online
        cursors = this.input.keyboard.createCursorKeys();
        keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
        keyZ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);
        keyX = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X);

        this.input.on('gameobjectdown', function (pointer, gameObject) {
        

             gameObject.setAlpha(1);

            if (gameObject == skillTreeLifeIcon){

                var tier = storingBuffTier += 1
                income *= 1.025
                maxLife *= 1.05
                lifeRegenAllocation += 0.05

                if (tier >= 5){
                    tier = 5
                    var alpha = 1
                } else if (tier == 0){
                    var alpha = 0.5
                    tier = 1
                } else {
                    var alpha = 1
                }

                //storingBuffTierIcon.setTexture('t'+ tier +'BuffIcon').setAlpha(alpha)
                playerVitals.pL = (39.5 * playerVitals.scaleX) / maxLife
                playerVitals.draw()
                playerMiniVitals.pL = (38 * playerMiniVitals.scaleX) / maxLife

                toggleSkillTree()
            
                
            } 

            if (gameObject == skillTreeFocusIcon){

                

                var tier = growingBuffTier += 1
                income *= 1.025
                focusRegenAllocation *= 1.20
                focusRegenAllocation += 0.01
                maxFocus *= 1.1

                if (tier >= 5){
                    tier = 5
                    var alpha = 1
                } else if (tier == 0){
                    var alpha = 0.5
                    tier = 1
                } else {
                    var alpha = 1
                }

                //growingBuffTierIcon.setTexture('t'+ tier +'BuffIcon').setAlpha(alpha)
                playerVitals.pF = (39.5 * playerVitals.scaleX) / maxFocus
                playerVitals.draw()
                playerMiniVitals.pF = (38 * playerMiniVitals.scaleX) / maxFocus

                toggleSkillTree()
                
                
            } 

            if (gameObject == skillTreeEnergyIcon){

                var tier = spendingBuffTier
                income *= 1.025
                energyRegenAllocation *= 1.30
                energyRegenAllocation += 0.01
                maxEnergy *= 1.15
                tier = spendingBuffTier += 1

                if (tier >= 5){
                    tier = 5
                    var alpha = 1
                } else {
                    var alpha = 1
                }

                //spendingBuffTierIcon.setTexture('t'+ tier +'BuffIcon').setAlpha(alpha)
                playerVitals.pE = (39.5 * playerVitals.scaleX) / maxEnergy
                playerVitals.draw()
                playerMiniVitals.pE = (38 * playerMiniVitals.scaleX) / maxEnergy

                toggleSkillTree()
               
                
            } 

        });

        this.input.on('gameobjectup', function (pointer, gameObject) {

        gameObject.setAlpha(0.5);


        });

        this.input.on('gameobjectout', function (pointer, gameObject) {

            gameObject.setAlpha(0.5);

            });
            
            enemies = this.physics.add.group({
                
            })

            enemies.add(nightBorne)
            //enemies.add(nightBorneNecromancer)  
            enemies.add(creep) 

    }

    function toggleSkillTree(){

       

        if (skillTreeOpen){
            
            
            skillTreeLifeIcon.setVisible(0).disableInteractive()
            skillTreeFocusIcon.setVisible(0).disableInteractive()
            skillTreeEnergyIcon.setVisible(0).disableInteractive()
            skillTreeOpen = false
         
            
         
        } else {
            
            skillTreeLifeIcon.setVisible(1).setInteractive()
            skillTreeFocusIcon.setVisible(1).setInteractive()
            skillTreeEnergyIcon.setVisible(1).setInteractive()
            skillTreeOpen = true
           
    

            nightBorne.setVelocityX(-100)
          
        }
        
           
    }

    function moveVines (vine,speed){
    
        vine.x -= speed;
        if (vine.x < Phaser.Math.Between(0,width * 0.2)){
            resetVines(vine)
        }

        
    }

    function moveTreeTrunk (treeTrunk,speed){
    
    treeTrunk.x -= speed;
    if (treeTrunk.x < Phaser.Math.Between(0,width * 0.05)){
        resetTreeTrunk(treeTrunk)
    }

    
    }

    function moveCreep (speed){
    
        if (creep.anims.getName() != 'nightBorneMinion_Hurt'){
            creep.x -= speed;
        }
        
        if (creep.x < Phaser.Math.Between(0,width * 0.25)){
            resetCreep(creep)
        }

    
    }

    function resetVines (vine){
        vine.x = width * 3
        var scaleXRandom = Phaser.Math.FloatBetween(0.15,0.65)
        var scaleYRandom = Phaser.Math.FloatBetween(0.55,0.8)
        vine.setScale(scaleXRandom,scaleYRandom)
    }

    function resetTreeTrunk (treeTrunk){
        treeTrunk.x = width * 3
        var scaleXRandom = Phaser.Math.FloatBetween(0.75,1.1)
        var scaleYRandom = Phaser.Math.FloatBetween(0.8,1.2)
        treeTrunk.setScale(scaleXRandom,scaleYRandom)
    }

    function resetCreep (creep){
        creep.x = Phaser.Math.Between(width * 2.5,width * 3)
        var creepAnimationRandomiser = Phaser.Math.Between(1,3)
        if (creepAnimationRandomiser == 1){
            creep.flipX = false
            creep.play('nightBorneMinion_Move',true)
        } else if (creepAnimationRandomiser == 2){
            creep.flipX = false
            creep.play('nightBorneMinion_Idle',true)
        } else if (creepAnimationRandomiser == 3){
            creep.flipX = true
            creep.play('nightBorneMinion_Idle',true)
        }
        
        var scaleXRandom = Phaser.Math.FloatBetween(1.9,2.3)
        var scaleYRandom = Phaser.Math.FloatBetween(0.9,1.35)
        creep.setScale(scaleXRandom,scaleYRandom)
    }

    function finish(){
        if (gameOver == false){
            gameOver = true
            camera.fadeOut(6000)
            camera.on('camerafadeoutcomplete', function () {
            gameOver = true
            bgMusic.stop()
            gameRestart = true
            

            }, this);
            
        }
        
    }

    function levelUp(){
        exp = 0
        level += 1
        toggleSkillTree()
        
        
        if (level > 10){
            income *= 1.05
        } 
            
        chaosMultiplierMin *= 1.1
        expToLevelUp *= 1.08
        playerExperience.p = (39.5 * playerVitals.scaleX) / expToLevelUp
        
        
    }

    function update ()
    {
        // Debugging and Testing Controls

            // Console

            var closest = this.physics.closest(player,enemies.getChildren()) 
            console.log(player.body.speed)

            gfx.clear()
            .lineStyle(2, 0xff3300)
            .lineBetween(closest.x, closest.y, player.x, player.y)

                if (Phaser.Input.Keyboard.JustDown(keyZ)){
                    
                    if (touchEnabled){
                        enableTouchControls(0)
                    } else {
                        enableTouchControls(1)
                    }

                }
            
        // General / Universal

            // Audio

                // Background Music

                bgMusic.once('complete', function(bgMusic){
                    songChoice = Math.floor(Phaser.Math.Between(1,10))
                        if (songChoice == 1){
                            this.load.audio("bgMusic1", ["assets/music/Le_château_magique.mp3"]);
                        } else if (songChoice == 2){
                            this.load.audio("bgMusic2", ["assets/music/Kids_See_Ghosts.mp3"]);
                        } else if (songChoice == 3){
                            this.load.audio("bgMusic3", ["assets/music/Riptide.mp3"]);
                        } else if (songChoice == 4){
                            this.load.audio("bgMusic4", ["assets/music/The_Apartment.mp3"]);
                        } else if (songChoice == 5){
                            this.load.audio("bgMusic5", ["assets/music/Katana.mp3"]);
                        } else if (songChoice == 6){
                            this.load.audio("bgMusic6", ["assets/music/Ludum_Dare_38_Track_2.wav"]);
                        } else if (songChoice == 7){
                            this.load.audio("bgMusic7", ["assets/music/Night_(Instrumental).mp3"]);
                        } else if (songChoice == 8){
                            this.load.audio("bgMusic8", ["assets/music/Smile.mp3"]);
                        } else if (songChoice == 9){
                            this.load.audio("bgMusic9", ["assets/music/Tripwire.mp3"]);
                        } else if (songChoice == 10){
                            this.load.audio("bgMusic10", ["assets/music/Gumshield.mp3"]);
                        }
                    bgMusic = this.sound.add("bgMusic" + songChoice, {volume: 0.75});
                    bgMusic.play()
                },this)  

  
            // Controls

            

                // Gamepad
                
                if (gamePadEnabled){

                    if (gamePad.leftStick.y < -0.5   && !playerIsHit && !playerAttacking && !playerJumping && !playerBlocking){ 
                        
                        if (player.body.onFloor()){
                            playerJumping = true
                            player.play({key:'pCrouch',frameRate:24},true)
                            player.once('animationcomplete',function(){
                                
                                player.play({key:'pJump',frameRate:18},true)
                                
                                //if(player.body.speed > 10){
                                    if (player.flipX){
                                    player.setVelocityX(-150)
                                } else {
                                    player.setVelocityX(150)
                                }
                                //}
                                
                                
                                player.setVelocityY(-300)
                                playerLanded = false
                            },player)
                        } 

                    } else if (gamePad.leftStick.y > 0.5   && !playerIsHit && !playerAttacking && !playerCrouching && !playerBlocking){ 
                        playerCrouching = true
                        if(player.body.speed > 15){
                            player.play({key:'pSlide',frameRate:14},true)
                        } else {
                            player.play({key:'pCrouch',frameRate:14},true)
                        }

                    } else if (gamePad.leftStick.x < -0.5 && gamePad.leftStick.y > -0.5 && gamePad.leftStick.y < 0.5 && !playerDodging && !playerIsHit && !playerAttacking && !playerBlocking){ 
                        // Left     
                                
                                player.body.maxVelocity.x = 250
                                if (playerLockedOn){
                                    nightBorneVFX.x = closest.x
                                    nightBorneVFX.setVisible(1)
                                    nightBorneVFX.play('playerLockOnIcon',true)
                                if(player.flipX == false){
                                    playerDodging = true
                                    fireTowardsTarget(player,player.x - 450,1)
                                    if(player.body.onFloor()){
                                        player.setVelocityY(-75)
                                    }
                                    
                                    player.play({key:'pBackDash',frameRate:8},true)
                                    player.once('animationcomplete', function (){
                                        
                                            playerDodging = false
                                        
                                         },player)
                                } else if (player.body.onFloor() && playerLanded) {
                                    player.play('pRun',true)
                                    player.setVelocityX(player.body.velocity.x - 35)
                                }
                                } else if (player.body.onFloor() && playerLanded) {
                                    nightBorneVFX.setVisible(0)
                                    player.flipX = true
                                    player.play('pRun',true)
                                    player.setVelocityX(player.body.velocity.x - 35) 
                                }
                         
                    } else if (gamePad.leftStick.x > 0.5 && gamePad.leftStick.y > -0.5 && gamePad.leftStick.y < 0.5 && !playerDodging && !playerIsHit && !playerAttacking && !playerBlocking){
                        // Right
                        player.body.maxVelocity.x = 250
                        

                        if (playerLockedOn){
                            nightBorneVFX.x = closest.x
                            nightBorneVFX.setVisible(1)
                                    nightBorneVFX.play('playerLockOnIcon',true)
                                if(player.flipX == true){
                                    playerDodging = true
                                    fireTowardsTarget(player,player.x + 450,1)
                                    if(player.body.onFloor()){
                                        player.setVelocityY(-75)
                                    }
                                    player.play({key:'pBackDash',frameRate:8},true)
                                    player.once('animationcomplete', function (){
                                        
                                            playerDodging = false
                                        
                                         },player)
                                    
                                } else if (player.body.onFloor() && playerLanded) {
                                    player.play('pRun',true)
                                    player.setVelocityX(player.body.velocity.x + 35)
                                }
                                } else if (player.body.onFloor() && playerLanded) {
                                    nightBorneVFX.setVisible(0)
                                    player.flipX = false
                                    player.play('pRun',true)
                                    player.setVelocityX(player.body.velocity.x + 35) 
                                }
                        

                    } else if (gamePad.leftStick.x <= 0.5 && gamePad.leftStick.x >= -0.5 && gamePad.leftStick.y <= 0.5 && gamePad.leftStick.y >= -0.5  && !playerJumping && !playerAttacking  && !playerBlocking && gameMode == 1 && controlsEnabled && !playerIsHit) { //
        
                        playerDodging = false
                        playerCrouching = false

                        player.play('pIdle',true)

                    } 
            
                    gamePad.on('down', function (button) {

                        // Up = 12, Down = 13
                    // Left = 14; Right = 15
                    // LT = 6 ; RT = 7 
                    // LB = 4 ; RB = 5
                    // A = 0
                    // B = 1
                    // X = 2
                    // Y = 3
                    // Back = 8 ; Start = 9
                    // LS = 10 ; RS = 11 

                        if (button == 2){
                            if(!inBattle){
                                enemyChase(1000)
                            } else {
                                nightBorne.setVelocityY(-200)
                            }
                            

                        } else if (button == 1){

                            if (skillTreeOpen){
                                var tier = storingBuffTier += 1
                                income *= 1.025
                                maxLife *= 1.05
                                lifeRegenAllocation += 0.05

                                if (tier >= 5){
                                    tier = 5
                                    var alpha = 1
                                } else if (tier == 0){
                                    var alpha = 0.5
                                    tier = 1
                                } else {
                                    var alpha = 1
                                }

                                playerVitals.pL = (39.5 * playerVitals.scaleX) / maxLife
                                playerVitals.draw()
                                playerMiniVitals.pL = (38 * playerMiniVitals.scaleX) / maxLife

                                toggleSkillTree()
                            }

                        } else if (button == 3){

                            if (skillTreeOpen){
                                var tier = growingBuffTier += 1
                                income *= 1.025
                                focusRegenAllocation *= 1.20
                                focusRegenAllocation += 0.01
                                maxFocus *= 1.1

                                if (tier >= 5){
                                    tier = 5
                                    var alpha = 1
                                } else if (tier == 0){
                                    var alpha = 0.5
                                    tier = 1
                                } else {
                                    var alpha = 1
                                }
                                
                                playerVitals.pF = (39.5 * playerVitals.scaleX) / maxFocus
                                playerVitals.draw()
                                playerMiniVitals.pF = (38 * playerMiniVitals.scaleX) / maxFocus

                                toggleSkillTree()
                            }

                        } else if (button == 0){
                        
                            if (skillTreeOpen){
                                var tier = spendingBuffTier
                                income *= 1.025
                                energyRegenAllocation *= 1.30
                                energyRegenAllocation += 0.01
                                maxEnergy *= 1.15
                                tier = spendingBuffTier += 1

                                if (tier >= 5){
                                    tier = 5
                                    var alpha = 1
                                } else {
                                    var alpha = 1
                                }

                                playerVitals.pE = (39.5 * playerVitals.scaleX) / maxEnergy
                                playerVitals.draw()
                                playerMiniVitals.pE = (38 * playerMiniVitals.scaleX) / maxEnergy

                                toggleSkillTree()
                            }
                        } else if (button == 8){
                            finish()
                        

                        } else if (button == 7){

                            keyA.isDown = true
                            regenActive = false

                            if(inBattle){

                                attackModeActive = true
                                usingPower = true
                                playerBlocking = false
                                playerDodging = false
                               
                            } else {
                                var attackChoice = Phaser.Math.Between(1,2)

                                if(attackChoice == 1){
                                    player.play({key:'pDash',frameRate:18},true)
                                    fireTowardsTarget(player,player.x + 100,1)
                                    player.setVelocityY(Phaser.Math.Between(-125,-150))
                                    player.once('animationcomplete',function(){
                                        player.play({key:'pHeavyAttack',frameRate:16},true)
                                        player.setVelocityY(Phaser.Math.Between(100,150))
                                        player.once('animationcomplete',function(){
                                            player.play({key:'pRun',repeat:-1},true)
                                    },this)
                                    },this)
                                    
                                } else if (attackChoice == 2) {
                                        player.play('pDash',true)
                                        fireTowardsTarget(player,player.x + 100,1)
                                        player.setVelocityY(Phaser.Math.Between(-75,-100))
                                        player.once('animationcomplete',function(){
                                        player.play('pAttack2',true)
                                        player.setVelocityY(Phaser.Math.Between(-100,-150))
                                        player.once('animationcomplete',function(){
                                        player.play({key:'pRun',repeat:-1},true)
                                    },this)
                                    },this)
                                        
                                }
                            }
                            
                        } else if (button == 5){
                            cursors.space.isDown = true
                            regenActive = false

                            if(inBattle){
                                attackModeActive = true
                                usingPower = true
                                playerBlocking = false
                                playerDodging = false
                            } else {
                                focusModeActive = true
                                scanningForDanger = true
                            }
                        } else if (button == 6){
                            // OR BLOCK IS AUTO IF NO BUTTONS PRESSED?
                            regenActive = false

                            if(inBattle){
                                if(!playerBlocking && !playerIsHit && !playerAttacking){
                                    
                                    
                                    player.play({key:'pBlock'},true)
                                        
                                    playerBlocking = true
                                    playerDodging = false


                                }
                            }
                            
                        } else if (button == 4){
                
                            if(inBattle){
                                if(playerStance == 1){
                                playerStance = 2
                                } else if (playerStance == 2)  {
                                    playerStance = 3
                                } else if (playerStance == 3)  {
                                    playerStance = 4
                                } else if (playerStance == 4)  {
                                    playerStance = 1
                                }
                            }
                            
                        }

                       

                    }, this);

                    gamePad.on('up', function (button) {
                        // Up = 12, Down = 13
                        // Left = 14; Right = 15
                        // LT = 6 ; RT = 7 
                        // LB = 4 ; RB = 5
                        // A = 0
                        // B = 1
                        // X = 2
                        // Y = 3
                        // Back = 8 ; Start = 9
                        // LS = 10 ; RS = 11 
                        if (button == 7){
                            
                            keyA.isDown = false
                            sword.body.checkCollision.none = true
                            regenActive = true
                                // player.once('animationcomplete',function(){
                                //     player.play('pIdle',true)
                                // },player)

                            if(inBattle){
                                playerAttacking = false
                                attackModeActive = false
                                usingPower = false
                            }
                    
                        } else if (button == 5){
                            cursors.space.isDown = false
                            regenActive = true
                            
                                player.stop()
                                player.play('pBackDash',true)

                                player.once('animationcomplete',function(){
                                    player.play('pIdle',true)
                                },player)

                                //fireTowardsTarget(player, player.x + 125,1)
                            


                            if(inBattle){
                                playerAttacking = false
                                attackModeActive = false
                                usingPower = false
                            } else {
                                playerFocusing = false
                                focusModeActive = false
                                scanningForDanger = false
                            }
                        } else if (button == 6){
                            
                            regenActive = true

                            if(inBattle){
                               
                                    
                                    
                                    
                                        
                                    playerBlocking = false
                                    


                                //}
                            }
                            
                        }

                    }, this);
                }
               
                // Touch Controls
                    
                    
                    left.on('pointerdown', function(){

                        leftIsDown = true

                    })

                    if(leftIsDown){
                        if(!playerDodging && !playerIsHit && !playerAttacking && !playerBlocking){
                            
                            if (playerLockedOn){
                                nightBorneVFX.x = closest.x
                                nightBorneVFX.setVisible(1)
                                nightBorneVFX.play('playerLockOnIcon',true)
                            if(player.flipX == false){
                                playerDodging = true
                                fireTowardsTarget(player,player.x - 450,1)
                                if(player.body.onFloor()){
                                    player.setVelocityY(-75)
                                }
                                
                                player.play({key:'pBackDash',frameRate:8},true)
                                player.once('animationcomplete', function (){
                                    
                                        playerDodging = false
                                    
                                        },player)
                            } else if (player.body.onFloor() && playerLanded) {
                                player.play('pRun',true)
                                player.setVelocityX(player.body.velocity.x - 35)
                            }
                            } else if (player.body.onFloor() && playerLanded) {
                                nightBorneVFX.setVisible(0)
                                player.flipX = true
                                player.play('pRun',true)
                                player.setVelocityX(player.body.velocity.x - 35) 
                            }
                        }
                    }

                    left.on('pointerup', function(){

                        leftIsDown = false

                        if(!playerJumping && !playerAttacking  && !playerBlocking && gameMode == 1 && controlsEnabled && !playerIsHit){

                            playerDodging = false
                            playerCrouching = false

                            player.play('pIdle',true)
                        }
                    })

                    right.on('pointerdown', function(){

                        rightIsDown = true

                        
                    })

                    if(rightIsDown){
                        if(!playerDodging && !playerIsHit && !playerAttacking && !playerBlocking){

                            player.body.maxVelocity.x = 250

                            if (playerLockedOn){
                                nightBorneVFX.x = closest.x
                                nightBorneVFX.setVisible(1)
                                        nightBorneVFX.play('playerLockOnIcon',true)
                                    if(player.flipX == true){
                                        playerDodging = true
                                        fireTowardsTarget(player,player.x + 450,1)
                                        if(player.body.onFloor()){
                                            player.setVelocityY(-75)
                                        }
                                        player.play({key:'pBackDash',frameRate:8},true)
                                        player.once('animationcomplete', function (){
                                            
                                                playerDodging = false
                                            
                                            },player)
                                        
                                    } else if (player.body.onFloor() && playerLanded) {
                                        player.play('pRun',true)
                                        player.setVelocityX(player.body.velocity.x + 35)
                                    }
                            } else if (player.body.onFloor() && playerLanded) {
                                nightBorneVFX.setVisible(0)
                                player.flipX = false
                                player.play('pRun',true)
                                player.setVelocityX(player.body.velocity.x + 35) 
                            }
                            }
                    }

                    right.on('pointerup', function(){

                        rightIsDown = false

                        if(!playerJumping && !playerAttacking  && !playerBlocking && gameMode == 1 && controlsEnabled && !playerIsHit){

                            playerDodging = false
                            playerCrouching = false

                            player.play('pIdle',true)
                        }
                    })

                    up.on('pointerdown', function(){

                        

                        if(!playerIsHit && !playerAttacking && !playerJumping && !playerBlocking){

                        if (player.body.onFloor()){
                            playerJumping = true
                            player.play({key:'pCrouch',frameRate:24},true)
                            player.once('animationcomplete',function(){
                                
                                player.play({key:'pJump',frameRate:18},true)
                                
                                if(player.body.speed > 10){
                                    if (player.flipX){
                                    player.setVelocityX(-150)
                                } else {
                                    player.setVelocityX(150)
                                }
                                }
                                
                                
                                player.setVelocityY(-300)
                                playerLanded = false
                            },player)
                        } 
                        }

                        
                    })

                    up.on('pointerup', function(){

                        

                        if(!playerJumping && !playerAttacking  && !playerBlocking && gameMode == 1 && controlsEnabled && !playerIsHit){

                            playerDodging = false
                            playerCrouching = false

                            player.play('pIdle',true)
                        }
                    })

                    down.on('pointerdown', function(){

                        

                        if(!playerIsHit && !playerAttacking && !playerJumping && !playerBlocking){

                        playerCrouching = true
                        if(player.body.speed > 15){
                            player.play({key:'pSlide',frameRate:14},true)
                        } else {
                            player.play({key:'pCrouch',frameRate:14},true)
                        }
                        }

                        
                    })

                    down.on('pointerup', function(){


                        if(!playerJumping && !playerAttacking  && !playerBlocking && gameMode == 1 && controlsEnabled && !playerIsHit){
                            playerDodging = false
                            playerCrouching = false

                            player.play('pIdle',true)
                        }
                    })

                    defaultAction.on('pointerdown', function (button) {

                            keyA.isDown = true
                            regenActive = false

                            if(inBattle){

                                attackModeActive = true
                                usingPower = true
                                playerBlocking = false
                                playerDodging = false
                            
                            } else {
                                var attackChoice = Phaser.Math.Between(1,2)

                                if(attackChoice == 1){
                                    player.play({key:'pDash',frameRate:18},true)
                                    fireTowardsTarget(player,player.x + 100,1)
                                    player.setVelocityY(Phaser.Math.Between(-125,-150))
                                    player.once('animationcomplete',function(){
                                        player.play({key:'pHeavyAttack',frameRate:16},true)
                                        player.setVelocityY(Phaser.Math.Between(100,150))
                                        player.once('animationcomplete',function(){
                                            player.play({key:'pRun',repeat:-1},true)
                                    },this)
                                    },this)
                                    
                                } else if (attackChoice == 2) {
                                        player.play('pDash',true)
                                        fireTowardsTarget(player,player.x + 100,1)
                                        player.setVelocityY(Phaser.Math.Between(-75,-100))
                                        player.once('animationcomplete',function(){
                                        player.play('pAttack2',true)
                                        player.setVelocityY(Phaser.Math.Between(-100,-150))
                                        player.once('animationcomplete',function(){
                                        player.play({key:'pRun',repeat:-1},true)
                                    },this)
                                    },this)
                                        
                                }
                            }

                        }, this);

                    defaultAction.on('pointerup', function (button) {

                        keyA.isDown = false
                        sword.body.checkCollision.none = true
                        regenActive = true
                            // player.once('animationcomplete',function(){
                            //     player.play('pIdle',true)
                            // },player)

                        if(inBattle){
                            playerAttacking = false
                            attackModeActive = false
                            usingPower = false
                        }


                    }, this);

                    dAction.on('pointerdown', function (button) {
                        
                        regenActive = false

                        if(inBattle){
                            if(!playerBlocking && !playerIsHit && !playerAttacking){
                                
                                
                                player.play({key:'pBlock'},true)
                                    
                                playerBlocking = true
                                playerDodging = false


                            }
                        }


                    }, this);

                    dAction.on('pointerup', function (button) {

                    regenActive = true

                    if(inBattle){

                                
                            playerBlocking = false
                            player.play('pIdle',true)

                    }

                    }, this);

                    charge.on('pointerdown', function (button) {


                    
                        cursors.space.isDown = true
                        regenActive = false

                        if(inBattle){
                            attackModeActive = true
                            usingPower = true
                            playerBlocking = false
                            playerDodging = false
                        } else {
                            focusModeActive = true
                            scanningForDanger = true
                        }
                    

                    }, this);

                    charge.on('pointerup', function (button) {
              
                    
                    cursors.space.isDown = false
                    regenActive = true

                        player.stop()
                        player.play('pBackDash',true)

                        player.once('animationcomplete',function(){
                            player.play('pIdle',true)
                        },player)

                        //fireTowardsTarget(player, player.x + 125,1)



                    if(inBattle){
                        playerAttacking = false
                        attackModeActive = false
                        usingPower = false
                    } else {
                        playerFocusing = false
                        focusModeActive = false
                        scanningForDanger = false
                    }

                     

                    }, this);

                    // dCharge.on('down', function (button) {

                    // if (button == 5){
                    //     cursors.space.isDown = true
                    //     regenActive = false

                    //     if(inBattle){
                    //         attackModeActive = true
                    //         usingPower = true
                    //         playerBlocking = false
                    //         playerDodging = false
                    //     } else {
                    //         focusModeActive = true
                    //         scanningForDanger = true
                    //     }
                    // } 

                    // }, this);

                    // dCharge.on('up', function (button) {
                    // if (button == 5){
                    // cursors.space.isDown = false
                    // regenActive = true

                    //     player.stop()
                    //     player.play('pBackDash',true)

                    //     player.once('animationcomplete',function(){
                    //         player.play('pIdle',true)
                    //     },player)

                    //     //fireTowardsTarget(player, player.x + 125,1)



                    // if(inBattle){
                    //     playerAttacking = false
                    //     attackModeActive = false
                    //     usingPower = false
                    // } else {
                    //     playerFocusing = false
                    //     focusModeActive = false
                    //     scanningForDanger = false
                    // }
                    // }

                    // }, this);


           // NightBorne
           
               // NightBorne Elite

                    // NightBorne outline follows NightBorne
                        nightBorneOutline.x = nightBorne.x - 2.5
                        nightBorneOutline.y = nightBorne.y - 135

                    // NightBorne outline copies current playing animation of necromancer sprite, with optional delay
                        nightBorneOutline.play({key:nightBorne.anims.getName(),frameRate:Phaser.Math.Between(8,16)},true) 

                    // Necromancer

                    // Necromancer outline follows necromancer
                    
                        nightBorneNecromancerOutline.x = nightBorneNecromancer.x - 2.5
                        nightBorneNecromancerOutline.y = nightBorneNecromancer.y - 10

                    // Necormancer outline copies current playing animation of necromancer sprite, with optional delay
                        nightBorneNecromancerOutline.play({key:nightBorneNecromancer.anims.getName(),frameRate:Phaser.Math.Between(8,16)},true)

        // Travel Mode
        if (gameMode == 0){

            // Game Variables

            playerSpeed = player.x / (width * 1.25)

            // Background 

                // Parallax Background layers scrolls at variable speed multiplied by playerSpeed %
                woodsl2.tilePositionX += 1.5 * (playerSpeed)
                woodsl3.tilePositionX += 3 * (playerSpeed)
                woodsl4.tilePositionX += 4.5 * (playerSpeed)

            // Touch Control Screen Tracking

                // Anchor Buttons
                left.x = camera.scrollX + (width * 0.05)
                left.y = camera.scrollY + (height - 90)
                defaultAction.x = camera.scrollX + (width * 0.925)
                defaultAction.y = camera.scrollY + (height - 136)
                charge.x = camera.scrollX + (width * 0.825) 
                charge.y = camera.scrollY + (height - 76)
                
                // Remaining Buttons                        
                deadSpace.x = left.x + 35.5
                deadSpace.y =left.y
                right.x = deadSpace.x + 35.5
                right.y = deadSpace.y
                up.x = deadSpace.x
                up.y = deadSpace.y - 40.5
                down.x = deadSpace.x
                down.y = left.y + 40.5   

            // NightBorne

                // NightBorne Elite

                    

                // Necromancer

                    //  Necromancer follows behind NightBorne Elite at constant distance

                    nightBorneNecromancer.x = nightBorne.x - 55
                    nightBorneNecromancer.y = nightBorne.y - 175


        // Battle Mode

        } else if (gameMode == 1){
            // Temp 
                // Touch Control Screen Tracking

                // Anchor Buttons
                left.x = camera.scrollX + (width * 0.075)
                left.y = camera.scrollY + (height - 90)
                defaultAction.x = camera.scrollX + (width * 0.9)
                defaultAction.y = camera.scrollY + (height - 70)
                dAction.x = defaultAction.x - 65
                dAction.y = camera.scrollY + (height - 45)
                charge.x = defaultAction.x
                charge.y = camera.scrollY + (height - 135)
                dSkill.x = dAction.x
                dSkill.y = dAction.y - 65

                // Remaining Buttons                        
                deadSpace.x = left.x + 35.5
                deadSpace.y =left.y
                right.x = deadSpace.x + 35.5
                right.y = deadSpace.y
                up.x = deadSpace.x
                up.y = deadSpace.y - 40.5
                down.x = deadSpace.x
                down.y = left.y + 40.5 

                // Drag Settings & Arena Border / Dead Zones 
                // TO BE DELETED AND REPLACED WITH BATTLE MODE REBUILD
                // Set player drag based on if in air or on ground

                if (player.body.onFloor()){
                    player.setDragX(750)
                } else {
                    player.setDragX(150)
                }

                if (support.body.onFloor()){
                    support.setDragX(300)
                } else {
                    support.setDragX(100)
                }

                // EITHER A) RELY ON AREA BORDER or B) TO BE REPLACED WITH DEADZONE OVERLAP OBJECT AROUND BATTLE AREA or C) BOTH
                // Stop player if sliding past anhor point

                // if (player.x > width * 1.8){

                //     player.setVelocityX(0)
                //     player.x = width * 1.79
                // }

                if (support.x > width * 1.85){

                    support.setVelocityX(0)
                    support.x = width * 1.85
                }

                // Stop nightBorne if sliding past anhor point


                // NightBorne

                // INTEGRATE WITH NIGHTBORNEHIT FUNCTION
                    // Enemy detects collision with player sword

                    if (nightBorneIsHit){
                        nightBorne.play({key:'nightBorne_Hurt',frameRate: 12},true); 
                        nightBorne.once('animationstart', function(){
                            if (player.flipX){
                                nightBorne.setVelocity(-Phaser.Math.Between(50,150),-Phaser.Math.Between(50,200))
                                
                                
                            } else {
                                nightBorne.setVelocity(Phaser.Math.Between(50,150),-Phaser.Math.Between(50,200))
                            }
                            // if(nightBorne.body.onFloor()){
                            //     nightBorne.setVelocityY(-Phaser.Math.Between(50,200))
                            // }
                        }, nightBorne)
                        nightBorne.once('animationcomplete', function () {
                                
                            nightBorneRecover();
                                
                                
                            }, this);
                    }

                    // INTEGRATE WITH NIGHTBORNEHIT FUNCTION
                    // Check for enemy death

                    if (nightBorneLife <= 0 && !nightBorneIsHit){
                        nightBorne.anims.play({key:'nightBorne_Death',frameRate: 23},true);
                        
                        
                                    
                        nightBorne.once('animationcomplete', function (anim,frame) {

                                    
                                        nightBorne.x = 0
                                        nightBorneMaxLife = Phaser.Math.Between(income * 0.8, (income * 0.8) * chaosFactor) 
                                        nightBorneLife = nightBorneMaxLife
                                        nightBorneVitals.p = 38 / nightBorneMaxLife
                                        modeSwitch(0)
                                        
                        }, nightBorne)
                    }

                    
            
            // Background 

                // Parallax Background layers scrolls at variable speed
                woodsl2.tilePositionX = (camera.x * 0.3) 
                woodsl3.tilePositionX = (camera.x * 0.65) 
                woodsl4.tilePositionX = (camera.x)
        }


         // Move to "Start NightBorne Battle" function
        if (inBattle){
           
            if(startNecroFloat){
                startNecroFloat = false
            this.tweens.add({
                                    targets     : [nightBorneNecromancer],
                                    x       : nightBorne.x - 75, 
                                    ease        : 'Quad.easeIn',
                                    duration    : 12000,
                                    yoyo        : 1,
                                    repeat      : -1
            });
            this.tweens.add({
                                    targets     : [nightBorneNecromancer],
                                    y       : nightBorne.y - 230, 
                                    ease        : 'Power2',
                                    duration    : 7500,
                                    yoyo        : 1,
                                    repeat      : -1
                                    
            });
        }

        } 


        // REPLACE WITH CASE: FORMAT FOR CLEANER CODE, ADD ALL TO BATTLE MODE SECTION ONLY AND PLAYER ONLY VERSION TO RUNNING MODE
        // Support

        if (support.anims.getName() == 'sShoot'){
                    //playerSwordSwing.play()
                    
                    if (support.anims.currentFrame.index >= 7 && !nightBorneIsHit){
                        
                        supportArrow.setVisible(1)
                        if(support.x > nightBorne.x){
                        supportArrow.body.setVelocityX(-350 * supportArrowSpeedMultiplier)
                        } else {
                            supportArrow.body.setVelocityX(350 * supportArrowSpeedMultiplier)
                        }
                    } else {
                        sword.body.checkCollision.none = true
                    }

                    if (supportArrow.visible){
                        supportArrow.body.checkCollision.none = false
                    } else {
                        supportArrow.body.checkCollision.none = true
                    }

        } 
        
        // Enable player sword collision detection
        if (player.anims.getName() == 'pDoubleAttack'){
                    playerSwordSwing.play()
                    
                    

                    if (player.anims.currentFrame.index >= 6 && player.anims.currentFrame.index < 12){
                        
                        sword.body.checkCollision.none = false
                        damage = 0.05 * maxEnergy *  baseDamageMultiplier
                    } else {
                        sword.body.checkCollision.none = true
                    }

        } if (player.anims.getName() == 'pAttack1'){
                    playerSwordSwing.play()
                    
                    

                    if (player.anims.currentFrame.index >= 6 && player.anims.currentFrame.index < 8){
                        
                        sword.body.checkCollision.none = false
                        damage = 0.1 * maxEnergy * baseDamageMultiplier
                    } else {
                        sword.body.checkCollision.none = true
                    }
        } else if (player.anims.getName() == 'pAttack2'){
                    playerSwordSwing.play()
                    
                    

                    if (player.anims.currentFrame.index >= 2 && player.anims.currentFrame.index < 3){
                        
                        sword.body.checkCollision.none = false
                        damage = 0.1 * maxEnergy  * baseDamageMultiplier
                    } else {
                        sword.body.checkCollision.none = true
                    }
        } else if (player.anims.getName() == 'pHeavyAttack'){
                    playerHeavySwordSwing.play()

                      
                    if (player.anims.currentFrame.index >= 4 && player.anims.currentFrame.index < 6){
                        
                    sword.body.checkCollision.none = false
                    damage =  0.15 * maxEnergy * baseDamageMultiplier
                    } else {
                        sword.body.checkCollision.none = true
                    }
        
        }

        if (nightBorne.anims.getName() == 'nightBorne_Attack'){
                enemySwordSwing.play()
                    
                    if (nightBorne.anims.currentFrame.index >= 10 && nightBorne.anims.currentFrame.index < 12){
                        
                         nightBorneSword.body.checkCollision.none = false
            
                    } else {
                         nightBorneSword.body.checkCollision.none = true
                    }
        }


        if (gameRestart){
            reset()
            this.scene.restart()
            gameRestart = false
            gameOver = false
        }

        playerExperience.draw()

        if (!inBattle){
            
            playerIcon.x = camera.scrollX + (width * 0.075)
            playerIcon.y = camera.scrollY + 40
        } else {
            playerIcon.x = camera.scrollX + 60
            playerIcon.y = camera.scrollY + 50
  
        }

        playerIconBox.x = playerIcon.x - 37.5
        playerIconBox.y = playerIcon.y
        
        levelIcon.x = playerIcon.x + 70
        levelIcon.y = playerIcon.y
        levelText.x = levelIcon.x + 50
        levelText.y = levelIcon.y
        levelText.setText(Math.floor(level))

        activeSkillBox.x = levelText.x + 40
        activeSkillBox.y = levelText.y

        playerVitals.x = levelText.x + 45
        playerVitals.y = playerIcon.y - 20
        playerVitals.draw()
 
        gloryIcon.x = camera.scrollX + (width * 0.8)
        gloryIcon.y = playerIcon.y - 20
        gloryText.x = gloryIcon.x + 30
        gloryText.y = gloryIcon.y - 20
        gloryText.setText(Math.floor(glory))

        goldIcon.x = gloryIcon.x
        goldIcon.y = playerIcon.y + 20
        goldText.x = goldIcon.x + 30
        goldText.y = goldIcon.y - 20
        goldText.setText(Math.floor(gold))

        playerExperience.x = activeSkillBox.x
        playerExperience.y = camera.scrollY + (height * 0.85)

        skillIcon.x = activeSkillBox.x + 5
        skillIcon.y = activeSkillBox.y

        skillNameText.x = skillIcon. x + 42.5
        skillNameText.y = activeSkillBox.y - 7.5


        skillTreeLifeIcon.x = camera.scrollX + (width * 0.25)
        skillTreeFocusIcon.x = camera.scrollX + (width * 0.5)
        skillTreeEnergyIcon.x = camera.scrollX + (width * 0.75)
        

        if (exp >= expToLevelUp){
            glory += (100 / 60) * 10
            levelUp()

        }

        refreshStats()


        if (nightBorne.flipX){
            nightBorneSword.x = nightBorne.x - 50
            nightBorneSword.y = nightBorne.y - 125
        } else {
            nightBorneSword.x = nightBorne.x + 50
            nightBorneSword.y = nightBorne.y - 125
        }

        //eSword.body.checkCollision.none = true

        nightBorneVitals.x = nightBorne.x + 30
        nightBorneVitals.y = nightBorne.y - 100
        nightBorneVitals.draw()

        playerMiniVitals.x = player.x + 30
        playerMiniVitals.y = player.y - 20
        playerMiniVitals.draw()

        
            if (player.flipX){
                sword.x = player.x - 10
                sword.y = player.y - 15
            } else {
                sword.x = player.x + 10
                sword.y = player.y - 15
            }

            if (!supportArrow.visible){
                
            if (support.flipX){
                supportArrow.flipX = true
                supportArrow.x = support.x - 94
                
            } else {
                supportArrow.flipX = false
                supportArrow.x = support.x + 30
            
            }
                supportArrow.y = support.y - 12.5
                supportArrow.body.checkCollision.none = true
            }   

            chaosFactor = Phaser.Math.FloatBetween(chaosMultiplierMin,chaosMultiplierMax)

        if (inBattle == false){

            if(cursors.space.isDown){

            if (currentFocus  > 0){
            playerFocusing = true



            playerSpeed = 0.5
            vines.body.checkCollision.none = true

                treeTrunk.body.checkCollision.none = true
                
                if (Phaser.Input.Keyboard.JustDown(cursors.space)){

                    focusModeActive = true
                    scanningForDanger = true
                }
                if(focusModeActive){
                    runFocusMode()
                }
            } else {
                playerFocusing = false
                
                
            }



            } else if (Phaser.Input.Keyboard.JustUp(cursors.space)){
            player.stop()
            playerFocusing = false
            focusModeActive = false
            scanningForDanger = false
            }

            charge.once('pointerdown',function(){
            focusModeActive = true
            scanningForDanger = true
            },this)

            charge.once('pointerup',function(){
            player.stop()
            playerFocusing = false
            focusModeActive = false
            scanningForDanger = false
            },this)

            charge.once('pointerout',function(){
            player.stop()
            playerFocusing = false
            focusModeActive = false
            scanningForDanger = false
            },this)

            if (!playerFocusing && keyA.isUp){
            // playerSpeed = player.x / (width * 1.2)
            player.setTintFill()
            spotlight.intensity = 0.5
            spotlight.setColor(0xffffff)
            spotlight.x = player.x
            spotlight.y = player.y
   
            
        }

            // Anchor buttons


                                this.tweens.add({
                                    targets     : [skillIcon,skillNameText],
                                    alpha       : 0,
                                    ease        : 'Linear',
                                    duration    : 50,
            });


            this.tweens.add({
                                    targets     : [playerExperience.bg, playerExperience.experienceBar],
                                    alpha       : 1,
                                    
                                    ease        : 'Linear',
                                    duration    : 1000,
            })


            // Dynamic Panning based on nightBorne distance to player
            if (nightBorneCam){
            if (nightBorne.x <= width * 0.85){
                camera.pan(width * 1.5,0,1250) 
            } else {
                camera.pan(width * 1.3,0,2500)
            }
        }

        } else if (inBattle) {

            
            spotlight.intensity = 0.5

            spotlight.x = player.x
            spotlight.y = player.y

            playerExperience.x = camera.scrollX + width * 0.3
            playerExperience.y = camera.scrollY + (height * 0.85)

                        this.tweens.add({
                                    targets     : [playerExperience.bg, playerExperience.experienceBar],
                                    alpha       : 0,
                                    ease        : 'Linear',
                                    duration    : 50,
                        })


                this.tweens.add({
                                    targets     : [skillIcon,skillNameText],
                                    alpha       : 1,
                                    ease        : 'Linear',
                                    duration    : 1000,
                });


            // Enables Player and nightBorne to automatically face each other
            if(Math.abs(player.x - closest.x) <= 150){
                playerLockedOn = true
                if(player.x < closest.x){
                    player.flipX = false
                    closest.flipX = true
                } else {
                    player.flipX = true
                    closest.flipX = false
                }
            } else {
                playerLockedOn = false
            }

        }

        if (inBattle == false){

            if (skillTreeOpen){
                vines.body.checkCollision.none = true
                treeTrunk.body.checkCollision.none = true
            } else if(!playerFocusing) {
                vines.body.checkCollision.none = false
                treeTrunk.body.checkCollision.none = false
            }


            if (nightBorne.x > width * Phaser.Math.FloatBetween(1.3,1.4) && player.x > width * 1.4){
                nightBorne.setVelocityX(nightBorne.body.velocity.x - 10)
            }

            nightBorneNecromancer.play({key:'nightBorneNecromancer_Idle',frameRate: 8 * playerSpeed},true)
            nightBorne.play({key:'nightBorne_Move',frameRate: 8 * playerSpeed},true)
   
 
            moveVines(vines, 4 * (playerSpeed))

            moveTreeTrunk(treeTrunk, 4.5 * (playerSpeed))

            if(creep.anims.getName() == 'nightBorneMinion_Move'){
                moveCreep(6 * (playerSpeed))
            } else if (creep.anims.getName() == 'nightBorneMinion_Idle') {
                moveCreep(3 * (playerSpeed))
            } else {
                moveCreep(4 * (playerSpeed))
            }
            

            

            
            
            if (playerIsHit){ 
                
                playerHitAnimation()
            } else if (cursors.up.isDown && currentEnergy > (income * 0.2) && !playerIsHit && player.body.onFloor()){ 

                playerVitals.decreaseEnergy(income * 0.2)
                

                //if(Phaser.Input.Keyboard.JustDown(cursors.up)){
                    player.chain([{key:'pJump',frameRate: 12},true,{key:'pUptoFall',frameRate: 12}],true); 
                    support.play('sJump',true)
                    this.physics.moveTo(player,width * 1.45,75)
                    player.setVelocityY(-215)
                    player.setVelocityX(75)
                    support.setVelocityY(-205)
                    support.setVelocityX(100)
                    nightBorne.setVelocityX(nightBorne.body.velocity.x + 50)
                    
                //}

  

                
            } else if (keyA.isDown && currentEnergy > (income * 0.05) && playerIsHit == false){

                // Running Attack

                if (Phaser.Input.Keyboard.JustDown(keyA)){
                    var attackChoice = Phaser.Math.Between(1,2)
                }

                playerVitals.decreaseEnergy(income * 0.005)

                if (player.body.onFloor()){
                    if(attackChoice == 1){
                        player.play({key:'pDash',frameRate:18},true)
                        fireTowardsTarget(player,player.x + 100,1)
                        player.once('animationcomplete',function(){
                            player.play({key:'pDoubleAttack',frameRate:18},true)
                            player.once('animationcomplete',function(){
                                player.play({key:'pRun',repeat:-1},true)
                        },this)
                        },this)
                    
                   
                    } else if (attackChoice == 2) {
                        player.play({key:'pDash',frameRate:18},true)
                        fireTowardsTarget(player,player.x + 100,1)
                        player.once('animationcomplete',function(){
                        player.play('pAttack2',true)
                        player.once('animationcomplete',function(){
                            player.play({key:'pRun',repeat:-1},true)
                        },this)
                    },this)
                        
                    }
                } else if (!player.body.onFloor()) {
                    if (attackChoice == 1 || attackChoice == 2) {
                    player.play({key:'pDash',frameRate:18},true)
                    fireTowardsTarget(player,player.x + 75,2)
                    player.once('animationcomplete',function(){
                            player.play({key:'pHeavyAttack',frameRate:12},true)
                            //fireTowardsTarget(player,player.x + 75,2)
                            player.setVelocityY(Phaser.Math.Between(150,175))
                            player.once('animationcomplete',function(){
                              
                                player.play({key:'pRun',repeat:-1},true)
                            },this)
                    },player)
                    }
                }
                


                playerSpeed = 0.9

            
                
                enemyChase(Phaser.Math.FloatBetween(-5,+ 1))
                
                
               
                
                
            } else if (cursors.space.isDown && playerIsHit == false){
                
                playerVitals.decreaseFocus((income) / 50)
                if(currentFocus > 0){
                vines.body.checkCollision.none = true

                treeTrunk.body.checkCollision.none = true


                enemyChase(Phaser.Math.FloatBetween(-5,1))
                }
                
                
                
                
            } else if (downIsDown && currentEnergy > ((income * 0.15)) && player.body.onFloor()){

                vines.body.checkCollision.none = true
 
                playerVitals.decreaseEnergy((income * 0.25) / 25)
                

                

                player.anims.play({key:'pSlide',frameRate: 6},true);
                support.play('sRoll',true)

                this.physics.moveTo(player,width * 1.25,height - 90,30)
            
            } else if (leftIsDown && currentFocus > ((income * 0.25) / 50 ) && !playerIsHit && player.body.onFloor() && currentLife < maxLife){

                
                
                    playerVitals.decreaseFocus((income * 0.25) / 100 )
                    playerVitals.decreaseLife(-(income * 0.25)  / 50 )
                    enemyChase(4)
                

                this.physics.moveTo(player,width * 1.1,height - 90,90)
                player.anims.play({key:'pRun',frameRate: 8},true);
                
            } else if (rightIsDown && currentEnergy > ((income * 0.25) / 50 ) && playerIsHit == false && player.body.onFloor()){

                
                playerVitals.decreaseEnergy((income * 0.25) / 50)
                this.physics.moveTo(player,width * 1.75,height - 90,90)
                player.anims.play({key:'pRun',frameRate: 16},true);
                enemyChase(Phaser.Math.FloatBetween(-5,-2))
                glory += (5 / 60)
        
                 
            } else if(!playerIsHit) {

                player.body.checkCollision.none = false
                sword.body.checkCollision.none = true
                

                if (!playerFocusing){
                if (player.body.onFloor()){
                    if(skillTreeOpen){
                        this.physics.moveTo(player,width * 1.5,height - 90,150)
                    } else {
                       this.physics.moveTo(player,width * 1.25,height - 90,150)
                       this.physics.moveTo(support,width * 1.1,height - 90,150)
                    }
                    
                    player.anims.play({key:'pRun',frameRate: 12},true);
                    this.physics.moveTo(player,width * 1.25,height - 90,90)
                        support.play('sRun',true)
                    
                    
                }
                }
                
 

            }

        } else if (inBattle) {
            // In Battle Mode

            // Players crouch animation when player lands back on ground
            if (!playerLanded){
                if(player.body.deltaY() > 0 && player.body.onFloor()){
                        player.play({key:'pCrouch',frameRate:18},true);

                        player.once('animationcomplete', function () {

                        playerLanded = true
                        playerJumping = false
                        
                        player.play({key:'pIdle'},true);

                        }, this);

                        
                }
            }

        

            if (currentLife <= 0 && gameOver == false){
                //gameOver = true
                playerTurn = false
                //player.stop()
                playerStance = -1
                player.anims.play({key:'pDeath',frameRate: 12},true); 
                player.once('animationcomplete', function () {
                    updateHighScore()
                    finish();
                 }, this);
            } 

            

                        // Keyboard contorls 

                        if(keyA.isDown){

                            if (currentEnergy > 0){
                                playerAttacking = true

                                    playerVitals.decreaseEnergy(maxEnergy * 0.004)

                                if(attackModeActive){
                                playerAction()
                                    
                                }
                            } else {
                                
                                sword.body.checkCollision.none = true
                                attackModeActive = false
                                usingPower = false
   
                            }
                        }

                        if(cursors.space.isDown){

                                playerAttacking = true

                                    playerVitals.decreaseFocus(maxFocus * 0.006)

                                if (Phaser.Input.Keyboard.JustDown(cursors.space)){

                                    attackModeActive = true
                                    usingPower = true
                                }
                                if(attackModeActive){
                                playerSkill()
                                }

                            } else if (Phaser.Input.Keyboard.JustUp(cursors.space)){
                            
                            player.stop()
                            player.play('pBackDash',true)
                            player.once('animationcomplete',function(){
                                        player.play('pIdle',true)
                                    },player)
                            fireTowardsTarget(player, player.x + 125,1)
                            
                            playerAttacking = false
                            attackModeActive = false
                            usingPower = false
                            }



                            if (playerStance == 0){
                               
                            } else if (playerStance == 1){
                                    skillIcon.setTexture('thunderStrikeIcon').setTint()
                                    skillNameText.setText(stance1Name)

                            } else if (playerStance == 2){
                                skillIcon.setTexture('explosiveStrikeIcon').setTint()
                                skillNameText.setText(stance2Name)

                            } else if (playerStance == 3){
                                skillIcon.setTexture('deadlyCombatAssaultIcon').setTint()
                                skillNameText.setText(stance3Name)
 
                            } else if (playerStance == 4){
                                skillIcon.setTexture('coveringFireIcon').setTint()
                                skillNameText.setText(stance4Name)
 
                            }

            }

            

        }



</script>

</body>
</html>
