<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>myFi - The Badlands</title>
    <!-- <preference name="Orientation" value="landscape" /> -->
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            
        }
    </style>
</head>
<body>

<script type="text/javascript">

    // Feature MVP To do:

    // 1) Add levelUp screen and v1 buff/skill tree selection
    // 2) Add Focus Special 2 move (left/right + B button) - offensive focus move
    // 3) Carry out code clean up - condense into functions
    // 4) Add dedicated touch controls - rpelacing current set up piggybacking keyboard controls
    // 5) Add title screen and v1 game testing & balancing

    var ratio = Math.max((window.innerWidth * window.devicePixelRatio)/ (window.innerHeight * window.devicePixelRatio), (window.innerHeight * window.devicePixelRatio) / (window.innerWidth * window.devicePixelRatio)) 
    var DEFAULT_HEIGHT = 272 //window.innerHeight * window.devicePixelRatio // 272
    var DEFAULT_WIDTH = ratio * DEFAULT_HEIGHT// * 2


    var config = {
        type: Phaser.AUTO,

        scale: {

            parent: 'mygame',
            mode: Phaser.Scale.FIT,
            pixelArt: 0,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width:  DEFAULT_WIDTH, //592, //window.innerWidth * window.devicePixelRatio
            height: DEFAULT_HEIGHT //272, //window.innerHeight * window.devicePixelRatio
        },
        input: {
            keyboard: true,
            gamepad: true
        },
        physics:{
            default:'arcade',
            arcade:{
                gravity:{x: 0, y:350},
                debug: 0,
                overlapBias: 20
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };


    var game = new Phaser.Game(config);
    var gameOver = false
    var score = 0
    var highScore = parseInt(localStorage.getItem('highScore')) || 0;

    var storingBuffTier = 0
    var spendingBuffTier = 3
    var growingBuffTier = 5
    var kianovaBuffTier = 1

    var IS_TOUCH = false

    var width = game.config.width
    var height = game.config.height
    var spotlight

    var playerPosition 
    
    var playerSpeed 
    var expToLevelUp = 100
    var exp = 0
    
     
    var inBattle = false

    var level = 0

    var playerAttacking = false   
    var playerDefending = false
    var playerParrying = false
    var playerDodging = false
    var playerCharging = false
    var finishedplayererDefense = true
    var playerAttackNumber  = 0                            
   

    var playerFreeFall = false

    var income = 100
    var lifeRegenAllocation = 0.3 // Equates to budget % allocated to needs
    var energyRegenAllocation = 0.5
    var focusRegenAllocation = 0.2
    
    var lifeRegen = lifeRegenAllocation * income
    var energyRegen = energyRegenAllocation * income
    var focusRegen = focusRegenAllocation * income

    var chargePower = 0
 
   
    var damage = 0

    var maxLife = income * 3
    var startLife = maxLife
    var currentLife = maxLife

    var maxEnergy = income
    var currentEnergy = maxEnergy
    var currentEnergyText
    
    var startMaxEnergy = 100
    var currentFocus = 0
    var maxFocus = maxEnergy * 3

    var chaosFactor = 0.0
    var chaosMultiplierMin = 0.7
    var chaosMultiplierMax = 2.5

    var playerIsHit = false
    var enemy1IsHit = false
   
    var enemy1Life = (income * 0.3)
    var enemy1Alive
    var e1MaxLife = (income * 0.3)
    var enemy1Aggro = true
    

    class HealthBar {

        constructor (scene,startLife, x, y)
        {
            this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            
            this.lifeBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            this.focusBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            this.energyBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);
            

            this.scaleX = 3
            this.scaleY = 3

            this.x = x;
            this.y = y;
            
            this.pL =  (38 * this.scaleX) / maxLife
            this.pF =  (38 * this.scaleX)  / maxFocus 
            this.pE =  (38 * this.scaleX)  / maxEnergy
            

            this.draw();

            scene.add.existing(this.bg)
            scene.add.existing(this.lifeBar);
            scene.add.existing(this.focusBar);
            scene.add.existing(this.energyBar);
            
        }

        decreaseLife (amount)
        {
            currentLife -= amount;

            if (currentLife > maxLife){
                currentLife = maxLife
            }

           

            if (currentLife < 0)
            {
                currentLife = 0;
            }

            this.draw();

            return (currentLife === 0);
        }

        decreaseEnergy (amount)
        {
            currentEnergy -= amount;

            if (currentEnergy > maxEnergy){
                currentEnergy = maxEnergy
            }

            if (currentEnergy < 0)
            {
                currentEnergy = 0;
            }
            

            this.draw();

            return (currentEnergy === 0);
        }

        decreaseFocus (amount)
        {
            currentFocus -= amount;

            if (currentFocus > maxFocus){
                currentFocus = maxFocus
            }

            if (currentFocus < 0)
            {
                currentFocus = 0;
            }

            this.draw();

            return (currentFocus === 0);
        }

        hide ()
        {
            this.bg.setVisible(0)
            this.lifeBar.setVisible(0)
            this.energyBar.setVisible(0)
            this.focusBar.setVisible(0)
        }

        show ()
        {
            this.bg.setVisible(1)
            this.lifeBar.setVisible(1)
            this.energyBar.setVisible(1)
            this.focusBar.setVisible(1)
        }

        draw ()
        {
            this.bg.clear()
            this.lifeBar.clear();
            this.focusBar.clear();
            this.energyBar.clear();
            

            //  BG
            this.bg.fillStyle(0x000000);
            this.bg.fillRect(this.x, this.y, (40 * this.scaleX), 13 * this.scaleY);

            //  Health

            this.lifeBar.fillStyle(0xffffff);
            this.lifeBar.fillRect(this.x + (1 * this.scaleX), this.y + (1 * this.scaleY), 38 * this.scaleX, 3 * this.scaleY);
            this.lifeBar.fillStyle(0xcc0000);


            var d = Math.floor(this.pL * currentLife);

            this.lifeBar.fillRect(this.x + (1 * this.scaleX), this.y + (1 * this.scaleY), d , 3 * this.scaleY);

            //  Focus

            this.focusBar.fillStyle(0xffffff);
            this.focusBar.fillRect(this.x + (1 * this.scaleX), this.y + (5 * this.scaleY), 38 * this.scaleX, 3 * this.scaleY);
            this.focusBar.fillStyle(0xf1c232);
            

            var d = Math.floor(this.pF * currentFocus);

            this.focusBar.fillRect(this.x + (1 * this.scaleX), this.y + (5 * this.scaleY), d  , 3 * this.scaleY);

            //  Energy

            this.energyBar.fillStyle(0xffffff);
            this.energyBar.fillRect(this.x + (1 * this.scaleX), this.y + (9 * this.scaleY) , 38 * (maxEnergy/startMaxEnergy) * this.scaleX , 3 * this.scaleY);
            this.energyBar.fillStyle(0x93c47d);
        

            var d = Math.floor(this.pE * currentEnergy);

            this.energyBar.fillRect(this.x + (1 * this.scaleX), this.y + (9 * this.scaleY), d , 3 * this.scaleY);

            
        }

    }

    class EnemyHealthBar {

    constructor (scene, x, y)
    {
        this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(1);
        
        this.enemyLifeBar = new Phaser.GameObjects.Graphics(scene).setDepth(1);

        this.x = x;
        this.y = y;
        
        this.p =  38 / e1MaxLife

        this.draw();

        scene.add.existing(this.bg)
        scene.add.existing(this.enemyLifeBar);
    }

    decreaseEnemyLife (amount)
    {
        enemy1Life -= amount;

        if (enemy1Life < 0)
        {
            enemy1Life = 0;
        }

        this.draw();

        return (enemy1Life === 0);
    }

    draw ()
    {
        this.bg.clear()
        this.enemyLifeBar.clear();

        //  BG
        this.bg.fillStyle(0x000000);
        this.bg.fillRect(this.x, this.y, 40, 5);

        //  Health

        this.enemyLifeBar.fillStyle(0xffffff);
        this.enemyLifeBar.fillRect(this.x + 1, this.y + 1, 38, 3);
        this.enemyLifeBar.fillStyle(0xcc0000);


        var d = Math.floor(this.p * enemy1Life);
        //this.p =  38 / e1MaxLife

        this.enemyLifeBar.fillRect(this.x + 1, this.y + 1, d, 3);

    }

    }

    class ExperienceBar {

    constructor (scene,exp, x, y)
    {
        this.bg = new Phaser.GameObjects.Graphics(scene).setDepth(4);
        
        this.experienceBar = new Phaser.GameObjects.Graphics(scene).setDepth(4);

        this.x = x;
        this.y = y;
        
        this.p =  (width/3-2) / expToLevelUp

        this.draw();

        scene.add.existing(this.bg)
        scene.add.existing(this.experienceBar);
        
    }

    increaseExp (amount)
    {
        exp += amount;

        if (exp > expToLevelUp)
        {
            exp = expToLevelUp;
        }

        this.draw();

        return (exp === expToLevelUp);
    }

    

        

        draw ()
        {
            this.bg.clear()
            this.experienceBar.clear();
           

            //  BG
            this.bg.fillStyle(0x000000);
            this.bg.fillRect(this.x, this.y, width/3, 20);

            //  Exp

            this.experienceBar.fillStyle(0xffffff);
            this.experienceBar.fillRect(this.x + 1, this.y + 1, width/3-2, 18);
            this.experienceBar.fillStyle(0x674EA7);


            var d = Math.floor(this.p * exp);

            this.experienceBar.fillRect(this.x + 1, this.y + 1, d, 18);

            
        }

    }

    function showHUD() {
        playerIcon.setVisible(1)
        playerVitals.show()
        storingBuffIcon.setVisible(1)
        storingBuffTierIcon.setVisible(1)
        spendingBuffIcon.setVisible(1)
        spendingBuffTierIcon.setVisible(1)
        growingBuffIcon.setVisible(1)
        growingBuffTierIcon.setVisible(1) 

        kianovaBuffIcon.setVisible(1)
    }

    function hideHUD() {
        playerIcon.setVisible(0)
        playerVitals.hide()
        storingBuffIcon.setVisible(0)
        storingBuffTierIcon.setVisible(0)
        spendingBuffIcon.setVisible(0)
        spendingBuffTierIcon.setVisible(0)
        growingBuffIcon.setVisible(0)
        growingBuffTierIcon.setVisible(0) 

        kianovaBuffIcon.setVisible(0)
    }
       
   function modeSwitch(){

            if (camera.zoom == 1.05){
                    camera.zoomTo(1,500)
                    inBattle = false
                    
                    
            } else if (camera.zoom == 1) {
                    camera.zoomTo(1.05,500)
                    inBattle = true
                    
            }


            camera.on('camerazoomstart', function () {
                
                //camera.flash(1000)
                hideHUD()
                
            }, this);
            
 
            camera.on('camerazoomcomplete', function () {

                if (inBattle){
                    

                    playerIcon.x = camera.scrollX + 40
                    playerIcon.y = camera.scrollY + 40
                    camera.startFollow(player)
                    showHUD()
                    
                } else {
                    playerIcon.x = camera.scrollX + 25
                    playerIcon.y = camera.scrollY + 35
                    camera.pan(width * 1.5,1000)
                    showHUD()
                    
                    
                }


            }, this);
   }

    function grabbed(){

        if (inBattle == false) {

            player.anims.play({key:'pDash',frameRate: 12},true);

            player.setVelocityX(100)
            enemy1.setVelocityX(-100)
            player.flipX = true
            playerIsHit = false
            
            if (currentLife <= 0){
                playerVitals.decreaseEnergy(currentEnergy * 0.05)
            } else {
                playerVitals.decreaseLife(currentLife * 0.05)
            }
            
            income *= 1 - (0.04 / 12)

            modeSwitch()


        }
                

    }

   

    function playerHit(){

                    
                        playerIsHit = true
                        playerVitals.decreaseLife(currentLife * 0.05 / 300)
                        playerVitals.decreaseEnergy(currentEnergy * 0.05 / 300)
                        maxEnergy *= 1 - (0.04 / 300)
                        player.x -= 1
                           
               
    }

    function playerVineHit(){

    if (inBattle == false){
        playerIsHit = true
        playerVitals.decreaseLife((income * 0.35) / 50)
        
        maxEnergy *= 1 - (0.01 / 12 / 50)
        player.x -= 1
        //enemy1.x += 1
        enemyChase(5)
    } 
    
    }

    function playerTreeTrunkHit(){

    if (inBattle == false){
        playerIsHit = true
        playerVitals.decreaseLife((income * 0.5) / 50)
        
        maxEnergy *= 1 - (0.02 / 12 / 50)
        player.x -= 1
        enemy1.setVelocityX
        //enemy1.x += 2
        enemyChase(10)
    } 

    }

    function playerEnemyHit(){

    if (inBattle){
        
        if (playerDefending){
            if (playerParrying == false){
            playerVitals.decreaseLife(e1MaxLife / 150)
            camera.shake(20,0.0025)
            
            }

        } else if (playerParrying == false && finishedplayererDefense) {
            playerIsHit = true
            playerVitals.decreaseLife((e1MaxLife * 1.5) / 50)
            maxEnergy *= 1 - (0.04 / 12 / 50)
            income *= 1 - (0.02 / 12 / 50)
        }
            
            
        //} 
        
    }   
    }
    
    function playerParry(){

    if (inBattle){
    
    if (playerParrying) {
            camera.flash()
            playerVitals.decreaseLife(-e1MaxLife / 150)
            if (enemy1.flipX){
                enemy1.setVelocityX(-100)
            } else {
                enemy1.setVelocityX(100)
            }
            
            
   
        }
        
        
    }  


    }

    function playerRecover(){

    if (playerIsHit){
        playerIsHit = false 
    }

    }

    function enemy1Hit(){

        if (inBattle) {              
        
            if (playerParrying == false){
                enemy1IsHit = true
            var chaos = Phaser.Math.FloatBetween(0.00,1.00)
            if (chaos < 0.025){
           
            camera.flash(150);
            camera.shake(500, 0.0075);
            damage *= Phaser.Math.Between(1.75,2.75)
            enemy1Vitals.decreaseEnemyLife(damage)
            if (player.flipX){
                enemy1.x -= Phaser.Math.Between(10,20)
                
            } else {
                enemy1.x -= Phaser.Math.Between(-10,-20)
            }
            //
            } else
            if (chaos < 0.075){
            camera.shake(500, 0.0025);
            damage *= Phaser.Math.Between(1.15,1.75)
            enemy1Vitals.decreaseEnemyLife(damage)
            if (player.flipX){
                enemy1.x -= Phaser.Math.Between(2.5,5)
                
            } else {
                enemy1.x -= Phaser.Math.Between(-5,-2.5)
            }
            } else {
                damage *= Phaser.Math.Between(0.85,1.1)
                enemy1Vitals.decreaseEnemyLife(damage)
                if (player.flipX){
                
                enemy1.x -= Phaser.Math.Between(-1,2.5)
            } else {
                enemy1.x -= Phaser.Math.Between(-2.5,1)
            }

       
            }
            }
            
             
    }             
                 
    }

    function enemy1Recover(){

        if (enemy1IsHit){
            enemy1IsHit  = false 
        }

    }

    

   
    function enemyChase(velocityBoost)
    {
       if (inBattle == false) {
        enemy1.setDragX(0)
        enemy1.setVelocityX(enemy1.body.velocity.x + (velocityBoost * chaosFactor))

        }

        
    }

    

    function runYearlyFunctions()
    {
       if (inBattle == false) {

        income *= 0.96
        enemyChase(75)
        enemy1.setScale(Phaser.Math.FloatBetween(1.65,1.8),Phaser.Math.FloatBetween(1.2,1.3))

        }

        

        chaosMultiplierMin *= 1 + (0.08)
        chaosMultiplierMax *= 1 + (0.12)
        
 
    }

    function runMonthlyFunctions()
    {


        chaosMultiplierMin *= 1 + (0.06 / 12)
        chaosMultiplierMax *= 1 + (0.08 / 12) 

        if (inBattle == false) {

            e1MaxLife = (income * 0.3) * chaosFactor
            enemy1Life = e1MaxLife
            enemy1Vitals.p = 38 / e1MaxLife

        }

    }

    function runWeeklyFunctions()
    {
       enemyChase(-5)

       if (inBattle == false) {

        e1MaxLife = (income * 0.3) * chaosFactor
        enemy1Life = e1MaxLife
        enemy1Vitals.p = 38 / e1MaxLife

        }
    
    }

    function runSecondsFunctions()
    {
        

        if (playerAttacking == false){

            
        playerVitals.decreaseLife(-lifeRegen / 5) 
        playerVitals.decreaseEnergy(-energyRegen / 5)
        playerVitals.decreaseFocus(-focusRegen / 5)

        }

        if (inBattle == false){
            playerExperience.increaseExp((100 / 60))
            score += (100 / 60)
        } else {
            if (score > 0){
                score -= (50 / 60)
            } else {
                score = 0
            }
            
        }

        


        
    }

    function updateHighScore(){
        if (highScore < score){
            highScore = score
        }

        
        localStorage.setItem('highScore',highScore);
    }


    function preload ()
    {   
        this.load.audio("bgMusic1", ["assets/music/Le_chÃ¢teau_magique.mp3"]);
        this.load.audio("bgMusic2", ["assets/music/Kids_See_Ghosts.mp3"]);
        this.load.audio("bgMusic3", ["assets/music/Riptide.mp3"]);
        this.load.audio("bgMusic4", ["assets/music/The_Apartment.mp3"]);
        this.load.audio("bgMusic5", ["assets/music/Katana.mp3"]);
        this.load.audio("bgMusic6", ["assets/music/Ludum_Dare_38_Track_2.wav"]);
        
        this.load.audio("playerSwordSwing", ["assets/soundFX/SFX_Whoosh_Sword_02.mp3"]);
        this.load.audio("playerHeavySwordSwing", ["assets/soundFX/SFX_Whoosh_Sword_03.mp3"]);        
        this.load.audio("enemySwordSwing", ["assets/soundFX/SFX_Sword_Whoosh_01.mp3"]);
        this.load.audio("charge", ["assets/soundFX/SFX_Potion_01.mp3"]);
        

        this.load.image('playerIcon', 'assets/playerIcon.png');

        this.load.image('storingBuffIcon', 'assets/ach_00059.png');
        this.load.image('spendingBuffIcon', 'assets/ach_00057.png');
        this.load.image('growingBuffIcon', 'assets/ach_00046.png');

        this.load.image('t1BuffIcon', 'assets/ach_00117.png');
        this.load.image('t2BuffIcon', 'assets/ach_00118.png');
        this.load.image('t3BuffIcon', 'assets/ach_00119.png');
        this.load.image('t4BuffIcon', 'assets/ach_00120.png');
        this.load.image('t5BuffIcon', 'assets/ach_00121.png');

        this.load.image('t1KianovaBuffIcon', 'assets/ach_00122.png');
        this.load.image('t2KianovaBuffIcon', 'assets/ach_00091.png');

        this.load.image('up', 'assets/controls/shadedDark03.png');
        this.load.image('down', 'assets/controls/shadedDark10.png');
        this.load.image('deadSpace', 'assets/controls/buttonDeadSpace.png');
        this.load.image('left', 'assets/controls/shadedDark05.png');
        this.load.image('right', 'assets/controls/shadedDark06.png');
        this.load.image('energy', 'assets/controls/shadedDark36.png');
        this.load.image('focus', 'assets/controls/shadedDark37.png');

        this.load.image('dawnl1', 'assets/dawn1.png');
        this.load.image('dawnl2', 'assets/dawn2.png');
        this.load.image('dawnl3', 'assets/dawn3.png');
        this.load.image('dawnl4', 'assets/dawn4.png');
        this.load.image('dawnl5', 'assets/dawn5.png');
        this.load.image('dawnl6', 'assets/dawn6.png');
        this.load.image('dawnl7', 'assets/dawn7.png');
        this.load.image('dawnl8', 'assets/dawn8.png');

        this.load.image('woodsl1', 'assets/woods1.png');
        this.load.image('woodsl2', 'assets/woods2.png');
        this.load.image('woodsl3', 'assets/woods3.png');
        this.load.image('woodsl4', 'assets/woods4.png');

        this.load.image('vines', 'assets/vines.png');
        this.load.image('treeTrunk', 'assets/treeTrunk.png');

        this.load.image('ground', 'assets/woodground.png');


        this.load.atlas('logan', 'assets/loganv2.png','assets/loganspritesv2.json');
        this.load.atlas('doomsayer', 'assets/doomsayer.png','assets/doomsayersprites.json');
        this.load.atlas('heroF', 'assets/heroF.png','assets/heroF.json');
        this.load.atlas('heroM', 'assets/heroM.png','assets/heroM.json');

        this.load.spritesheet('chargeEnergy', 'assets/animations/17_felspell_spritesheet.png', { frameWidth: 100, frameHeight: 100});
        this.load.spritesheet('chargeDash', 'assets/animations/chargeDash.png', { frameWidth: 128.5, frameHeight: 128.6});
  

    }

    function create ()
    {

        songChoice = Math.floor(Phaser.Math.Between(1,6))
        bgMusic = this.sound.add("bgMusic"+songChoice, { loop: true, volume: 0.75});


        bgMusic.play()

        playerSwordSwing = this.sound.add("playerSwordSwing", {volume: 0.5})
        playerHeavySwordSwing = this.sound.add("playerHeavySwordSwing", {volume: 0.5})
        enemySwordSwing = this.sound.add("enemySwordSwing", {volume: 0.5})
        charge = this.sound.add("charge",{volume: 0.5})
        

        this.physics.world.setBounds(0, 0, width * 3,  height);
        
        this.woodsl1 = this.add.tileSprite(0,0, width * 3, height, 'woodsl1').setOrigin(0,0).setScrollFactor(0)
        this.woodsl2 = this.add.tileSprite(0,0, width * 3, height, 'woodsl2').setOrigin(0,0).setScrollFactor(0.25)
        this.woodsl3 = this.add.tileSprite(0,0, width * 3, height, 'woodsl3').setOrigin(0,0).setScrollFactor(0.5)
        this.woodsl4 = this.add.tileSprite(0,0, width * 3, height, 'woodsl4').setOrigin(0,0).setScrollFactor(1).setDepth(2)

        this.lights.enable();
        this.lights.setAmbientColor(0x808080);

        spotlight = this.lights.addLight(400, 300, 280).setIntensity(0.5);
       
        platforms = this.physics.add.staticGroup();
        platforms.create(0, height - 50, 'ground').setOrigin(0,0).setScale(width * 3 /400).refreshBody().setVisible(1);

        player = this.physics.add.sprite(width * 1.5, height - 90 ,'heroF').setScale(2).setPipeline('Light2D');
        player.setDepth(1)
        player.tint = 0xdd7e6b;
        currentLife = startLife
        

        player.body.setSize(10, 30).setOffset(25,15).setAllowDrag(true)
        player.body.maxVelocity.x = 250
        player.setBounceY(0.15);
        player.setCollideWorldBounds(true);

        sword = this.add.rectangle(player.x, player.y, 60, 60);
        this.physics.add.existing(sword, false)
        sword.body.setAllowGravity(false).setOffset(0,5)
        sword.body.checkCollision.none = true

        pSFX = this.add.sprite(player.x, player.y)
        pSFX.setAlpha(0.75).setDepth(1).setPipeline('Light2D')
        
        this.physics.add.collider(player,platforms);

        this.vines = this.add.image(player.x,player.y - 120, 'vines').setOrigin(0,0).setDepth(1).setScale(0.35,0.5).setTint(0x38761d) //(0xed8a8a)

        this.physics.add.existing(this.vines,false)
        this.vines.body.setAllowGravity(false)
        this.physics.add.overlap(player,this.vines, playerVineHit);
        this.vines.body.setSize(474,175).setOffset(0,-7.5)

        treeTrunk = this.add.image(0,height - 110, 'treeTrunk').setOrigin(0,0).setDepth(1)//.setScale(0.35,0.5).setTint(0x38761d) //(0xed8a8a)

        this.physics.add.existing(treeTrunk,false)
        treeTrunk.body.setAllowGravity(false)
        this.physics.add.overlap(player,treeTrunk, playerTreeTrunkHit);
        this.physics.add.collider(platforms,treeTrunk);
        treeTrunk.body.setSize(150,57).setOffset(5,10)


            enemy1 = this.physics.add.sprite(0, height - 85, 'doomsayer').setScale(1.75, 1.2).setPipeline('Light2D');
            
            enemy1.setDepth(0)
            enemy1.flipX = true
            enemy1.body.maxVelocity.x = 100
            enemy1.setCollideWorldBounds(true)
            enemy1.body.setAllowGravity(true)
            enemy1.setGravityY(375)
            
            
            this.physics.add.overlap(enemy1, player, grabbed);
            
            this.physics.add.overlap(sword, enemy1, enemy1Hit)
            this.physics.add.collider(platforms,enemy1);
            
            enemy1.body.setAllowDrag(true)
           
            enemy1Life = (income * 0.3) * Phaser.Math.Between(0.8,1.7)
            e1MaxLife = enemy1Life
            enemy1Alive = true

            enemy1Vitals = new EnemyHealthBar(this,enemy1.x, enemy1.y - 50);

            eSword = this.add.rectangle(enemy1.x, enemy1.y, 65, 60);
            this.physics.add.existing(eSword, false)
            eSword.body.setAllowGravity(false).setOffset(0,5)
            eSword.body.checkCollision.none = true
            this.physics.add.overlap(eSword, player, playerEnemyHit);
            this.physics.add.overlap(eSword, sword, playerParry);

            
        camera = this.cameras.main.centerOn(width * 1.5, 0) //.startFollow(player, false, 0.05, 0.05)


        camera.setBounds(0, 0, width * 3, height)

        
        
        camera.fadeIn(3000)

        playerIcon = this.add.image(0,0,'playerIcon').setDepth(4).setScale(2.5)

        playerVitals = new HealthBar(this,startLife, playerIcon.x + 30, playerIcon.x + 20);

        storingBuffIcon = this.add.image(playerVitals.x + 120,camera.scrollY + 25,'storingBuffIcon').setDepth(4).setScale(0.5)
        spendingBuffIcon = this.add.image(storingBuffIcon.x + 100,camera.scrollY + 25,'spendingBuffIcon').setDepth(4).setScale(0.5)
        growingBuffIcon = this.add.image(spendingBuffIcon.x + 95,camera.scrollY + 25,'growingBuffIcon').setDepth(4).setScale(0.5)

        

        if (storingBuffTier == 0){

            storingBuffTierIcon = this.add.image(camera.scrollX + 275,camera.scrollY + 25,'t1BuffIcon').setDepth(4).setScale(0.5).setAlpha(0.25)
        } else {
            storingBuffTierIcon = this.add.image(camera.scrollX + 275,camera.scrollY + 25,'t'+storingBuffTier+'BuffIcon').setDepth(4).setScale(0.5)
        }

        if (spendingBuffTier == 0){
            spendingBuffTierIcon = this.add.image(camera.scrollX + 400,camera.scrollY + 25,'t1BuffIcon').setDepth(4).setScale(0.5).setAlpha(0.25)
        } else {
            spendingBuffTierIcon = this.add.image(camera.scrollX + 400,camera.scrollY + 25,'t'+spendingBuffTier+'BuffIcon').setDepth(4).setScale(0.5)
        }

        if (growingBuffTier == 0){
            growingBuffTierIcon = this.add.image(camera.scrollX + 525,camera.scrollY + 25,'t1BuffIcon').setDepth(4).setScale(0.5).setAlpha(0.25)
        } else {
            growingBuffTierIcon = this.add.image(camera.scrollX + 525,camera.scrollY + 25,'t'+growingBuffTier+'BuffIcon').setDepth(4).setScale(0.5)
        }

        if (kianovaBuffTier == 0){
            kianovaBuffIcon = this.add.image(camera.scrollX + 525,camera.scrollY + 25,'t1KianovaBuffIcon').setDepth(4).setScale(0.65).setAlpha(0.25)
        } else if (kianovaBuffTier == 2) {
            kianovaBuffIcon = this.add.image(camera.scrollX + 525,camera.scrollY + 25,'t'+kianovaBuffTier+'KianovaBuffIcon').setDepth(4).setScale(0.2)
        } else {
            kianovaBuffIcon = this.add.image(camera.scrollX + 525,camera.scrollY + 25,'t'+kianovaBuffTier+'KianovaBuffIcon').setDepth(4).setScale(0.5)
        }

 
        playerExperience = new ExperienceBar(this,exp, camera.scrollX + width * 0.33, camera.scrollY + (height - 85));

        highScoreText = this.add.text(camera.scrollX + (width - 340), camera.scrollY + (height - 57), 'High Score: ' + Math.floor(highScore)).setFontFamily('Arial').setFontSize(12).setColor('#674EA7').setDepth(4);
        scoreText = this.add.text(camera.scrollX + (width - 140), camera.scrollY + (height - 57), 'Score: ' + Math.floor(score)).setFontFamily('Arial').setFontSize(12).setColor('#674EA7').setDepth(4);

        // 96 seconds = 1 year
        // 8 seconds = 1 month
        // 2 second per week
        // 0.285 seconds per day

        yearlyTimer = this.time.addEvent({delay: 60000, callback: runYearlyFunctions, args: [], callbackScope: this, loop: true});
        // Each minute represents a month
        monthlyTimer = this.time.addEvent({delay: 5000, callback: runMonthlyFunctions, args: [], callbackScope: this, loop: true});

        weeklyTimer = this.time.addEvent({delay: 1250, callback: runWeeklyFunctions, args: [], callbackScope: this, loop: true});

        secondsTimer = this.time.addEvent({delay: 1000, callback: runSecondsFunctions, args: [], callbackScope: this, loop: true});

        this.anims.create({
            key: 'chargeEnergy',
            frames: this.anims.generateFrameNumbers('chargeEnergy', { start:0, end: 91}),
            frameRate: 100,
            repeat: 0,
            //yoyo: true
        });

        this.anims.create({
            key: 'chargeDash',
            frames: this.anims.generateFrameNumbers('chargeDash', { start:0, end: 5}),
            frameRate: 6,
            repeat: 0,
            //yoyo: true
        });

        this.anims.create({
            key: 'pIdle',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Idle_', start: 1, end: 6, suffix: '.png'}),
            frameRate: 6,
            repeat: -1
        });

       

        this.anims.create({
            key: 'pDeath',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Death_', start: 1, end: 11, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });
     

        this.anims.create({
            key: 'pHurt',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_hurt_', start: 1, end: 4, suffix: '.png'}),
            frameRate: 4,
            repeat: 0
        });

        this.anims.create({
            key: 'pSlide',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior-Slide_', start: 1, end: 4, suffix: '.png'}),
            frameRate: 14,
            repeat: 0
        });

        this.anims.create({
            key: 'pJump',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Jump_', start: 1, end: 3, suffix: '.png'}),
            frameRate: 12,
            repeat: 0
        });

        this.anims.create({
            key: 'pUptoFall',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_UptoFall_', start: 1, end: 2, suffix: '.png'}),
            frameRate: 10,
            repeat: 0
        });

        this.anims.create({
            key: 'pRun',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Run_', start: 1, end: 8, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pSpecial1',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash_', start: 5, end: 7, suffix: '.png'}),
            frameRate: 4,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pChargeSpecial1',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash-Attack_', start: 10, end: 10, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pChargeSpecial2',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash-Attack_', start: 1, end: 2, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pDash',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash_', start: 1, end: 7, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pParry',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 9, end: 12, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pAttack',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 1, end: 12, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pQuickAttack',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 1, end: 8, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pChargeAttack',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Attack_', start: 1, end: 3, suffix: '.png'}),
            frameRate: 6,
            repeat: 0,
            //yoyo: true,
            //delay: 1
        });

        this.anims.create({
            key: 'pHeavyAttack',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Dash-Attack_', start: 1, end: 10, suffix: '.png'}),
            frameRate: 14,
            repeat: 0,
            //delay: 1
        });

        this.anims.create({
            key: 'pChargeEnergy',
            frames: this.anims.generateFrameNames('heroF',{prefix: 'Warrior_Crouch_', start: 1, end: 6, suffix: '.png'}),
            frameRate: 4,
            repeat: 0,
            //yoyo: true,
            //delay: 500
        });


        this.anims.create({
            key: 'eIdle',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'idle', start: 1, end: 8}),
            frameRate: 10,
            repeat: -1
        });

       
        this.anims.create({
            key: 'eRun',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'walk', start: 1, end: 8}),
            frameRate: 10,
            repeat: 0
        });


        this.anims.create({
            key: 'eAttack',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'attack', start: 1, end: 10}),
            frameRate: 10,
            repeat: -1,
            delay: 50,
            repeatDelay: Math.random() * 4000
            
        });

        this.anims.create({
            key: 'eHurt',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'hurt', start: 1, end: 3}),
            frameRate: 10,
            repeat: 0
        });

        this.anims.create({
            key: 'eDeath',
            frames: this.anims.generateFrameNames('doomsayer',{prefix: 'death', start: 1, end: 10}),
            frameRate: 12,
            repeat: 0,
            hideOnComplete: true
            
        });


        // Controllers online
        cursors = this.input.keyboard.createCursorKeys();
        keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
        keyZ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);

        // Touch Screen Support
        
        this.input.addPointer(5);
        up = this.add.image(-100, -100, 'up').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);
        down = this.add.image(-100, -100, 'down').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);
        left = this.add.image(-100, -100, 'left').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);
        right = this.add.image(-100, -100, 'right').setInteractive().setDepth(3).setScale(0.75).setAlpha(0.5);
        deadSpace = this.add.image(-100, -100, 'deadSpace').setDepth(4).setScale(0.75).setVisible(0);
        energy = this.add.image(-100, -100, 'energy').setInteractive().setDepth(3).setScale(.75).setAlpha(0.5).setTint(0x93c47d);
        focusB = this.add.image(-100, -100, 'focus').setInteractive().setDepth(3).setScale(.75).setAlpha(0.5).setTint(0xf1c232);

        this.input.on('pointerdown', function (pointer) {
        IS_TOUCH = true;
        })

        this.input.on('gameobjectdown', function (pointer, gameObject) {
        
        
           

        gameObject.setAlpha(1);
        
        if (gameObject == up){
            cursors.up.isDown = true
            cursors.up.isUp = false
        }

        if (gameObject == down){
            cursors.down.isDown = true
            cursors.down.isUp = false
            
            
        }

        if (gameObject == left){
            cursors.left.isDown = true
            cursors.left.isUp = false
        } 

        if (gameObject == right){
            cursors.right.isDown = true
            cursors.right.isUp = false
        }

        if (gameObject == energy){
            keyA.isDown = true
            //player.anims.play({key:'pChargeAttack',frameRate: 16},true);
            keyA.isUp = false
        }

        if (gameObject == focusB){
            cursors.space.isDown = true
            // player.anims.play({key:'pChargeAttack',frameRate: 16},true);
            cursors.space.isUp = false
        }

        });

        this.input.on('gameobjectup', function (pointer, gameObject) {

        gameObject.setAlpha(0.5);

        if (gameObject == up){
            cursors.up.isDown = false
            cursors.up.isUp = true
        }

        if (gameObject == down){
            cursors.down.isDown = false
            cursors.down.isUp = true
        }

        if (gameObject == left){
            cursors.left.isDown = false
            cursors.left.isUp = true
        }

        if (gameObject == right){
            cursors.right.isDown = false
            cursors.right.isUp = true
        }

        if (gameObject == energy){
            keyA.isDown = false
            keyA.isUp = true
        }

        if (gameObject == focusB){
            cursors.space.isDown = false
            cursors.space.isUp = true
            // keyA.isUp = true
        }

        });

        // this.input.on('gameobjectout', function (pointer, gameObject) {

        //     // gameObject.setAlpha(0.5);

        //     // if (gameObject == up){
        //     //     cursors.up.isDown = false
        //     // }

        //     // if (gameObject == down){
        //     //     cursors.down.isDown = false
        //     // }

        //     // if (gameObject == left){
        //     //     cursors.left.isDown = false
        //     // }

        //     // if (gameObject == right){
        //     //     cursors.right.isDown = false
        //     // }

        //     // if (gameObject == energy){
        //     //     keyA.isDown = false
        //     //     keyA.isUp = true
        //     // }

        //     // if (gameObject == focusB){
        //     //     cursors.space.isDown = false
        //     //     // keyA.isUp = true
        //     // }

        //     // });
            
    

    }

    function moveVines (vine,speed){
    
        vine.x -= speed;
        if (vine.x < Phaser.Math.Between(10,100)){
            resetVines(vine)
        }

        
    }

    function moveTreeTrunk (treeTrunk,speed){
    
    treeTrunk.x -= speed;
    if (treeTrunk.x < Phaser.Math.Between(0,150)){
        resetTreeTrunk(treeTrunk)
    }

    
    }

    function resetVines (vine){
        vine.x = width * 3
        var scaleXRandom = Phaser.Math.FloatBetween(0.15,0.65)
        var scaleYRandom = Phaser.Math.FloatBetween(0.55,0.8)
        vine.setScale(scaleXRandom,scaleYRandom)
    }

    function resetTreeTrunk (treeTrunk){
        treeTrunk.x = width * 3
        var scaleXRandom = Phaser.Math.FloatBetween(0.75,1.1)
        var scaleYRandom = Phaser.Math.FloatBetween(0.8,1.2)
        treeTrunk.setScale(scaleXRandom,scaleYRandom)
    }

    function finish(){
        if (gameOver == false){
            gameOver = true
            camera.fadeOut(6000)
            camera.on('camerafadeoutcomplete', function () {

            

            }, this);
            
        }
        
    }

    function levelUp(){
        exp = 0
        level += 1
        chaosMultiplierMin *= 1.1
        expToLevelUp *= 1.04
        playerExperience.p = (width/3-2) / expToLevelUp
    }

    function update ()
    {

         // v2 Player runs on spot, and tween 

        // Player uses energy (auto via budget) to set velocity and coast on momentum, and to avoid incoming obstacles (budget/some stat determines auto dodge)

        // Enemies spawn and charge at intervals relating to a [month]

        // Player auto clears incoming obstacles provided they have enough energy (has a cost, identifiable visually), can use focus instead manually.  Challenge is balancing with monster chasing, requiring energy expenditure to avoid.  Obstacles cover the baseline outgoings per month, monster reps unexpected.  Remaining energy can be 'invested' (mechanics tbc) or is swept into savings each cycle -

        // enemy constantly eating a random amount of player energy (or at set intervals)
        // Income - budget = energy regen
        // As time passes, energy regen decreases by 4% (inflation) + x% (diffuclty ramp) per interval, and more enemies of higher chaos multipliers appear)
        // Enemy can sprint, rep unexpected cost, accelratin up to player (higher accelration = larger unexpected cost)  
        // Player can expend further energy to accelerate, and while sprinting cuts enemy accelration
        
        updateHighScore()

        playerExperience.x = camera.scrollX + width * 0.33
        playerExperience.y = camera.scrollY + (height * 0.85)
        playerExperience.draw()

        scoreText.x = camera.scrollX + (width - 367.5)
        scoreText.y = camera.scrollY + (height - 57)
        scoreText.setText('Score: ' + Math.floor(score))

        highScoreText.x = scoreText.x + 100
        highScoreText.y = camera.scrollY + (height - 57)
        highScoreText.setText('High Score: ' + Math.floor(highScore))

        

        if(IS_TOUCH){
        left.setInteractive(1).setVisible(1)
        left.setInteractive(1).setVisible(1)
        energy.setInteractive(1).setVisible(1)

        right.setInteractive(1).setVisible(1)
        up.setInteractive(1).setVisible(1)
        down.setInteractive(1).setVisible(1)
        focusB.setInteractive(1).setVisible(1)

        
        } else {
            left.setInteractive(0).setVisible(0)
            energy.setInteractive(0).setVisible(0)
            right.setInteractive(0).setVisible(0)
            up.setInteractive(0).setVisible(0)
            down.setInteractive(0).setVisible(0)
            focusB.setInteractive(0).setVisible(0)

        }

        if (Phaser.Input.Keyboard.JustDown(keyZ)){
            if(IS_TOUCH){
            IS_TOUCH = false
            } else {
            IS_TOUCH = true
            }
        }

        left.x = camera.scrollX + (width * 0.1)
        energy.x = camera.scrollX + (width * 0.9) 

        deadSpace.x = left.x + 35.5
        right.x = deadSpace.x + 35.5
        up.x = deadSpace.x
        down.x = deadSpace.x
        focusB.x = energy.x - 75

        left.y = camera.scrollY + (height - 85)
        energy.y = camera.scrollY + (height - 106)

        deadSpace.y = left.y
        right.y = deadSpace.y
        up.y = deadSpace.y - 40.5
        down.y = left.y + 40.5
        focusB.y = energy.y + 53

 
        if (exp >= expToLevelUp){
            score += (100 / 60) * 10
            levelUp()  
        }

        
        console.log('Chaos Factor: ' + chaosFactor)
        console.log('Chaos Factor Min: ' + chaosMultiplierMin)
        console.log('Chaos Factor Max: ' + chaosMultiplierMax)
        // console.log('Player is Hit: ' + playerIsHit)
         console.log('Enemy Max HP: ' + e1MaxLife)
       
        // console.log('Player Defending: ' + playerDefending)
        // console.log('Player Parrying: ' + playerParrying)

        // console.log('Player Charging: ' + playerCharging)

        // console.log('Player Charge Power: ' + chargePower)

        // console.log('Player Drag: ' + player.body.drag.x)

        // console.log('Player Velocity: ' + player.body.velocity.x)

         //console.log('Chaos Factor: ' + chaosFactor)

        console.log('Level: ' + level)

        console.log('Exp to Level: ' + expToLevelUp)

        if (enemy1.body.onFloor() == false){
            enemy1.y = height - 85
        }
        

        if (enemy1.flipX){
            eSword.x = enemy1.x + 25
            eSword.y = enemy1.y - 15
        } else {
            eSword.x = enemy1.x - 50
            eSword.y = enemy1.y - 15
        }

        eSword.body.checkCollision.none = true

        enemy1Vitals.x = enemy1.x + 25
        enemy1Vitals.y = enemy1.y - 20
        enemy1Vitals.draw()

        playerPosition = player.x
        
        playerSpeed = playerPosition / (width * 1.2)

            playerVitals.x = playerIcon.x + 30
            playerVitals.y = playerIcon.y - 20
            playerVitals.draw()

            if (inBattle){
                storingBuffIcon.x = playerVitals.x + 145
            } else {
                storingBuffIcon.x = playerVitals.x + 155
            }
            

            storingBuffIcon.y = playerIcon.y
            spendingBuffIcon.x = storingBuffIcon.x + 100
            spendingBuffIcon.y =  playerIcon.y
            growingBuffIcon.x = spendingBuffIcon.x + 95
            growingBuffIcon.y =  playerIcon.y

            storingBuffTierIcon.x = storingBuffIcon.x + 50
            storingBuffTierIcon.y = playerIcon.y
            spendingBuffTierIcon.x = spendingBuffIcon.x + 50
            spendingBuffTierIcon.y = playerIcon.y
            growingBuffTierIcon.x = growingBuffIcon.x + 45
            growingBuffTierIcon.y = playerIcon.y

            kianovaBuffIcon.x = growingBuffIcon.x + 102
            kianovaBuffIcon.y = playerIcon.y + 2

            player.setTint()
        
            if (player.flipX){
                sword.x = player.x - 10
                sword.y = player.y - 15
            } else {
                sword.x = player.x + 10
                sword.y = player.y - 15
            }

            sword.body.checkCollision.none = true
            

            if (player.flipX){
                pSFX.x = player.x + 10
            } else {
                pSFX.x = player.x - 5
            }
        
            pSFX.y = player.y

            spotlight.x = player.x
            spotlight.y = player.y

            chaosFactor = Phaser.Math.FloatBetween(chaosMultiplierMin,chaosMultiplierMax)
            enemy1.body.setSize(enemy1.width, enemy1.height)
            pSFX.setVisible(false)
        
        if (inBattle == false){
            
            camera.stopFollow()


            this.woodsl2.tilePositionX += 1 * (playerSpeed)
            this.woodsl3.tilePositionX += 2 * (playerSpeed)
            this.woodsl4.tilePositionX += 4.5 * (playerSpeed)

            
            this.woodsl4.setAlpha(1) 

            playerIcon.x = camera.scrollX + 30
            playerIcon.y = camera.scrollY + 35


            
        } else if (inBattle) {

            this.woodsl2.tilePositionX = (camera.x * 0.3) * devicePixelRatio
            this.woodsl3.tilePositionX = (camera.x * 0.6) * devicePixelRatio
            this.woodsl4.tilePositionX = (camera.x) * devicePixelRatio

            this.woodsl4.setAlpha(0.85)

            playerIcon.x = camera.scrollX + 45
            playerIcon.y = camera.scrollY + 40

        }

    


        

        if (inBattle == false){

            player.flipX = false

            this.vines.body.checkCollision.none = false

            treeTrunk.body.checkCollision.none = false

            

            if (enemy1.x > width * 1.4 && player.x > width * 1.6){
                        enemy1.setVelocityX(enemy1.body.velocity.x - 15)
            }

            enemy1.anims.play({key:'eRun',frameRate: 14 * playerSpeed},true);

            

            moveVines(this.vines, 4.5 * (playerSpeed))

            moveTreeTrunk(treeTrunk, 4.5 * (playerSpeed))
            
            if (playerIsHit){ 
                player.anims.play({key:'pHurt',frameRate: 12},true); 
                player.on('animationcomplete', function () {
                    playerRecover();
                }, this);

            } else if (cursors.up.isDown && currentEnergy > (income * 0.3) && playerIsHit == false && player.body.onFloor()){ 

                playerVitals.decreaseEnergy(income * 0.3)

                if(Phaser.Input.Keyboard.JustDown(cursors.up)){
                    player.chain([{key:'pJump',frameRate: 12},true,{key:'pUptoFall',frameRate: 12}],true); 
                    this.physics.moveTo(player,width * 1.45,75)
                    player.setVelocityY(player.body.velocity.y - (175 * devicePixelRatio))
                    //enemy1.setVelocity(-15 * devicePixelRatio)
                }

  

                
            } else if (cursors.space.isDown && currentFocus > ((income) / 50) && playerIsHit == false){
                this.vines.body.checkCollision.none = true

                treeTrunk.body.checkCollision.none = true


                playerVitals.decreaseFocus((income) / 50)

                player.anims.play({key:'pDash',frameRate: 12},true);

                if (player.flipX){
                        pSFX.x = player.x + 20
                    } else {
                        pSFX.x = player.x - 15
                    }
                pSFX.y = player.y - 25
                pSFX.setVisible(true)
                pSFX.setTint()
                pSFX.setAlpha(0.85)
                pSFX.setDepth(0)
                pSFX.play('chargeDash',true)
                this.physics.moveTo(player,width * 1.9,player.y,110)
                enemy1.setVelocityX(enemy1.body.velocity.x - 5)
                
                
                
            } else if (cursors.down.isDown && currentEnergy > ((income * 0.25) / 25) && player.body.onFloor()){

                this.vines.body.checkCollision.none = true
 
                playerVitals.decreaseEnergy((income * 0.25) / 25)

                

                player.anims.play({key:'pSlide',frameRate: 6},true);

                this.physics.moveTo(player,width * 1.45,height - 90,30)
            
            } else if (cursors.left.isDown && currentEnergy > ((income * 0.25) / 50 ) && playerIsHit == false && player.body.onFloor()){

                
                
                    playerVitals.decreaseEnergy((income * 0.25) / 50 )
                    playerVitals.decreaseLife(-(income * 0.25)  / 50 )
                
                    
                
                

                
                pSFX.setTint(0xcc0000)
                pSFX.setDepth(2)
                pSFX.setVisible(true)
                pSFX.play('chargeEnergy',true)
                charge.play()
                if (spotlight.intensity < 1.25){
                    spotlight.intensity += 0.01
                }
                camera.shake(50, 0.0005);

            

                this.physics.moveTo(player,width * 1.3,height - 90,90)
                player.anims.play({key:'pRun',frameRate: 8},true);
                
            } else if (cursors.right.isDown && currentEnergy > ((income * 0.25) / 50 ) && playerIsHit == false && player.body.onFloor()){

                
                playerVitals.decreaseEnergy((income * 0.25) / 50)
                this.physics.moveTo(player,width * 1.8,height - 90,90)
                player.anims.play({key:'pRun',frameRate: 16},true);
                

                
                    
                 
            } else if(playerIsHit == false) {

                player.body.checkCollision.none = false
                spotlight.intensity = 0.5

                

               
                if (player.body.onFloor()){
                    this.physics.moveTo(player,width * 1.5,height - 90,150)
                    player.anims.play({key:'pRun',frameRate: 12},true);
                }
                
 

            }

        } else if (inBattle) {
            // In Battle Mode

            if (enemy1Alive == false){
                enemy1.x = 0
                enemy1.y = height - 85
                player.flipX = false
                
                
                e1MaxLife = (income * 0.3) * chaosFactor
                enemy1Life = e1MaxLife
                enemy1Vitals.p = 38 / e1MaxLife
                enemy1Alive = true
                modeSwitch()

            }

            camera.startFollow(player, false, 0.05, 0.05)

            
            if(Math.abs(player.x - enemy1.x) <= 75){
                enemy1Aggro = true
            } else {
                enemy1Aggro = false
            }

           

            if (player.x - enemy1.x > 0){
                enemy1.flipX = true
            } else {
                enemy1.flipX = false
            }
             
            if (enemy1IsHit){
                enemy1.anims.play({key:'eHurt',frameRate: 12},true); 
                enemy1.on('animationcomplete', function () {
                    enemy1Recover();
                }, this);
            } else if (enemy1Alive && enemy1Life > 0 && enemy1IsHit == false) {
            
                if (enemy1Aggro && gameOver == false){
                    enemySwordSwing.play()
                    enemy1.anims.play({key:'eAttack'},true);
                    if (enemy1.anims.currentFrame.index >= 5 && enemy1.anims.currentFrame.index < 8){
                        eSword.body.checkCollision.none = false
                    }
                } else {
                    if(Math.abs(player.x - enemy1.x) > 75 && Math.abs(player.x - enemy1.x) <= 80){    
                    enemy1.anims.play({key:'eIdle',frameRate: 10},true);
                    } else if (gameOver == false){
                        this.physics.moveToObject(enemy1,player,200)
                        enemy1.anims.play({key:'eRun',frameRate: 14},true);
                    } else if (gameOver){
                        enemy1.anims.play({key:'eIdle',frameRate: 10},true);
                    }
                }
                
            } else if (enemy1Life <= 0 && enemy1Alive){
                 
                enemy1.anims.play({key:'eDeath'},true);
   
                if (enemy1.anims.currentFrame.index > 9){
                enemy1Alive = false

                score += ((100/60) * 5)
                
                 
                
                }
                    
            }

     

        //     player.body.setSize(10, 30).setOffset(25,15)

           if(player.body.onFloor()){
            
                if (playerCharging){
                    player.setDragX(0)
                } else {
                    player.setDragX(600)
                }
                

            } else {
                player.setDragX(100)
            }
           
            enemy1.setDragX(600)
            
            
            
            
            if (currentLife <= 0 && gameOver == false){
                player.anims.play({key:'pDeath',frameRate: 12},true); 
                player.on('animationcomplete', function () {
                    finish();
                 }, this);
            } else if (currentLife >= 0 && gameOver == false){

                

                if (player.anims.getName() == 'pAttack'){
                    playerSwordSwing.play()

                    if (player.anims.currentFrame.index >= 6 && player.anims.currentFrame.index < 12){
                        sword.body.checkCollision.none = false
                        damage = (maxEnergy * 0.01)
                    }

                } else if (player.anims.getName() == 'pHeavyAttack'){
                    playerHeavySwordSwing.play()

                    if (player.anims.currentFrame.index >= 4 && player.anims.currentFrame.index < 6){
                    sword.body.checkCollision.none = false
                    damage = (maxEnergy * 0.025)
                    }
                } else if (player.anims.getName() == 'pParry'){
                    playerHeavySwordSwing.play()

                    if (player.anims.currentFrame.index >= 2 && player.anims.currentFrame.index < 4){
                    playerParrying = true
                    sword.body.checkCollision.none = false
                    }
                }

                if (playerIsHit){

                player.anims.play({key:'pHurt',frameRate: 12},true); 
                player.on('animationcomplete', function () {
                playerRecover();
                }, this);

                } 
                
                if(playerIsHit == false){

                    // Offensive Controls

                    if (keyA.isDown && currentEnergy > ((income * 0.25) / 50)){

                        playerAttacking = true

                        playerVitals.decreaseEnergy((income * 0.25) / 50)

                        if (cursors.left.isDown || cursors.right.isDown){

                            player.setDragX(200) 
                            
                            if(chargePower < 100){
                                chargePower += 2
                            }
                            
                                    
                            if (Phaser.Input.Keyboard.JustDown(keyA) && (Phaser.Input.Keyboard.JustDown(cursors.left) ||Phaser.Input.Keyboard.JustDown(cursors.right))){
                            player.play('pChargeAttack',true)
                            
                            }

                        } else if ((cursors.left.isUp || cursors.right.isUp) && keyA.isDown){

                                player.play({key:'pAttack'},true)
                                if (player.body.onFloor()){
                                    if (player.flipX){
                                        player.setVelocityX(-15 *devicePixelRatio)
                                    } else {
                                        player.setVelocityX(15 *devicePixelRatio) 
                                    }
                                }
                                
                                

      

                        }
                            
        
                    } else if (Phaser.Input.Keyboard.JustUp(keyA)  && playerAttacking) {
                        

                        if (chargePower >= 65){

                            
                            player.play({key:'pHeavyAttack',frameRate: 16, repeat: 1},true);
                            if (player.flipX){
                                player.setVelocityX(-500)
                            } else {
                                player.setVelocityX(500)
                            }

                            player.on('animationcomplete', function () {


                                if(player.anims.getName() == 'pHeavyAttack'){
                                    if (player.flipX){
                                    
                                    player.setVelocityX(500)
                                    
                                    } else {
                                    
                                    player.setVelocityX(-500)
                                    
                                    }   
                                }

                            }, this);
                            


                        } else if (chargePower >= 25){

                            
                            player.play({key:'pHeavyAttack',frameRate: 18},true);
                            if (player.flipX){
                                
                                player.setVelocityX(-350)
                            } else {
                                
                                player.setVelocityX(350)
                            }

                            player.on('animationcomplete', function () {


                                if(player.anims.getName() == 'pHeavyAttack'){
                                    if (player.flipX){
                                    player.setVelocityX(150)
                                    } else {
                                        player.setVelocityX(-150)
                                    }   
                                }

                            }, this);

                        } else if (chargePower > 0) {

                            player.play({key:'pHeavyAttack',frameRate: 20})
                            if (player.flipX){
                                player.setVelocityX(-75)
                            } else {
                                player.setVelocityX(75)
                            }
                        }
                        
        

                        player.on('animationcomplete', function () {

                            chargePower = 0
                            playerAttacking = false

                        }, this);

                    }

                  

                    energy.on('pointerup', function(pointer){
                            if (chargePower >= 65){

                                
                            player.play({key:'pHeavyAttack',frameRate: 12, repeat: 1, repeatDelay: 50},true);
                            if (player.flipX){
                                player.setVelocityX(-500)
                            } else {
                                player.setVelocityX(500)
                            }

                            player.on('animationcomplete', function () {


                                if(player.anims.getName() == 'pHeavyAttack'){
                                    if (player.flipX){
                                    player.setVelocityX(500)
                                    } else {
                                        player.setVelocityX(-500)
                                    }   
                                }

                            }, this);



                            } else if (chargePower >= 25){


                            player.play({key:'pHeavyAttack',frameRate: 14},true);
                            if (player.flipX){
                                player.setVelocityX(-350)
                            } else {
                                player.setVelocityX(350)
                            }

                            player.on('animationcomplete', function () {


                                if(player.anims.getName() == 'pHeavyAttack'){
                                    if (player.flipX){
                                    player.setVelocityX(150)
                                    } else {
                                        player.setVelocityX(-150)
                                    }   
                                }

                            }, this);

                            } else if (chargePower > 0) {

                            player.play({key:'pHeavyAttack',frameRate: 18})
                            if (player.flipX){
                                player.setVelocityX(-75)
                            } else {
                                player.setVelocityX(75)
                            }
                            }



                            player.on('animationcomplete', function () {

                            chargePower = 0
                            playerAttacking = false

                            }, this);


                    }, this);

                    // if (cursors.space.isDown){

                    // playerCharging = true

                    // if (cursors.left.isDown || cursors.right.isDown){

                    //     player.setDragX(200) 
                        
                    //     if(chargePower < 100){
                    //         chargePower += 2
                    //     }
                        
                                
                    //     if (Phaser.Input.Keyboard.JustDown(cursors.space) && (Phaser.Input.Keyboard.JustDown(cursors.left) ||Phaser.Input.Keyboard.JustDown(cursors.right))){
                    //     player.play('pChargeSpecial2',true)
                        
                    //     }

                    // } else if ((cursors.left.isUp || cursors.right.isUp) && cursors.space.isDown){

                    //         player.play({key:'pAttack'},true)
                    //         if (player.body.onFloor()){
                    //             if (player.flipX){
                    //         player.setVelocityX(-15 *devicePixelRatio)
                    //         } else {
                    //         player.setVelocityX(15 *devicePixelRatio) 
                    //         }
                    //         }
                            
                            



                    // }
                        

                    // } else {
                    //     playerCharging = false
                    // }

                    if(playerIsHit == false && Phaser.Input.Keyboard.JustDown(cursors.space) && currentFocus > ((income * 0.5) / 50)){
                        
                        playerDodging = true

                        playerVitals.decreaseFocus((income * 0.5) / 50)

                        if (player.flipX){
                                    
                                    player.setVelocityX(400)
                                    
                        } else {
                                    
                                    player.setVelocityX(-400)
                                    
                        } 
                      
                        player.play('pSpecial1')

                        player.on('animationcomplete', function () {

                        
                        playerDodging = false

                        }, this);
                        
                    }

                    
                    if(cursors.space.isDown && playerDodging == false && currentFocus > ((income * 0.25) / 50)){

                        playerCharging = true

                        playerVitals.decreaseFocus((income * 0.25) / 50)
                        
                        player.play('pChargeSpecial1')
                        

                        if(chargePower < 100){
                                chargePower += 2
                        }

                        if (spotlight.intensity < 1.25){
                            spotlight.intensity += 0.02
                        }

                        
                                 
                    } else if (Phaser.Input.Keyboard.JustUp(cursors.space)  && playerCharging) {

                        player.play('pDash')
                        spotlight.intensity = 0.25

                        player.body.maxVelocity.x = 400

                        

                        if (player.flipX){
                                    
                                    player.setVelocityX((-1000 * devicePixelRatio) * (chargePower / 100))
                                    
                        } else {
                                    
                                    player.setVelocityX((1000 * devicePixelRatio) * (chargePower / 100))
                                    
                        } 

                        player.on('animationcomplete', function () {

                        chargePower = 0
                        playerCharging = false
                        player.body.maxVelocity.x = 250
                        
                        

                        }, this);


                    
                    }


                    // Movement & Defense

                    if (cursors.left.isDown || cursors.right.isDown){
                        if (cursors.left.isDown){
                            player.flipX = true
                        } else {
                            player.flipX = false
                        }

                        if (playerAttacking == false && player.body.onFloor()){
                            if (cursors.left.isDown){
                            player.play('pRun',true)
                            player.setVelocityX(player.body.velocity.x - (20 * devicePixelRatio))
                            } else {
                            player.flipX = false
                            player.play('pRun',true)
                            player.setVelocityX(player.body.velocity.x + (20 * devicePixelRatio))
                            }
                        }
                    } else if (Phaser.Input.Keyboard.JustDown(cursors.up) && player.body.onFloor() && currentEnergy > (income * 0.3)){

                        player.play('pJump',true)

                        playerVitals.decreaseEnergy((income * 0.3))
                        player.setVelocityY(player.body.velocity.y - (250 * devicePixelRatio))

                    } else if (playerAttacking == false && cursors.down.isDown && currentEnergy > ((income * 0.075)/50) ){

                        playerVitals.decreaseEnergy((income * 0.075) / 50)
                        player.play('pParry')

                        playerDefending = true

                    } else if (playerAttacking == false && Phaser.Input.Keyboard.JustUp(cursors.down)  && currentEnergy > (income * 0.25) ){

                        
                        player.play('pParry',true)
                        playerVitals.decreaseEnergy((income * 0.25))
                        finishedplayererDefense = false
                        playerDefending = false

                        player.on('animationcomplete', function () {
                            playerParrying = false
                            finishedplayererDefense = true

                        }, this);

                        

                    } else if (player.body.onFloor() && playerAttacking == false && playerDodging == false && playerCharging == false && finishedplayererDefense){
                        player.play('pIdle',true)
                    
                    } else if (playerAttacking == false && player.body.onFloor() == false) {

                    
                        player.play({key:'pUptoFall', repeatDelay: 3000, repeat: 1},true)
                        

                    }
                
            }
                

               



                
                

            
                // } else if (cursors.up.isDown && cursors.space.isDown && currentFocus > 0 && currentEnergy < maxEnergy * 0.99){   
            
                // player.anims.play({key:'pChargeEnergy'},true);
                // pSFX.setVisible(true)
                // pSFX.setDepth(1)
                // pSFX.setTint(0x93c47d)
                // pSFX.play('chargeEnergy',true)
                // charge.play()
                //     if (spotlight.intensity < 1.5){
                //     spotlight.intensity += 0.02
                //     }
                // camera.shake(50, 0.0005);


                // playerVitals.decreaseFocus(maxFocus / 600)
                // playerVitals.decreaseEnergy(-maxFocus / 600)


            
    
                // } else if (cursors.right.isDown){
                    
                //     player.chain([{key:'pHeavyAttack', frameRate: Phaser.Math.Between(15,17)},{key:'pAttack', frameRate: Phaser.Math.Between(18,20)},{key:'pHeavyAttack', frameRate: Phaser.Math.Between(11,13)}]);
                // } else {

                //     player.chain([{key:'pAttack', frameRate: Phaser.Math.Between(21,23)},{key:'pAttack', frameRate: Phaser.Math.Between(15,17)},{key:'pAttack', frameRate: Phaser.Math.Between(12,15)}]);
                // }

            
                // if (player.anims.getName() == 'pAttack'){
                //     playerSwordSwing.play()

                //     if (player.anims.currentFrame.index >= 6 && player.anims.currentFrame.index < 12){
                //         sword.body.checkCollision.none = false
                //     }

                // } else if (player.anims.getName() == 'pHeavyAttack'){
                //     playerHeavySwordSwing.play()

                //     if (player.anims.currentFrame.index >= 4 && player.anims.currentFrame.index < 6){
                //     sword.body.checkCollision.none = false
                //     }
                // }

                

                // } else if (cursors.down.isDown){ 
            

                //     player.play({key:'pSlide',frameRate: 12});
                //     player.setDragX(300)
                        
                // } else if (cursors.left.isDown){

                //     player.flipX = true 

                //     if (playerAttacking == false){
                //         player.setVelocityX(player.body.velocity.x - (20 * devicePixelRatio))
                //         player.play({key:'pRun',frameRate: 10},true);
                //     }
    
                // } else if (cursors.right.isDown){

                //     player.flipX = false 

                //     if (playerAttacking == false){
                //         player.setVelocityX(player.body.velocity.x + (20 * devicePixelRatio))
                //         player.play({key:'pRun',frameRate: 10},true);
                //     }

                // }


            } 

            } 

            

        }

    
            

        
       
    


</script>

</body>
</html>
